
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Enhanced utilities and extensions for fsspec, storage_options and obstore with multi-format I/O support.">
      
      
      
        <link rel="canonical" href="https://legout.github.io/fsspeckit/api/fsspeckit.datasets/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../fsspeckit.sql.filters/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>fsspeckit.datasets - fsspeckit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fsspeckitdatasets" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="fsspeckit" class="md-header__button md-logo" aria-label="fsspeckit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            fsspeckit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              fsspeckit.datasets
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/legout/fsspeckit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    legout/fsspeckit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quickstart/" class="md-tabs__link">
        
  
  
    
  
  Quickstart

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../architecture/" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../advanced/" class="md-tabs__link">
        
  
  
    
  
  Advanced Usage

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../utils/" class="md-tabs__link">
        
  
  
    
  
  Utils Reference

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../examples/" class="md-tabs__link">
        
  
  
    
  
  Examples

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../api-guide/" class="md-tabs__link">
        
  
  
    
  
  API Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="fsspeckit" class="md-nav__button md-logo" aria-label="fsspeckit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    fsspeckit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/legout/fsspeckit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    legout/fsspeckit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Usage
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Utils Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2" checked>
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Domain Packages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Domain Packages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.datasets
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.datasets
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fsspeckit.datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        datasets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler" class="md-nav__link">
    <span class="md-ellipsis">
      
        DuckDBParquetHandler
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DuckDBParquetHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __del__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.__enter__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __enter__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.__exit__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __exit__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.compact_parquet_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        compact_parquet_dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.execute_sql" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute_sql
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.merge_parquet_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        merge_parquet_dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.optimize_parquet_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_parquet_dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.read_parquet" class="md-nav__link">
    <span class="md-ellipsis">
      
        read_parquet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.write_parquet" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_parquet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.DuckDBParquetHandler.write_parquet_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_parquet_dataset
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.cast_schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        cast_schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.collect_dataset_stats_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        collect_dataset_stats_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.compact_parquet_dataset_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        compact_parquet_dataset_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.convert_large_types_to_normal" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_large_types_to_normal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.opt_dtype_pa" class="md-nav__link">
    <span class="md-ellipsis">
      
        opt_dtype_pa
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.optimize_parquet_dataset_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_parquet_dataset_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.unify_schemas_pa" class="md-nav__link">
    <span class="md-ellipsis">
      
        unify_schemas_pa
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets-modules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modules
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.duckdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        duckdb
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="duckdb">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.duckdb-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler" class="md-nav__link">
    <span class="md-ellipsis">
      
        DuckDBParquetHandler
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.duckdb-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        pyarrow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pyarrow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.cast_schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        cast_schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.collect_dataset_stats_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        collect_dataset_stats_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.compact_parquet_dataset_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        compact_parquet_dataset_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.convert_large_types_to_normal" class="md-nav__link">
    <span class="md-ellipsis">
      
        convert_large_types_to_normal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.dominant_timezone_per_column" class="md-nav__link">
    <span class="md-ellipsis">
      
        dominant_timezone_per_column
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.merge_parquet_dataset_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        merge_parquet_dataset_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.opt_dtype" class="md-nav__link">
    <span class="md-ellipsis">
      
        opt_dtype
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.optimize_parquet_dataset_pyarrow" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_parquet_dataset_pyarrow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.remove_empty_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_empty_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.standardize_schema_timezones" class="md-nav__link">
    <span class="md-ellipsis">
      
        standardize_schema_timezones
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.standardize_schema_timezones_by_majority" class="md-nav__link">
    <span class="md-ellipsis">
      
        standardize_schema_timezones_by_majority
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.datasets.pyarrow.unify_schemas" class="md-nav__link">
    <span class="md-ellipsis">
      
        unify_schemas
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.sql.filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.sql.filters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.common
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_3" >
        
          
          <label class="md-nav__link" for="__nav_10_3" id="__nav_10_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.ext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.filesystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.filesystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.maintenance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.maintenance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.merge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.merge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4" >
        
          
          <label class="md-nav__link" for="__nav_10_4" id="__nav_10_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Storage Options
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Storage Options
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.cloud/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.cloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.git/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.git
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_5" >
        
          
          <label class="md-nav__link" for="__nav_10_5" id="__nav_10_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Utils (Backwards Compatibility)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utils (Backwards Compatibility)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.datetime/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.datetime
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.polars/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.polars
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.pyarrow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.pyarrow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.sql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.sql
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="fsspeckitdatasets">fsspeckit.datasets<a class="headerlink" href="#fsspeckitdatasets" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<h2 id="fsspeckit.datasets" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">datasets</span>


<a href="#fsspeckit.datasets" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Dataset-level operations for fsspeckit.</p>
<p>This package contains dataset-specific functionality including:
- DuckDB parquet handlers for high-performance dataset operations
- PyArrow utilities for schema management and type conversion
- Dataset merging and optimization tools</p>










  <div class="doc doc-children">







<h3 id="fsspeckit.datasets-classes">Classes<a href="#fsspeckit.datasets-classes" class="headerlink" title="Permanent link">&para;</a></h3>

<div class="doc doc-object doc-class">



<h4 id="fsspeckit.datasets.DuckDBParquetHandler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">fsspeckit.datasets.DuckDBParquetHandler</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">DuckDBParquetHandler</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n"><span title="fsspeckit.storage_options.base.BaseStorageOptions">BaseStorageOptions</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Handler for parquet operations using DuckDB with fsspec integration.</p>
<p>This class provides methods for reading and writing parquet files and datasets
using DuckDB's high-performance parquet engine. It integrates with fsspec
filesystems to support local and remote storage (S3, GCS, Azure, etc.).</p>
<p>The handler can be initialized with either storage options or an existing
filesystem instance. For remote filesystems, the fsspec filesystem is
registered in DuckDB using <code>.register_filesystem(fs)</code> to enable direct
access to remote paths.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>storage_options</code>
            </td>
            <td>
                  <code><span title="fsspeckit.storage_options.base.BaseStorageOptions">BaseStorageOptions</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Storage configuration options (e.g., AwsStorageOptions).
If provided, a filesystem is created from these options.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An existing fsspec filesystem instance. Takes precedence over
storage_options if both are provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic usage with local filesystem:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuckDBParquetHandler</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create sample data</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Write and read parquet file</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Using with AWS S3:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuckDBParquetHandler</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">options</span> <span class="o">=</span> <span class="n">AwsStorageOptions</span><span class="p">(</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">access_key_id</span><span class="o">=</span><span class="s2">&quot;YOUR_KEY&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>    <span class="n">secret_access_key</span><span class="o">=</span><span class="s2">&quot;YOUR_SECRET&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span>    <span class="n">region</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="gp">... </span>    <span class="c1"># Read from S3</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="gp">... </span>    <span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;s3://bucket/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="gp">...</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="gp">... </span>    <span class="c1"># Execute SQL query on S3 data</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="gp">... </span>        <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;s3://bucket/data.parquet&#39;) WHERE col &gt; 10&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="gp">... </span>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Using with existing filesystem:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit</span><span class="w"> </span><span class="kn">import</span> <span class="n">filesystem</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuckDBParquetHandler</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">filesystem</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>SQL query execution:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">...</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="c1"># Simple query</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>        <span class="s2">&quot;SELECT a, b FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE a &gt; 1&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span>    <span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">...</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">... </span>    <span class="c1"># Parameterized query</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="gp">... </span>        <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE a BETWEEN ? AND ?&quot;</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="gp">... </span>        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="gp">... </span>    <span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="gp">...</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="gp">... </span>    <span class="c1"># Aggregation query</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="gp">... </span><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="gp">... </span><span class="sd">        SELECT b, COUNT(*) as count, AVG(a) as avg_a</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="gp">... </span><span class="sd">        FROM parquet_scan(&#39;/tmp/data.parquet&#39;)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="gp">... </span><span class="sd">        GROUP BY b</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="gp">... </span><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="gp">... </span>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Reading specific columns:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="c1"># Only read columns &#39;a&#39; and &#39;b&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
    <p>Writing with compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data2.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;zstd&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

        <p>Initialize the DuckDB parquet handler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>storage_options</code>
            </td>
            <td>
                  <code><span title="fsspeckit.storage_options.base.BaseStorageOptions">BaseStorageOptions</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Storage configuration options. If provided, a filesystem
is created from these options.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An existing fsspec filesystem instance. Takes precedence over
storage_options if both are provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="s2">&quot;BaseStorageOptions | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the DuckDB parquet handler.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        storage_options: Storage configuration options. If provided, a filesystem</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            is created from these options.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        filesystem: An existing fsspec filesystem instance. Takes precedence over</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">            storage_options if both are provided.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="c1"># Determine which filesystem to use</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">if</span> <span class="n">filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="o">=</span> <span class="n">filesystem</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">elif</span> <span class="n">storage_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="o">=</span> <span class="n">storage_options</span><span class="o">.</span><span class="n">to_filesystem</span><span class="p">()</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># Default to local filesystem</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="o">=</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">








<h5 id="fsspeckit.datasets.DuckDBParquetHandler-functions">Functions<a href="#fsspeckit.datasets.DuckDBParquetHandler-functions" class="headerlink" title="Permanent link">&para;</a></h5>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.__del__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.__del__</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.__del__" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">__del__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cleanup on deletion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1356" name="__codelineno-0-1356"></a><span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleanup on deletion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.__enter__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.__enter__</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.__enter__" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">__enter__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="            fsspeckit.datasets.duckdb.DuckDBParquetHandler" href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler">DuckDBParquetHandler</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Enter context manager.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            fsspeckit.datasets.duckdb.DuckDBParquetHandler" href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler">DuckDBParquetHandler</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for use in with statement.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1026" name="__codelineno-0-1026"></a><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DuckDBParquetHandler&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enter context manager.</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a><span class="sd">        Self for use in with statement.</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.__exit__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.__exit__</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.__exit__" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="n">exc_val</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Exit context manager and close connection.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>exc_type</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception type if an exception occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exc_val</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception value if an exception occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exc_tb</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception traceback if an exception occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1035" name="__codelineno-0-1035"></a><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exit context manager and close connection.</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a><span class="sd">        exc_type: Exception type if an exception occurred.</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a><span class="sd">        exc_val: Exception value if an exception occurred.</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a><span class="sd">        exc_tb: Exception traceback if an exception occurred.</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.close" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.close</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.close" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">close</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Close the DuckDB connection.</p>
<p>This method is called automatically when using the context manager.
Manual calls are only needed when not using the context manager pattern.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1016" name="__codelineno-0-1016"></a><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the DuckDB connection.</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="sd">    This method is called automatically when using the context manager.</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a><span class="sd">    Manual calls are only needed when not using the context manager pattern.</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.compact_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.compact_parquet_dataset</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.compact_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">compact_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compact a parquet dataset directory into fewer larger files using shared planning.</p>
<p>This function delegates compaction planning to the shared core module,
ensuring consistent behavior across DuckDB and PyArrow backends.</p>
<p>Groups small files based on size (MB) and/or row thresholds, rewrites grouped
files into new parquet files, optionally changing compression. Supports
dry-run mode returning planned groups without writing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset directory path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Desired approximate size per output file (MB).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Desired maximum rows per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes to restrict scope.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional compression codec; defaults to existing or 'snappy'.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, plan only without modifying files.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Statistics dict following canonical MaintenanceStats format, including</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>before/after counts and optional plan when dry_run=True.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates dataset discovery and compaction planning to the
shared <code>fsspeckit.core.maintenance</code> module for consistent behavior
with the PyArrow backend.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1083" name="__codelineno-0-1083"></a><span class="k">def</span><span class="w"> </span><span class="nf">compact_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compact a parquet dataset directory into fewer larger files using shared planning.</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a><span class="sd">    This function delegates compaction planning to the shared core module,</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a><span class="sd">    ensuring consistent behavior across DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a><span class="sd">    Groups small files based on size (MB) and/or row thresholds, rewrites grouped</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a><span class="sd">    files into new parquet files, optionally changing compression. Supports</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a><span class="sd">    dry-run mode returning planned groups without writing.</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a><span class="sd">        path: Dataset directory path.</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a><span class="sd">        target_mb_per_file: Desired approximate size per output file (MB).</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a><span class="sd">        target_rows_per_file: Desired maximum rows per output file.</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a><span class="sd">        partition_filter: Optional list of partition prefixes to restrict scope.</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a><span class="sd">        compression: Optional compression codec; defaults to existing or &#39;snappy&#39;.</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a><span class="sd">        dry_run: If True, plan only without modifying files.</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a><span class="sd">        Statistics dict following canonical MaintenanceStats format, including</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a><span class="sd">        before/after counts and optional plan when dry_run=True.</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a><span class="sd">        This function delegates dataset discovery and compaction planning to the</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a><span class="sd">        shared ``fsspeckit.core.maintenance`` module for consistent behavior</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a><span class="sd">        with the PyArrow backend.</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">plan_compaction_groups</span><span class="p">,</span> <span class="n">MaintenanceStats</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Filesystem not initialized for compaction&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>    <span class="n">filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>    <span class="c1"># Get dataset stats using shared logic</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>    <span class="n">stats_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="p">)</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats_before</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>    <span class="c1"># Use shared compaction planning</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>    <span class="n">plan_result</span> <span class="o">=</span> <span class="n">plan_compaction_groups</span><span class="p">(</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>        <span class="n">file_infos</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>    <span class="p">)</span>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>    <span class="c1"># Update planned stats with compression info</span>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a>        <span class="k">return</span> <span class="n">planned_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>    <span class="c1"># Execute compaction using DuckDB</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>    <span class="n">rewritten_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>        <span class="c1"># Read group into Arrow table using DuckDB for efficiency</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>            <span class="n">scan_list</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>                <span class="sa">f</span><span class="s2">&quot;SELECT * FROM parquet_scan([</span><span class="si">{</span><span class="n">scan_list</span><span class="si">}</span><span class="s2">])&quot;</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>            <span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>                <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>            <span class="c1"># Fallback to pyarrow</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>            <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>                <span class="k">with</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a>                    <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a>        <span class="c1"># Write compacted file</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>        <span class="n">out_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_filename</span><span class="p">(</span><span class="s2">&quot;compact-</span><span class="si">{}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>        <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span><span class="p">)</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>        <span class="n">rewritten_bytes</span> <span class="o">+=</span> <span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>        <span class="c1"># Remove original files</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>                <span class="n">filesystem</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: failed to delete &#39;</span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>    <span class="c1"># Recompute stats after compaction</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a>    <span class="p">)</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.execute_sql" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.execute_sql</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.execute_sql" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">query</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute SQL query on parquet data and return results.</p>
<p>Executes a SQL query using DuckDB and returns the results as a PyArrow table.
The query can reference parquet files using the <code>parquet_scan()</code> function.
Supports parameterized queries for safe value substitution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQL query string. Use <code>parquet_scan('path')</code> to reference parquet files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of parameter values for parameterized queries.
Use <code>?</code> placeholders in the query string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table containing the query results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DuckDB encounters a SQL syntax error or query execution error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Simple query:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age &gt; 30&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Parameterized query:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age BETWEEN ? AND ?&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Aggregation query:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span><span class="sd">    SELECT category, COUNT(*) as count, AVG(price) as avg_price</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="sd">    FROM parquet_scan(&#39;/tmp/data.parquet&#39;)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="sd">    GROUP BY category</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="sd">    ORDER BY count DESC</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Join multiple parquet files:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span><span class="sd">    SELECT a.*, b.name</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="sd">    FROM parquet_scan(&#39;/tmp/data1.parquet&#39;) a</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="sd">    JOIN parquet_scan(&#39;/tmp/data2.parquet&#39;) b</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="sd">    ON a.id = b.id</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Window functions:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span><span class="sd">    SELECT</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="sd">        date,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="sd">        revenue,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="sd">        AVG(revenue) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as moving_avg</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="sd">    FROM parquet_scan(&#39;/tmp/sales.parquet&#39;)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-934" name="__codelineno-0-934"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>    <span class="n">parameters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute SQL query on parquet data and return results.</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a><span class="sd">    Executes a SQL query using DuckDB and returns the results as a PyArrow table.</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a><span class="sd">    The query can reference parquet files using the `parquet_scan()` function.</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a><span class="sd">    Supports parameterized queries for safe value substitution.</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a><span class="sd">        query: SQL query string. Use `parquet_scan(&#39;path&#39;)` to reference parquet files.</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a><span class="sd">        parameters: Optional list of parameter values for parameterized queries.</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a><span class="sd">            Use `?` placeholders in the query string.</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a><span class="sd">        PyArrow table containing the query results.</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a><span class="sd">        Exception: If DuckDB encounters a SQL syntax error or query execution error.</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="sd">        Simple query:</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler()</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a><span class="sd">        ...     &quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age &gt; 30&quot;</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a><span class="sd">        Parameterized query:</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a><span class="sd">        ...     &quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age BETWEEN ? AND ?&quot;,</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a><span class="sd">        ...     parameters=[25, 40]</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a><span class="sd">        Aggregation query:</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a><span class="sd">        ...     SELECT category, COUNT(*) as count, AVG(price) as avg_price</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="sd">        ...     FROM parquet_scan(&#39;/tmp/data.parquet&#39;)</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a><span class="sd">        ...     GROUP BY category</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="sd">        ...     ORDER BY count DESC</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a><span class="sd">        Join multiple parquet files:</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a><span class="sd">        ...     SELECT a.*, b.name</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a><span class="sd">        ...     FROM parquet_scan(&#39;/tmp/data1.parquet&#39;) a</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a><span class="sd">        ...     JOIN parquet_scan(&#39;/tmp/data2.parquet&#39;) b</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a><span class="sd">        ...     ON a.id = b.id</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a><span class="sd">        Window functions:</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a><span class="sd">        ...     SELECT</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a><span class="sd">        ...         date,</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a><span class="sd">        ...         revenue,</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a><span class="sd">        ...         AVG(revenue) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as moving_avg</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a><span class="sd">        ...     FROM parquet_scan(&#39;/tmp/sales.parquet&#39;)</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="c1"># Execute parameterized query</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>            <span class="c1"># Execute regular query</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>        <span class="c1"># Convert RecordBatchReader to Table</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to execute SQL query: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.merge_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.merge_parquet_dataset</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.merge_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">source</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span> <span class="o">|</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">key_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n"><span title="fsspeckit.datasets.duckdb.MergeStrategy">MergeStrategy</span></span> <span class="o">=</span> <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">dedup_order_by</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">progress_callback</span><span class="p">:</span> <span class="n"><span title="typing.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Merge source data into target parquet dataset using specified strategy.</p>
<p>Performs intelligent merge operations on parquet datasets with support for
UPSERT, INSERT-only, UPDATE-only, FULL_MERGE (sync), and DEDUPLICATE strategies.
Uses DuckDB's SQL engine for efficient merging with QUALIFY for deduplication.</p>
<p>This implementation uses shared merge validation and semantics from fsspeckit.core.merge
to ensure consistent behavior across all backends. All merge strategies share the same
semantics, validation rules, and statistical calculations as the PyArrow implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span> | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source data as PyArrow table or path to parquet dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to target parquet dataset directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to use for matching records. Can be single column
name (string) or list of column names for composite keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy</code>
            </td>
            <td>
                  <code><span title="fsspeckit.datasets.duckdb.MergeStrategy">MergeStrategy</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Merge strategy to use:
- "upsert": Insert new records, update existing (default)
- "insert": Insert only new records, ignore existing
- "update": Update only existing records, ignore new
- "full_merge": Insert, update, and delete (full sync with source)
- "deduplicate": Remove duplicates from source, then upsert</p>
              </div>
            </td>
            <td>
                  <code>&#39;upsert&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dedup_order_by</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to use for ordering when deduplicating (for
"deduplicate" strategy). Keeps record with highest value. If None,
uses first occurrence.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec for output. Default is "snappy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;snappy&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>, <span title="int">int</span>, <span title="int">int</span>], None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callback function for progress tracking.
Called with (stage, current, total) where stage is a string description.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with merge statistics:
- "inserted": Number of records inserted
- "updated": Number of records updated
- "deleted": Number of records deleted
- "total": Total records in merged dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If strategy invalid, key columns missing, or NULL keys present.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If source/target schemas incompatible.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If merge operation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>UPSERT - insert new and update existing:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>        <span class="n">source</span><span class="o">=</span><span class="n">new_data_table</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>        <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/customers/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>        <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>        <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;upsert&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span>    <span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inserted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Updated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>INSERT - add only new records:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;/staging/new_orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;order_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inserted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> new orders&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>UPDATE - update existing only:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">product_updates</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/products/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;update&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>FULL_MERGE - complete synchronization:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">authoritative_data</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/inventory/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;item_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;full_merge&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synced: +</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inserted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>DEDUPLICATE - remove duplicates first:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">raw_data_with_dups</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/transactions/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;deduplicate&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>    <span class="n">dedup_order_by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>  <span class="c1"># Keep latest</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Composite key:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/sales/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span> <span class="s2">&quot;order_date&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;upsert&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


<details class="note" open>
  <summary>Note</summary>
  <p>This implementation uses shared merge validation and semantics from fsspeckit.core.merge
to ensure consistent behavior across all backends. Atomic operations are performed using
temporary directories with backup-and-restore for error recovery.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="n">key_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n">MergeStrategy</span> <span class="o">=</span> <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="n">dedup_order_by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge source data into target parquet dataset using specified strategy.</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">    Performs intelligent merge operations on parquet datasets with support for</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">    UPSERT, INSERT-only, UPDATE-only, FULL_MERGE (sync), and DEDUPLICATE strategies.</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">    Uses DuckDB&#39;s SQL engine for efficient merging with QUALIFY for deduplication.</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">    This implementation uses shared merge validation and semantics from fsspeckit.core.merge</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">    to ensure consistent behavior across all backends. All merge strategies share the same</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">    semantics, validation rules, and statistical calculations as the PyArrow implementation.</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">        source: Source data as PyArrow table or path to parquet dataset.</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">        target_path: Path to target parquet dataset directory.</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">        key_columns: Column(s) to use for matching records. Can be single column</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">            name (string) or list of column names for composite keys.</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        strategy: Merge strategy to use:</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">            - &quot;upsert&quot;: Insert new records, update existing (default)</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">            - &quot;insert&quot;: Insert only new records, ignore existing</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">            - &quot;update&quot;: Update only existing records, ignore new</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">            - &quot;full_merge&quot;: Insert, update, and delete (full sync with source)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">            - &quot;deduplicate&quot;: Remove duplicates from source, then upsert</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">        dedup_order_by: Columns to use for ordering when deduplicating (for</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">            &quot;deduplicate&quot; strategy). Keeps record with highest value. If None,</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="sd">            uses first occurrence.</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">        compression: Compression codec for output. Default is &quot;snappy&quot;.</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">        progress_callback: Optional callback function for progress tracking.</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">            Called with (stage, current, total) where stage is a string description.</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="sd">        Dictionary with merge statistics:</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="sd">            - &quot;inserted&quot;: Number of records inserted</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="sd">            - &quot;updated&quot;: Number of records updated</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="sd">            - &quot;deleted&quot;: Number of records deleted</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">            - &quot;total&quot;: Total records in merged dataset</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">        ValueError: If strategy invalid, key columns missing, or NULL keys present.</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">        TypeError: If source/target schemas incompatible.</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a><span class="sd">        Exception: If merge operation fails.</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="sd">        UPSERT - insert new and update existing:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><span class="sd">        &gt;&gt;&gt; with DuckDBParquetHandler() as handler:</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="sd">        ...     stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="sd">        ...         source=new_data_table,</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="sd">        ...         target_path=&quot;/data/customers/&quot;,</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="sd">        ...         key_columns=[&quot;customer_id&quot;],</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">        ...         strategy=&quot;upsert&quot;</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">        ...     )</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">        ...     print(f&quot;Inserted: {stats[&#39;inserted&#39;]}, Updated: {stats[&#39;updated&#39;]}&quot;)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="sd">        INSERT - add only new records:</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">        ...     source=&quot;/staging/new_orders/&quot;,</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">        ...     target_path=&quot;/data/orders/&quot;,</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="sd">        ...     key_columns=[&quot;order_id&quot;],</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">        ...     strategy=&quot;insert&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">        ... print(f&quot;Added {stats[&#39;inserted&#39;]} new orders&quot;)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">        UPDATE - update existing only:</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">        ...     source=product_updates,</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">        ...     target_path=&quot;/data/products/&quot;,</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">        ...     key_columns=[&quot;product_id&quot;],</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        ...     strategy=&quot;update&quot;</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><span class="sd">        FULL_MERGE - complete synchronization:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">        ...     source=authoritative_data,</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="sd">        ...     target_path=&quot;/data/inventory/&quot;,</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">        ...     key_columns=[&quot;item_id&quot;],</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">        ...     strategy=&quot;full_merge&quot;</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        ... print(f&quot;Synced: +{stats[&#39;inserted&#39;]} -{stats[&#39;deleted&#39;]}&quot;)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">        DEDUPLICATE - remove duplicates first:</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">        ...     source=raw_data_with_dups,</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">        ...     target_path=&quot;/data/transactions/&quot;,</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        ...     key_columns=[&quot;transaction_id&quot;],</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">        ...     strategy=&quot;deduplicate&quot;,</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        ...     dedup_order_by=[&quot;timestamp&quot;]  # Keep latest</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">        Composite key:</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">        ...     source=updates,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">        ...     target_path=&quot;/data/sales/&quot;,</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="sd">        ...     key_columns=[&quot;customer_id&quot;, &quot;order_date&quot;],</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">        ...     strategy=&quot;upsert&quot;</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">        This implementation uses shared merge validation and semantics from fsspeckit.core.merge</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">        to ensure consistent behavior across all backends. Atomic operations are performed using</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">        temporary directories with backup-and-restore for error recovery.</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>    <span class="c1"># Convert string strategy to core enum and validate</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="n">core_strategy</span> <span class="o">=</span> <span class="n">CoreMergeStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="n">valid_strategies</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">CoreMergeStrategy</span><span class="p">}</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid strategy: &#39;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&#39;. Must be one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">valid_strategies</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="c1"># Normalize key_columns using shared helper</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="n">normalized_keys</span> <span class="o">=</span> <span class="n">normalize_key_columns</span><span class="p">(</span><span class="n">key_columns</span><span class="p">)</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="c1"># Report progress start</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Loading source data&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="c1"># Load source data</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>        <span class="c1"># Source is path to parquet dataset</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>        <span class="n">source_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="c1"># Source is PyArrow table</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="n">source_table</span> <span class="o">=</span> <span class="n">source</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>    <span class="c1"># Report progress for source loading</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Loading target data&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>    <span class="c1"># Load target data (create empty if doesn&#39;t exist)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>    <span class="n">target_schema</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>    <span class="n">target_table</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="n">target_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>        <span class="n">target_schema</span> <span class="o">=</span> <span class="n">target_table</span><span class="o">.</span><span class="n">schema</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>    <span class="c1"># Report progress for validation</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Validating inputs&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>    <span class="c1"># Validate inputs using shared helpers</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>    <span class="n">merge_plan</span> <span class="o">=</span> <span class="n">validate_merge_inputs</span><span class="p">(</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>        <span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">target_schema</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">,</span> <span class="n">core_strategy</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>    <span class="p">)</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>    <span class="n">merge_plan</span><span class="o">.</span><span class="n">source_count</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>    <span class="c1"># Validate strategy compatibility</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>    <span class="n">validate_strategy_compatibility</span><span class="p">(</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>        <span class="n">core_strategy</span><span class="p">,</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>    <span class="p">)</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>    <span class="c1"># Check for NULL keys using shared helper</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>    <span class="n">check_null_keys</span><span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">target_table</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>    <span class="c1"># Calculate pre-merge counts for statistics</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>    <span class="n">target_count_before</span> <span class="o">=</span> <span class="n">target_table</span><span class="o">.</span><span class="n">num_rows</span> <span class="k">if</span> <span class="n">target_table</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="c1"># Create empty target table if needed</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>    <span class="k">if</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>        <span class="n">target_table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>            <span class="p">{</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>                <span class="n">col</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="nb">type</span><span class="o">=</span><span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>            <span class="p">}</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>    <span class="c1"># Register tables in DuckDB</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;source_data&quot;</span><span class="p">,</span> <span class="n">source_table</span><span class="p">)</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;target_dataset&quot;</span><span class="p">,</span> <span class="n">target_table</span><span class="p">)</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>    <span class="c1"># Report progress for merge execution</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Executing merge strategy&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>    <span class="c1"># Configure DuckDB for optimal merge performance</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET memory_limit=&#39;1GB&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET threads=4&quot;</span><span class="p">)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>    <span class="c1"># Enable DuckDB&#39;s parallel processing for large datasets</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>    <span class="k">if</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET enable_progress_bar=true&quot;</span><span class="p">)</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET preserve_insertion_order=false&quot;</span><span class="p">)</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="c1"># Execute merge based on strategy</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>    <span class="n">merged_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_merge_strategy</span><span class="p">(</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>        <span class="n">conn</span><span class="p">,</span> <span class="n">core_strategy</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">,</span> <span class="n">dedup_order_by</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>    <span class="p">)</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>    <span class="c1"># Calculate statistics using shared helper</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>    <span class="n">merge_stats</span> <span class="o">=</span> <span class="n">calculate_merge_stats</span><span class="p">(</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="n">core_strategy</span><span class="p">,</span> <span class="n">source_count</span><span class="p">,</span> <span class="n">target_count_before</span><span class="p">,</span> <span class="n">merged_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>    <span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">merge_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>    <span class="c1"># Report progress for writing results</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Writing merged results&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>    <span class="c1"># Write merged result to temporary directory first, then move for atomicity</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;merge_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="n">temp_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;merged_dataset&quot;</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="n">temp_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>        <span class="c1"># Write merged result to temporary location</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="n">merged_table</span><span class="p">,</span> <span class="n">temp_path_str</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>        <span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="c1"># Atomic move: if target exists, remove it first, then move temp data</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>            <span class="c1"># Make a backup in case something goes wrong</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>            <span class="n">backup_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">.backup.</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>                <span class="c1"># Rename existing target to backup</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>                <span class="c1"># Move temp data to final location</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">temp_path_str</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>                <span class="c1"># Remove backup after successful move</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>                <span class="c1"># Try to restore backup if move failed</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atomic merge failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>            <span class="c1"># No existing target, just move temp data</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">temp_path_str</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>    <span class="c1"># Cleanup</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;source_data&quot;</span><span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;target_dataset&quot;</span><span class="p">)</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;merged_result&quot;</span><span class="p">)</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>        <span class="k">pass</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.optimize_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.optimize_parquet_dataset</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.optimize_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">optimize_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Optimize a parquet dataset by clustering (approximate z-order) using shared planning.</p>
<p>This function delegates optimization planning to the shared core module,
ensuring consistent behavior across DuckDB and PyArrow backends.</p>
<p>Reads dataset, orders rows by given columns, optionally groups into sized chunks
similar to compaction, rewrites dataset (overwrite semantics). Supports dry-run.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset directory path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zorder_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to cluster by (must exist).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional desired size per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional desired row cap per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional compression codec for output files.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, plan only.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Statistics dict following canonical MaintenanceStats format; may include</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>planned grouping if dry-run=True.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates optimization planning and validation to the
shared <code>fsspeckit.core.maintenance.plan_optimize_groups</code> function,
ensuring consistent behavior with the PyArrow backend.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1200" name="__codelineno-0-1200"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize a parquet dataset by clustering (approximate z-order) using shared planning.</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a><span class="sd">    This function delegates optimization planning to the shared core module,</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a><span class="sd">    ensuring consistent behavior across DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a><span class="sd">    Reads dataset, orders rows by given columns, optionally groups into sized chunks</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a><span class="sd">    similar to compaction, rewrites dataset (overwrite semantics). Supports dry-run.</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a><span class="sd">        path: Dataset directory path.</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a><span class="sd">        zorder_columns: Columns to cluster by (must exist).</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a><span class="sd">        target_mb_per_file: Optional desired size per output file.</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a><span class="sd">        target_rows_per_file: Optional desired row cap per output file.</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a><span class="sd">        partition_filter: Optional list of partition prefixes.</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a><span class="sd">        compression: Optional compression codec for output files.</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a><span class="sd">        dry_run: If True, plan only.</span>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a><span class="sd">        Statistics dict following canonical MaintenanceStats format; may include</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a><span class="sd">        planned grouping if dry-run=True.</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a><span class="sd">        This function delegates optimization planning and validation to the</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a><span class="sd">        shared ``fsspeckit.core.maintenance.plan_optimize_groups`` function,</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a><span class="sd">        ensuring consistent behavior with the PyArrow backend.</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">plan_optimize_groups</span><span class="p">,</span> <span class="n">MaintenanceStats</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">zorder_columns</span><span class="p">:</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zorder_columns must be a non-empty list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Filesystem not initialized for optimization&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>    <span class="n">filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>    <span class="c1"># Get dataset stats using shared logic</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>    <span class="n">stats_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="p">)</span>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats_before</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>    <span class="c1"># Load a sample table to inspect schema for z-order validation</span>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>    <span class="n">sample_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>  <span class="c1"># first file</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>    <span class="c1"># Use shared optimization planning with schema validation</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>    <span class="n">plan_result</span> <span class="o">=</span> <span class="n">plan_optimize_groups</span><span class="p">(</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>        <span class="n">file_infos</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>        <span class="n">sample_schema</span><span class="o">=</span><span class="n">sample_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>    <span class="p">)</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>    <span class="c1"># Update planned stats with compression info</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>        <span class="k">return</span> <span class="n">planned_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>    <span class="c1"># Execute optimization using DuckDB</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>    <span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>    <span class="n">rewritten_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_quote_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>        <span class="n">escaped</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">escaped</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>    <span class="c1"># Helper function to build ORDER BY clause with NULL handling</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_order_clause</span><span class="p">(</span><span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>        <span class="n">order_parts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>            <span class="n">quoted</span> <span class="o">=</span> <span class="n">_quote_identifier</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>            <span class="c1"># Put NULLs last</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>            <span class="n">order_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">quoted</span><span class="si">}</span><span class="s2"> IS NULL) ASC&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>            <span class="n">order_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quoted</span><span class="si">}</span><span class="s2"> ASC&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_parts</span><span class="p">)</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>    <span class="n">order_clause</span> <span class="o">=</span> <span class="n">_build_order_clause</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">)</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a>    <span class="c1"># Process each group separately for more memory-efficient operation</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>    <span class="n">written_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>    <span class="k">for</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a>        <span class="c1"># Read group files and sort by z-order columns</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a>        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>        <span class="n">all_paths_sql</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM parquet_scan([</span><span class="si">{</span><span class="n">all_paths_sql</span><span class="si">}</span><span class="s2">]) ORDER BY </span><span class="si">{</span><span class="n">order_clause</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>        <span class="n">ordered_table</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ordered_table</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>            <span class="n">ordered_table</span> <span class="o">=</span> <span class="n">ordered_table</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>        <span class="c1"># Apply chunking within the group if needed</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>        <span class="k">if</span> <span class="n">target_rows_per_file</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>            <span class="c1"># Row-based splitting</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>            <span class="n">num_rows</span> <span class="o">=</span> <span class="n">ordered_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a>            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">target_rows_per_file</span><span class="p">):</span>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a>                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">target_rows_per_file</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">)</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>                <span class="n">chunk</span> <span class="o">=</span> <span class="n">ordered_table</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a>                <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a>                    <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a>            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ordered_table</span><span class="p">]</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>        <span class="c1"># Write optimized chunks</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>        <span class="k">for</span> <span class="n">chunk_idx</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>                <span class="c1"># Single group case - use simple naming</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;optimized-</span><span class="si">{</span><span class="n">chunk_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>                <span class="c1"># Multiple groups - include group index</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;optimized-</span><span class="si">{</span><span class="n">group_idx</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">chunk_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>            <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression_codec</span><span class="p">)</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>            <span class="n">written_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>        <span class="n">rewritten_bytes</span> <span class="o">+=</span> <span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>        <span class="c1"># Remove original files in this group</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>                <span class="n">filesystem</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>    <span class="c1"># Recompute stats after optimization</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span><span class="p">)</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">compression_codec</span><span class="p">,</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>    <span class="p">)</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.read_parquet" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.read_parquet</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.read_parquet" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">read_parquet</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Read parquet file or dataset directory.</p>
<p>Reads a single parquet file or all parquet files in a directory and
returns the data as a PyArrow table. Supports column projection for
efficient reading of large datasets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to parquet file or directory containing parquet files.
Can be local path or remote URI (s3://, gs://, etc.).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of column names to read. If None, reads all columns.
Specifying columns improves performance for large datasets.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table containing the parquet data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified path does not exist.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DuckDB encounters an error reading the parquet file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Read entire parquet file:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Read with column selection:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/data.parquet&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
    <p>Read parquet dataset directory:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/dataset/&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Read from S3:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">AwsStorageOptions</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;s3://bucket/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_parquet</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read parquet file or dataset directory.</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">    Reads a single parquet file or all parquet files in a directory and</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    returns the data as a PyArrow table. Supports column projection for</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">    efficient reading of large datasets.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">        path: Path to parquet file or directory containing parquet files.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">            Can be local path or remote URI (s3://, gs://, etc.).</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">        columns: Optional list of column names to read. If None, reads all columns.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">            Specifying columns improves performance for large datasets.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        PyArrow table containing the parquet data.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        FileNotFoundError: If the specified path does not exist.</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        Exception: If DuckDB encounters an error reading the parquet file.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        Read entire parquet file:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;/path/to/data.parquet&quot;)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        Read with column selection:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;/path/to/data.parquet&quot;, columns=[&quot;col1&quot;, &quot;col2&quot;])</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        Read parquet dataset directory:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;/path/to/dataset/&quot;)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        Read from S3:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        &gt;&gt;&gt; from fsspeckit.storage_options import AwsStorageOptions</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler(storage_options=AwsStorageOptions(...))</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;s3://bucket/data.parquet&quot;)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="c1"># Check if path exists before executing DuckDB query</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parquet path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="c1"># Build column selection clause</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">columns_clause</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="c1"># Build query to read parquet</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">columns_clause</span><span class="si">}</span><span class="s2"> FROM parquet_scan(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="c1"># Execute query and return as PyArrow table</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="c1"># Convert RecordBatchReader to Table</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="c1"># Preserve original error type and message when possible</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="s2">&quot;does not exist&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="ow">or</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="p">):</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="sa">f</span><span class="s2">&quot;Parquet path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="c1"># Re-raise with original exception type preserved</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to read parquet from &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.write_parquet" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.write_parquet</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.write_parquet" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_parquet</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write PyArrow table to parquet file.</p>
<p>Writes a PyArrow table to a parquet file with configurable compression.
Automatically creates parent directories if they don't exist.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table to write.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output path for parquet file. Can be local path or remote URI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec to use. Supported values: "snappy", "gzip",
"lz4", "zstd", "brotli", "uncompressed". Default is "snappy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;snappy&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DuckDB encounters an error writing the parquet file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Write with default compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/output.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Write with gzip compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/output.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Write to nested directory:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/2024/01/15/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Write to S3:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">AwsStorageOptions</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;s3://bucket/output.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_parquet</span><span class="p">(</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write PyArrow table to parquet file.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    Writes a PyArrow table to a parquet file with configurable compression.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    Automatically creates parent directories if they don&#39;t exist.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        table: PyArrow table to write.</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        path: Output path for parquet file. Can be local path or remote URI.</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        compression: Compression codec to use. Supported values: &quot;snappy&quot;, &quot;gzip&quot;,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">            &quot;lz4&quot;, &quot;zstd&quot;, &quot;brotli&quot;, &quot;uncompressed&quot;. Default is &quot;snappy&quot;.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        Exception: If DuckDB encounters an error writing the parquet file.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        Write with default compression:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        &gt;&gt;&gt; import pyarrow as pa</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        &gt;&gt;&gt; table = pa.table({&#39;a&#39;: [1, 2, 3], &#39;b&#39;: [&#39;x&#39;, &#39;y&#39;, &#39;z&#39;]})</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler()</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;/tmp/output.parquet&quot;)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        Write with gzip compression:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;/tmp/output.parquet&quot;, compression=&quot;gzip&quot;)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        Write to nested directory:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;/tmp/2024/01/15/data.parquet&quot;)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        Write to S3:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        &gt;&gt;&gt; from fsspeckit.storage_options import AwsStorageOptions</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler(storage_options=AwsStorageOptions(...))</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;s3://bucket/output.parquet&quot;)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="c1"># Ensure parent directory exists and is not a file</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="n">parent_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="c1"># Check if parent path exists and is a file (not directory)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">parent_path</span><span class="p">):</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">parent_path</span><span class="p">):</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                    <span class="sa">f</span><span class="s2">&quot;Parent directory &#39;</span><span class="si">{</span><span class="n">parent_path</span><span class="si">}</span><span class="s2">&#39; exists but is a file. Cannot create file &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">parent_path</span><span class="p">):</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">parent_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="c1"># Some filesystems may not support exists/makedirs on remote paths</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="c1"># DuckDB will handle the path directly</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="k">pass</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="c1"># Register the table in DuckDB</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="c1"># Use COPY command to write parquet</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COPY temp_table TO &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; (FORMAT PARQUET, COMPRESSION &#39;</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="c1"># Unregister the temporary table</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="c1"># Clean up on error</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="k">pass</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write parquet to &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.DuckDBParquetHandler.write_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.DuckDBParquetHandler.write_parquet_dataset</span>


<a href="#fsspeckit.datasets.DuckDBParquetHandler.write_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">mode</span><span class="p">:</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">max_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">basename_template</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;part-</span><span class="si">{}</span><span class="s2">.parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write PyArrow table to parquet dataset directory with unique filenames.</p>
<p>Writes a PyArrow table to a directory as one or more parquet files with
automatically generated unique filenames. Supports overwrite and append modes
for managing existing datasets, and can split large tables across multiple files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table to write.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output directory path for the dataset. Can be local or remote URI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;overwrite&#39;, &#39;append&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Write mode. "append" (default) adds files without deleting existing ones.
"overwrite" deletes existing parquet files before writing.</p>
              </div>
            </td>
            <td>
                  <code>&#39;append&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional maximum rows per file. If specified and table
has more rows, splits into multiple files. If None, writes single file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec. Supported: "snappy", "gzip", "lz4", "zstd",
"brotli", "uncompressed". Default is "snappy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;snappy&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basename_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template for filenames with {} placeholder for unique ID.
Default is "part-{}.parquet". The {} will be replaced with a short UUID.</p>
              </div>
            </td>
            <td>
                  <code>&#39;part-{}.parquet&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If mode is invalid or max_rows_per_file &lt;= 0.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filesystem operations or writing fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic dataset write with unique filename:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/dataset/&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="c1"># Creates: /tmp/dataset/part-a1b2c3d4.parquet</span>
</code></pre></div></td></tr></table></div>
    <p>Append mode (incremental updates):</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># First write</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table1</span><span class="p">,</span> <span class="s2">&quot;/data/sales/&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Second write (adds new file)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table2</span><span class="p">,</span> <span class="s2">&quot;/data/sales/&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Read combined dataset</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/data/sales/&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Overwrite mode (replace dataset):</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">new_table</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span>  <span class="c1"># Deletes existing parquet files</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Split large table across multiple files:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">large_table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">large_table</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">max_rows_per_file</span><span class="o">=</span><span class="mi">2500</span>  <span class="c1"># Creates 4 files</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Custom filename template:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">table</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">basename_template</span><span class="o">=</span><span class="s2">&quot;data_</span><span class="si">{}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="c1"># Creates: data_a1b2c3d4.parquet</span>
</code></pre></div></td></tr></table></div>
    <p>With compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">table</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Remote storage (S3):</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">AwsStorageOptions</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;s3://bucket/dataset/&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">max_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">basename_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;part-</span><span class="si">{}</span><span class="s2">.parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write PyArrow table to parquet dataset directory with unique filenames.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    Writes a PyArrow table to a directory as one or more parquet files with</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">    automatically generated unique filenames. Supports overwrite and append modes</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">    for managing existing datasets, and can split large tables across multiple files.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">        table: PyArrow table to write.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">        path: Output directory path for the dataset. Can be local or remote URI.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">        mode: Write mode. &quot;append&quot; (default) adds files without deleting existing ones.</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">            &quot;overwrite&quot; deletes existing parquet files before writing.</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">        max_rows_per_file: Optional maximum rows per file. If specified and table</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">            has more rows, splits into multiple files. If None, writes single file.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        compression: Compression codec. Supported: &quot;snappy&quot;, &quot;gzip&quot;, &quot;lz4&quot;, &quot;zstd&quot;,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">            &quot;brotli&quot;, &quot;uncompressed&quot;. Default is &quot;snappy&quot;.</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        basename_template: Template for filenames with {} placeholder for unique ID.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">            Default is &quot;part-{}.parquet&quot;. The {} will be replaced with a short UUID.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        ValueError: If mode is invalid or max_rows_per_file &lt;= 0.</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        Exception: If filesystem operations or writing fails.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        Basic dataset write with unique filename:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        &gt;&gt;&gt; import pyarrow as pa</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        &gt;&gt;&gt; table = pa.table({&#39;a&#39;: [1, 2, 3], &#39;b&#39;: [&#39;x&#39;, &#39;y&#39;, &#39;z&#39;]})</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">        &gt;&gt;&gt; with DuckDBParquetHandler() as handler:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        ...     handler.write_parquet_dataset(table, &quot;/tmp/dataset/&quot;)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        ...     # Creates: /tmp/dataset/part-a1b2c3d4.parquet</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">        Append mode (incremental updates):</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">        &gt;&gt;&gt; # First write</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(table1, &quot;/data/sales/&quot;, mode=&quot;append&quot;)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        &gt;&gt;&gt; # Second write (adds new file)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(table2, &quot;/data/sales/&quot;, mode=&quot;append&quot;)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        &gt;&gt;&gt; # Read combined dataset</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">        &gt;&gt;&gt; result = handler.read_parquet(&quot;/data/sales/&quot;)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        Overwrite mode (replace dataset):</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        ...     new_table,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        ...     mode=&quot;overwrite&quot;  # Deletes existing parquet files</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">        Split large table across multiple files:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        &gt;&gt;&gt; large_table = pa.table({&#39;id&#39;: range(10000), &#39;value&#39;: range(10000)})</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        ...     large_table,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        ...     max_rows_per_file=2500  # Creates 4 files</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        Custom filename template:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">        ...     table,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">        ...     basename_template=&quot;data_{}.parquet&quot;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">        ... # Creates: data_a1b2c3d4.parquet</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        With compression:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">        ...     table,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        ...     compression=&quot;gzip&quot;</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        Remote storage (S3):</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">        &gt;&gt;&gt; from fsspeckit.storage_options import AwsStorageOptions</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler(storage_options=AwsStorageOptions(...))</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(table, &quot;s3://bucket/dataset/&quot;)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>    <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">):</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid mode: &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;overwrite&#39; or &#39;append&#39;.&quot;</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="k">if</span> <span class="n">max_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_rows_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_rows_per_file must be &gt; 0, got </span><span class="si">{</span><span class="n">max_rows_per_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="c1"># Ensure directory exists</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="c1"># Check if path exists and is a file (not directory)</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                    <span class="sa">f</span><span class="s2">&quot;Dataset path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; exists but is a file. Dataset paths must be directories.&quot;</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                <span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to create dataset directory &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="c1"># Handle overwrite mode - clear existing parquet files</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="c1"># Determine how many files to write</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="k">if</span> <span class="n">max_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="n">max_rows_per_file</span><span class="p">:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="c1"># Split table into multiple files</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="n">num_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">+</span> <span class="n">max_rows_per_file</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_rows_per_file</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_files</span><span class="p">):</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">max_rows_per_file</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_rows_per_file</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">slice_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="c1"># Generate unique filename</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_filename</span><span class="p">(</span><span class="n">basename_template</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="c1"># Write slice to file</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">,</span> <span class="n">slice_table</span><span class="p">)</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COPY temp_table TO &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; (FORMAT PARQUET, COMPRESSION &#39;</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                    <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to write parquet file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="c1"># Write single file</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_filename</span><span class="p">(</span><span class="n">basename_template</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COPY temp_table TO &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; (FORMAT PARQUET, COMPRESSION &#39;</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                <span class="k">pass</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to write parquet file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h3 id="fsspeckit.datasets-functions">Functions<a href="#fsspeckit.datasets-functions" class="headerlink" title="Permanent link">&para;</a></h3>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.cast_schema" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.cast_schema</span>


<a href="#fsspeckit.datasets.cast_schema" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">cast_schema</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cast a PyArrow table to a given schema, updating the schema to match the table's columns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow table to cast.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The target schema to cast the table to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Table: A new PyArrow table with the specified schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1550" name="__codelineno-0-1550"></a><span class="k">def</span><span class="w"> </span><span class="nf">cast_schema</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a><span class="sd">    Cast a PyArrow table to a given schema, updating the schema to match the table&#39;s columns.</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a><span class="sd">        table (pa.Table): The PyArrow table to cast.</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a><span class="sd">        schema (pa.Schema): The target schema to cast the table to.</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a><span class="sd">        pa.Table: A new PyArrow table with the specified schema.</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>    <span class="n">table_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">:</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>                <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">nulls</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>            <span class="p">)</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.collect_dataset_stats_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.collect_dataset_stats_pyarrow</span>


<a href="#fsspeckit.datasets.collect_dataset_stats_pyarrow" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Collect file-level statistics for a parquet dataset using shared core logic.</p>
<p>This function delegates to the shared <code>fsspeckit.core.maintenance.collect_dataset_stats</code>
function, ensuring consistent dataset discovery and statistics across both DuckDB
and PyArrow backends.</p>
<p>The helper walks the given dataset directory on the provided filesystem,
discovers parquet files (recursively), and returns basic statistics:</p>
<ul>
<li>Per-file path, size in bytes, and number of rows</li>
<li>Aggregated total bytes and total rows</li>
</ul>
<p>The function is intentionally streaming/metadata-driven and never
materializes the full dataset as a single :class:<code>pyarrow.Table</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Root directory of the parquet dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional fsspec filesystem. If omitted, a local "file"
filesystem is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefix filters
(e.g. ["date=2025-11-04"]). Only files whose path relative to
<code>path</code> starts with one of these prefixes are included.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with keys:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>files</code>: list of <code>{"path", "size_bytes", "num_rows"}</code> dicts</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>total_bytes</code>: sum of file sizes</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>total_rows</code>: sum of row counts</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist or no parquet files
match the optional partition filter.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This is a thin wrapper around the shared core function. See
:func:<code>fsspeckit.core.maintenance.collect_dataset_stats</code> for the
authoritative implementation.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect file-level statistics for a parquet dataset using shared core logic.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    This function delegates to the shared ``fsspeckit.core.maintenance.collect_dataset_stats``</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    function, ensuring consistent dataset discovery and statistics across both DuckDB</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    and PyArrow backends.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    The helper walks the given dataset directory on the provided filesystem,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    discovers parquet files (recursively), and returns basic statistics:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    - Per-file path, size in bytes, and number of rows</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    - Aggregated total bytes and total rows</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    The function is intentionally streaming/metadata-driven and never</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    materializes the full dataset as a single :class:`pyarrow.Table`.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        path: Root directory of the parquet dataset.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        filesystem: Optional fsspec filesystem. If omitted, a local &quot;file&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            filesystem is used.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        partition_filter: Optional list of partition prefix filters</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            (e.g. [&quot;date=2025-11-04&quot;]). Only files whose path relative to</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            ``path`` starts with one of these prefixes are included.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        Dict with keys:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        - ``files``: list of ``{&quot;path&quot;, &quot;size_bytes&quot;, &quot;num_rows&quot;}`` dicts</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        - ``total_bytes``: sum of file sizes</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        - ``total_rows``: sum of row counts</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        FileNotFoundError: If the path does not exist or no parquet files</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            match the optional partition filter.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        This is a thin wrapper around the shared core function. See</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        :func:`fsspeckit.core.maintenance.collect_dataset_stats` for the</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        authoritative implementation.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">collect_dataset_stats</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="k">return</span> <span class="n">collect_dataset_stats</span><span class="p">(</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.compact_parquet_dataset_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.compact_parquet_dataset_pyarrow</span>


<a href="#fsspeckit.datasets.compact_parquet_dataset_pyarrow" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">compact_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compact a parquet dataset directory into fewer larger files using PyArrow and shared planning.</p>
<p>Groups small files based on size (MB) and/or row thresholds, rewrites grouped
files into new parquet files, and optionally changes compression. Supports a
dry-run mode that returns the compaction plan without modifying files.</p>
<p>The implementation uses the shared core planning algorithm for consistent
behavior across backends. It processes data in a group-based, streaming fashion:
it reads only the files in a given group into memory when processing that group
and never materializes the entire dataset as a single table.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset root directory (local path or fsspec URL).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max output size per file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max rows per output file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes (e.g. <code>["date=2025-11-15"]</code>)
used to limit both stats collection and rewrites to matching paths.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parquet compression codec; defaults to <code>"snappy"</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When <code>True</code> the function returns a plan + before/after stats
without reading or writing any parquet data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional <code>fsspec.AbstractFileSystem</code> to reuse existing FS clients.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A stats dictionary describing before/after file counts, total bytes,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>rewritten bytes, and optional <code>planned_groups</code> when <code>dry_run</code> is enabled.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The structure follows the canonical <code>MaintenanceStats</code> format from the shared core.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If thresholds are invalid or no files match partition filter.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>result = compact_parquet_dataset_pyarrow(
...     "/path/to/dataset",
...     target_mb_per_file=64,
...     dry_run=True
... )
print(f"Files before: {result['before_file_count']}")
print(f"Files after: {result['after_file_count']}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates dataset discovery and compaction planning to the
shared <code>fsspeckit.core.maintenance</code> module, ensuring consistent behavior
across DuckDB and PyArrow backends.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="k">def</span><span class="w"> </span><span class="nf">compact_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compact a parquet dataset directory into fewer larger files using PyArrow and shared planning.</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    Groups small files based on size (MB) and/or row thresholds, rewrites grouped</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    files into new parquet files, and optionally changes compression. Supports a</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    dry-run mode that returns the compaction plan without modifying files.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    The implementation uses the shared core planning algorithm for consistent</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    behavior across backends. It processes data in a group-based, streaming fashion:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    it reads only the files in a given group into memory when processing that group</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    and never materializes the entire dataset as a single table.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        path: Dataset root directory (local path or fsspec URL).</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        target_mb_per_file: Optional max output size per file; must be &gt; 0.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        target_rows_per_file: Optional max rows per output file; must be &gt; 0.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        partition_filter: Optional list of partition prefixes (e.g. ``[&quot;date=2025-11-15&quot;]``)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">            used to limit both stats collection and rewrites to matching paths.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        compression: Optional parquet compression codec; defaults to ``&quot;snappy&quot;``.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        dry_run: When ``True`` the function returns a plan + before/after stats</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">            without reading or writing any parquet data.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        filesystem: Optional ``fsspec.AbstractFileSystem`` to reuse existing FS clients.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        A stats dictionary describing before/after file counts, total bytes,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        rewritten bytes, and optional ``planned_groups`` when ``dry_run`` is enabled.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">        The structure follows the canonical ``MaintenanceStats`` format from the shared core.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        ValueError: If thresholds are invalid or no files match partition filter.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        FileNotFoundError: If the path does not exist.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        &gt;&gt;&gt; result = compact_parquet_dataset_pyarrow(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        ...     &quot;/path/to/dataset&quot;,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        ...     target_mb_per_file=64,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        ...     dry_run=True</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        &gt;&gt;&gt; print(f&quot;Files before: {result[&#39;before_file_count&#39;]}&quot;)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        &gt;&gt;&gt; print(f&quot;Files after: {result[&#39;after_file_count&#39;]}&quot;)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        This function delegates dataset discovery and compaction planning to the</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        shared ``fsspeckit.core.maintenance`` module, ensuring consistent behavior</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        across DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">plan_compaction_groups</span><span class="p">,</span> <span class="n">MaintenanceStats</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="c1"># Get dataset stats using shared logic</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="c1"># Use shared compaction planning</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">plan_result</span> <span class="o">=</span> <span class="n">plan_compaction_groups</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">file_infos</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="c1"># Update planned stats with compression info</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">return</span> <span class="n">planned_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="c1"># Execute compaction using PyArrow</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span> <span class="ow">or</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">codec</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">rewritten_bytes_live</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="c1"># Process each group: read, concatenate, write a new file, then delete</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1"># originals for that group. This ensures peak memory is bounded by the</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="c1"># group size.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">for</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">promote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">out_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compact-</span><span class="si">{</span><span class="n">group_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">codec</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">rewritten_bytes_live</span> <span class="o">+=</span> <span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="c1"># Remove original files in this group</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="c1"># Best-effort cleanup; leave a warning to the caller.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: failed to delete &#39;</span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; after compaction&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="c1"># Recompute stats after compaction for the affected subset.</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes_live</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">codec</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.convert_large_types_to_normal" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.convert_large_types_to_normal</span>


<a href="#fsspeckit.datasets.convert_large_types_to_normal" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">convert_large_types_to_normal</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert large types in a PyArrow schema to their standard types.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow schema to convert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Schema: A new PyArrow schema with large types converted to standard types.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_large_types_to_normal</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">:</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="sd">    Convert large types in a PyArrow schema to their standard types.</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a><span class="sd">        schema (pa.Schema): The PyArrow schema to convert.</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a><span class="sd">        pa.Schema: A new PyArrow schema with large types converted to standard types.</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>    <span class="c1"># Define mapping of large types to standard types</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>    <span class="n">type_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_string</span><span class="p">():</span> <span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">(),</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_binary</span><span class="p">():</span> <span class="n">pa</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_utf8</span><span class="p">():</span> <span class="n">pa</span><span class="o">.</span><span class="n">utf8</span><span class="p">(),</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_list</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()):</span> <span class="n">pa</span><span class="o">.</span><span class="n">list_</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()),</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_list_view</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()):</span> <span class="n">pa</span><span class="o">.</span><span class="n">list_view</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()),</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="p">}</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="c1"># Convert fields</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>    <span class="n">new_fields</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>        <span class="n">field_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>        <span class="c1"># Check if type exists in mapping</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="k">if</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="n">type_mapping</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>            <span class="n">new_field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                <span class="nb">type</span><span class="o">=</span><span class="n">type_mapping</span><span class="p">[</span><span class="n">field_type</span><span class="p">],</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>                <span class="n">nullable</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>            <span class="p">)</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>        <span class="c1"># Handle large lists with nested types</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">LargeListType</span><span class="p">):</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>            <span class="n">new_field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>                <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">list_</span><span class="p">(</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                    <span class="n">type_mapping</span><span class="p">[</span><span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">]</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                    <span class="k">if</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span> <span class="ow">in</span> <span class="n">type_mapping</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                    <span class="k">else</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                <span class="p">),</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                <span class="n">nullable</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>            <span class="p">)</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>        <span class="c1"># Handle dictionary with large_string, large_utf8, or large_binary values</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">DictionaryType</span><span class="p">):</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>            <span class="n">new_field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">dictionary</span><span class="p">(</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                    <span class="n">field_type</span><span class="o">.</span><span class="n">index_type</span><span class="p">,</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>                    <span class="n">type_mapping</span><span class="p">[</span><span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">]</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>                    <span class="k">if</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span> <span class="ow">in</span> <span class="n">type_mapping</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>                    <span class="k">else</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">,</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>                    <span class="n">field_type</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>                <span class="p">),</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>                <span class="c1"># nullable=field.nullable,</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>            <span class="p">)</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>    <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.opt_dtype_pa" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.opt_dtype_pa</span>


<a href="#fsspeckit.datasets.opt_dtype_pa" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">opt_dtype_pa</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">include</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">exclude</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">time_zone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">shrink_numerics</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">allow_unsigned</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">strict</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">allow_null</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">sample_size</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">sample_method</span><span class="p">:</span> <span class="n"><span title="fsspeckit.datasets.pyarrow.SampleMethod">SampleMethod</span></span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">force_timezone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Optimize data types of a PyArrow Table for performance and memory efficiency.
Returns a new table casted to the optimal schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow table to optimize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to include in optimization (default: all columns).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to exclude from optimization.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_zone</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional time zone hint during datetime parsing.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shrink_numerics</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to downcast numeric types when possible.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_unsigned</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to allow unsigned integer types.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_large_dtypes</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, keep large types like large_string.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strict</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, will raise an error if any column cannot be optimized.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_null</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, columns that only hold null-like values will not be converted to pyarrow.null().</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of cleaned values to inspect during regex inference (None to inspect all).</p>
              </div>
            </td>
            <td>
                  <code>1024</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_method</code>
            </td>
            <td>
                  <code><span title="fsspeckit.datasets.pyarrow.SampleMethod">SampleMethod</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sampling strategy (<code>"first"</code> or <code>"random"</code>) for the inference subset.</p>
              </div>
            </td>
            <td>
                  <code>&#39;first&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_timezone</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, ensure all parsed datetime columns end up with this timezone.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-2037">2037</a></span>
<span class="normal"><a href="#__codelineno-0-2038">2038</a></span>
<span class="normal"><a href="#__codelineno-0-2039">2039</a></span>
<span class="normal"><a href="#__codelineno-0-2040">2040</a></span>
<span class="normal"><a href="#__codelineno-0-2041">2041</a></span>
<span class="normal"><a href="#__codelineno-0-2042">2042</a></span>
<span class="normal"><a href="#__codelineno-0-2043">2043</a></span>
<span class="normal"><a href="#__codelineno-0-2044">2044</a></span>
<span class="normal"><a href="#__codelineno-0-2045">2045</a></span>
<span class="normal"><a href="#__codelineno-0-2046">2046</a></span>
<span class="normal"><a href="#__codelineno-0-2047">2047</a></span>
<span class="normal"><a href="#__codelineno-0-2048">2048</a></span>
<span class="normal"><a href="#__codelineno-0-2049">2049</a></span>
<span class="normal"><a href="#__codelineno-0-2050">2050</a></span>
<span class="normal"><a href="#__codelineno-0-2051">2051</a></span>
<span class="normal"><a href="#__codelineno-0-2052">2052</a></span>
<span class="normal"><a href="#__codelineno-0-2053">2053</a></span>
<span class="normal"><a href="#__codelineno-0-2054">2054</a></span>
<span class="normal"><a href="#__codelineno-0-2055">2055</a></span>
<span class="normal"><a href="#__codelineno-0-2056">2056</a></span>
<span class="normal"><a href="#__codelineno-0-2057">2057</a></span>
<span class="normal"><a href="#__codelineno-0-2058">2058</a></span>
<span class="normal"><a href="#__codelineno-0-2059">2059</a></span>
<span class="normal"><a href="#__codelineno-0-2060">2060</a></span>
<span class="normal"><a href="#__codelineno-0-2061">2061</a></span>
<span class="normal"><a href="#__codelineno-0-2062">2062</a></span>
<span class="normal"><a href="#__codelineno-0-2063">2063</a></span>
<span class="normal"><a href="#__codelineno-0-2064">2064</a></span>
<span class="normal"><a href="#__codelineno-0-2065">2065</a></span>
<span class="normal"><a href="#__codelineno-0-2066">2066</a></span>
<span class="normal"><a href="#__codelineno-0-2067">2067</a></span>
<span class="normal"><a href="#__codelineno-0-2068">2068</a></span>
<span class="normal"><a href="#__codelineno-0-2069">2069</a></span>
<span class="normal"><a href="#__codelineno-0-2070">2070</a></span>
<span class="normal"><a href="#__codelineno-0-2071">2071</a></span>
<span class="normal"><a href="#__codelineno-0-2072">2072</a></span>
<span class="normal"><a href="#__codelineno-0-2073">2073</a></span>
<span class="normal"><a href="#__codelineno-0-2074">2074</a></span>
<span class="normal"><a href="#__codelineno-0-2075">2075</a></span>
<span class="normal"><a href="#__codelineno-0-2076">2076</a></span>
<span class="normal"><a href="#__codelineno-0-2077">2077</a></span>
<span class="normal"><a href="#__codelineno-0-2078">2078</a></span>
<span class="normal"><a href="#__codelineno-0-2079">2079</a></span>
<span class="normal"><a href="#__codelineno-0-2080">2080</a></span>
<span class="normal"><a href="#__codelineno-0-2081">2081</a></span>
<span class="normal"><a href="#__codelineno-0-2082">2082</a></span>
<span class="normal"><a href="#__codelineno-0-2083">2083</a></span>
<span class="normal"><a href="#__codelineno-0-2084">2084</a></span>
<span class="normal"><a href="#__codelineno-0-2085">2085</a></span>
<span class="normal"><a href="#__codelineno-0-2086">2086</a></span>
<span class="normal"><a href="#__codelineno-0-2087">2087</a></span>
<span class="normal"><a href="#__codelineno-0-2088">2088</a></span>
<span class="normal"><a href="#__codelineno-0-2089">2089</a></span>
<span class="normal"><a href="#__codelineno-0-2090">2090</a></span>
<span class="normal"><a href="#__codelineno-0-2091">2091</a></span>
<span class="normal"><a href="#__codelineno-0-2092">2092</a></span>
<span class="normal"><a href="#__codelineno-0-2093">2093</a></span>
<span class="normal"><a href="#__codelineno-0-2094">2094</a></span>
<span class="normal"><a href="#__codelineno-0-2095">2095</a></span>
<span class="normal"><a href="#__codelineno-0-2096">2096</a></span>
<span class="normal"><a href="#__codelineno-0-2097">2097</a></span>
<span class="normal"><a href="#__codelineno-0-2098">2098</a></span>
<span class="normal"><a href="#__codelineno-0-2099">2099</a></span>
<span class="normal"><a href="#__codelineno-0-2100">2100</a></span>
<span class="normal"><a href="#__codelineno-0-2101">2101</a></span>
<span class="normal"><a href="#__codelineno-0-2102">2102</a></span>
<span class="normal"><a href="#__codelineno-0-2103">2103</a></span>
<span class="normal"><a href="#__codelineno-0-2104">2104</a></span>
<span class="normal"><a href="#__codelineno-0-2105">2105</a></span>
<span class="normal"><a href="#__codelineno-0-2106">2106</a></span>
<span class="normal"><a href="#__codelineno-0-2107">2107</a></span>
<span class="normal"><a href="#__codelineno-0-2108">2108</a></span>
<span class="normal"><a href="#__codelineno-0-2109">2109</a></span>
<span class="normal"><a href="#__codelineno-0-2110">2110</a></span>
<span class="normal"><a href="#__codelineno-0-2111">2111</a></span>
<span class="normal"><a href="#__codelineno-0-2112">2112</a></span>
<span class="normal"><a href="#__codelineno-0-2113">2113</a></span>
<span class="normal"><a href="#__codelineno-0-2114">2114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-2037" name="__codelineno-0-2037"></a><span class="k">def</span><span class="w"> </span><span class="nf">opt_dtype</span><span class="p">(</span>
<a id="__codelineno-0-2038" name="__codelineno-0-2038"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
<a id="__codelineno-0-2039" name="__codelineno-0-2039"></a>    <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2040" name="__codelineno-0-2040"></a>    <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2041" name="__codelineno-0-2041"></a>    <span class="n">time_zone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2042" name="__codelineno-0-2042"></a>    <span class="n">shrink_numerics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2043" name="__codelineno-0-2043"></a>    <span class="n">allow_unsigned</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-2044" name="__codelineno-0-2044"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2045" name="__codelineno-0-2045"></a>    <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2046" name="__codelineno-0-2046"></a>    <span class="n">allow_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-2047" name="__codelineno-0-2047"></a>    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<a id="__codelineno-0-2048" name="__codelineno-0-2048"></a>    <span class="n">sample_method</span><span class="p">:</span> <span class="n">SampleMethod</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
<a id="__codelineno-0-2049" name="__codelineno-0-2049"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-2050" name="__codelineno-0-2050"></a>    <span class="n">force_timezone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2051" name="__codelineno-0-2051"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-2052" name="__codelineno-0-2052"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-2053" name="__codelineno-0-2053"></a><span class="sd">    Optimize data types of a PyArrow Table for performance and memory efficiency.</span>
<a id="__codelineno-0-2054" name="__codelineno-0-2054"></a><span class="sd">    Returns a new table casted to the optimal schema.</span>
<a id="__codelineno-0-2055" name="__codelineno-0-2055"></a>
<a id="__codelineno-0-2056" name="__codelineno-0-2056"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-2057" name="__codelineno-0-2057"></a><span class="sd">        table: The PyArrow table to optimize.</span>
<a id="__codelineno-0-2058" name="__codelineno-0-2058"></a><span class="sd">        include: Column(s) to include in optimization (default: all columns).</span>
<a id="__codelineno-0-2059" name="__codelineno-0-2059"></a><span class="sd">        exclude: Column(s) to exclude from optimization.</span>
<a id="__codelineno-0-2060" name="__codelineno-0-2060"></a><span class="sd">        time_zone: Optional time zone hint during datetime parsing.</span>
<a id="__codelineno-0-2061" name="__codelineno-0-2061"></a><span class="sd">        shrink_numerics: Whether to downcast numeric types when possible.</span>
<a id="__codelineno-0-2062" name="__codelineno-0-2062"></a><span class="sd">        allow_unsigned: Whether to allow unsigned integer types.</span>
<a id="__codelineno-0-2063" name="__codelineno-0-2063"></a><span class="sd">        use_large_dtypes: If True, keep large types like large_string.</span>
<a id="__codelineno-0-2064" name="__codelineno-0-2064"></a><span class="sd">        strict: If True, will raise an error if any column cannot be optimized.</span>
<a id="__codelineno-0-2065" name="__codelineno-0-2065"></a><span class="sd">        allow_null: If False, columns that only hold null-like values will not be converted to pyarrow.null().</span>
<a id="__codelineno-0-2066" name="__codelineno-0-2066"></a><span class="sd">        sample_size: Maximum number of cleaned values to inspect during regex inference (None to inspect all).</span>
<a id="__codelineno-0-2067" name="__codelineno-0-2067"></a><span class="sd">        sample_method: Sampling strategy (`&quot;first&quot;` or `&quot;random&quot;`) for the inference subset.</span>
<a id="__codelineno-0-2068" name="__codelineno-0-2068"></a><span class="sd">        force_timezone: If set, ensure all parsed datetime columns end up with this timezone.</span>
<a id="__codelineno-0-2069" name="__codelineno-0-2069"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-2070" name="__codelineno-0-2070"></a>    <span class="k">if</span> <span class="n">sample_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2071" name="__codelineno-0-2071"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sample_method must be &#39;first&#39; or &#39;random&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2072" name="__codelineno-0-2072"></a>
<a id="__codelineno-0-2073" name="__codelineno-0-2073"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2074" name="__codelineno-0-2074"></a>        <span class="n">include</span> <span class="o">=</span> <span class="p">[</span><span class="n">include</span><span class="p">]</span>
<a id="__codelineno-0-2075" name="__codelineno-0-2075"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2076" name="__codelineno-0-2076"></a>        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude</span><span class="p">]</span>
<a id="__codelineno-0-2077" name="__codelineno-0-2077"></a>
<a id="__codelineno-0-2078" name="__codelineno-0-2078"></a>    <span class="n">cols_to_process</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span>
<a id="__codelineno-0-2079" name="__codelineno-0-2079"></a>    <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
<a id="__codelineno-0-2080" name="__codelineno-0-2080"></a>        <span class="n">cols_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">include</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span><span class="p">]</span>
<a id="__codelineno-0-2081" name="__codelineno-0-2081"></a>    <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
<a id="__codelineno-0-2082" name="__codelineno-0-2082"></a>        <span class="n">cols_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_process</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
<a id="__codelineno-0-2083" name="__codelineno-0-2083"></a>
<a id="__codelineno-0-2084" name="__codelineno-0-2084"></a>    <span class="c1"># Prepare arguments for parallel processing</span>
<a id="__codelineno-0-2085" name="__codelineno-0-2085"></a>    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-2086" name="__codelineno-0-2086"></a>        <span class="p">(</span>
<a id="__codelineno-0-2087" name="__codelineno-0-2087"></a>            <span class="n">table</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span>
<a id="__codelineno-0-2088" name="__codelineno-0-2088"></a>            <span class="n">col_name</span><span class="p">,</span>
<a id="__codelineno-0-2089" name="__codelineno-0-2089"></a>            <span class="n">cols_to_process</span><span class="p">,</span>
<a id="__codelineno-0-2090" name="__codelineno-0-2090"></a>            <span class="n">shrink_numerics</span><span class="p">,</span>
<a id="__codelineno-0-2091" name="__codelineno-0-2091"></a>            <span class="n">allow_unsigned</span><span class="p">,</span>
<a id="__codelineno-0-2092" name="__codelineno-0-2092"></a>            <span class="n">time_zone</span><span class="p">,</span>
<a id="__codelineno-0-2093" name="__codelineno-0-2093"></a>            <span class="n">strict</span><span class="p">,</span>
<a id="__codelineno-0-2094" name="__codelineno-0-2094"></a>            <span class="n">allow_null</span><span class="p">,</span>
<a id="__codelineno-0-2095" name="__codelineno-0-2095"></a>            <span class="n">force_timezone</span><span class="p">,</span>
<a id="__codelineno-0-2096" name="__codelineno-0-2096"></a>            <span class="n">sample_size</span><span class="p">,</span>
<a id="__codelineno-0-2097" name="__codelineno-0-2097"></a>            <span class="n">sample_method</span><span class="p">,</span>
<a id="__codelineno-0-2098" name="__codelineno-0-2098"></a>        <span class="p">)</span>
<a id="__codelineno-0-2099" name="__codelineno-0-2099"></a>        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span>
<a id="__codelineno-0-2100" name="__codelineno-0-2100"></a>    <span class="p">]</span>
<a id="__codelineno-0-2101" name="__codelineno-0-2101"></a>
<a id="__codelineno-0-2102" name="__codelineno-0-2102"></a>    <span class="c1"># Parallelize column processing</span>
<a id="__codelineno-0-2103" name="__codelineno-0-2103"></a>    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-0-2104" name="__codelineno-0-2104"></a>        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_process_column_for_opt_dtype</span><span class="p">,</span> <span class="n">args_list</span><span class="p">))</span>
<a id="__codelineno-0-2105" name="__codelineno-0-2105"></a>
<a id="__codelineno-0-2106" name="__codelineno-0-2106"></a>    <span class="c1"># Sort results to preserve column order</span>
<a id="__codelineno-0-2107" name="__codelineno-0-2107"></a>    <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-2108" name="__codelineno-0-2108"></a>    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<a id="__codelineno-0-2109" name="__codelineno-0-2109"></a>    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<a id="__codelineno-0-2110" name="__codelineno-0-2110"></a>
<a id="__codelineno-0-2111" name="__codelineno-0-2111"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
<a id="__codelineno-0-2112" name="__codelineno-0-2112"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_large_dtypes</span><span class="p">:</span>
<a id="__codelineno-0-2113" name="__codelineno-0-2113"></a>        <span class="n">schema</span> <span class="o">=</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-0-2114" name="__codelineno-0-2114"></a>    <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.optimize_parquet_dataset_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.optimize_parquet_dataset_pyarrow</span>


<a href="#fsspeckit.datasets.optimize_parquet_dataset_pyarrow" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">optimize_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cluster parquet files by <code>zorder_columns</code> while rewriting groups on disk.</p>
<p>This function uses the shared core planning algorithm for consistent optimization
behavior across backends. It processes data in a streaming, per-group fashion
that avoids materializing the entire dataset.</p>
<p>The helper enumerates individual parquet files under <code>path</code>, optionally
filtering them by <code>partition_filter</code> prefixes so we never materialize the
entire dataset with <code>dataset.to_table()</code>. Each optimization group is streamed
file-by-file, sorted by <code>zorder_columns</code> in memory, and then rewritten to an
<code>optimized-*.parquet</code> file while the original inputs are deleted only after
a successful write. Use dry-run mode to inspect the planned groups/metrics
before any data is touched.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset root directory (local path or fsspec URL).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zorder_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ordered columns that determine clustering/ordering.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max output size per file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max rows per output file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes (e.g. <code>["date=2025-11-15"]</code>)
used to limit both stats collection and rewrites to matching paths.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parquet compression codec; defaults to <code>"snappy"</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When <code>True</code> the function returns a plan + before/after stats
without reading or writing any parquet data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional <code>fsspec.AbstractFileSystem</code> to reuse existing FS clients.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A stats dictionary describing before/after file counts, total bytes,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>rewritten bytes, <code>zorder_columns</code>, and optional <code>planned_groups</code> when</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>dry_run</code> is enabled. The structure follows the canonical <code>MaintenanceStats</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>format from the shared core.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If thresholds are invalid or if any <code>zorder_columns</code> are missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist or no parquet files are found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates optimization planning and validation to the shared
<code>fsspeckit.core.maintenance.plan_optimize_groups</code> function, ensuring
consistent behavior with DuckDB backend.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cluster parquet files by ``zorder_columns`` while rewriting groups on disk.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    This function uses the shared core planning algorithm for consistent optimization</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    behavior across backends. It processes data in a streaming, per-group fashion</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    that avoids materializing the entire dataset.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    The helper enumerates individual parquet files under ``path``, optionally</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    filtering them by ``partition_filter`` prefixes so we never materialize the</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    entire dataset with ``dataset.to_table()``. Each optimization group is streamed</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    file-by-file, sorted by ``zorder_columns`` in memory, and then rewritten to an</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    ``optimized-*.parquet`` file while the original inputs are deleted only after</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    a successful write. Use dry-run mode to inspect the planned groups/metrics</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    before any data is touched.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        path: Dataset root directory (local path or fsspec URL).</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        zorder_columns: Ordered columns that determine clustering/ordering.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        target_mb_per_file: Optional max output size per file; must be &gt; 0.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        target_rows_per_file: Optional max rows per output file; must be &gt; 0.</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        partition_filter: Optional list of partition prefixes (e.g. ``[&quot;date=2025-11-15&quot;]``)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">            used to limit both stats collection and rewrites to matching paths.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">        compression: Optional parquet compression codec; defaults to ``&quot;snappy&quot;``.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        dry_run: When ``True`` the function returns a plan + before/after stats</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">            without reading or writing any parquet data.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">        filesystem: Optional ``fsspec.AbstractFileSystem`` to reuse existing FS clients.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        A stats dictionary describing before/after file counts, total bytes,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        rewritten bytes, ``zorder_columns``, and optional ``planned_groups`` when</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        ``dry_run`` is enabled. The structure follows the canonical ``MaintenanceStats``</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        format from the shared core.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        ValueError: If thresholds are invalid or if any ``zorder_columns`` are missing.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        FileNotFoundError: If the path does not exist or no parquet files are found.</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        This function delegates optimization planning and validation to the shared</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        ``fsspeckit.core.maintenance.plan_optimize_groups`` function, ensuring</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        consistent behavior with DuckDB backend.</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">MaintenanceStats</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">plan_optimize_groups</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># Use shared core validation</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">zorder_columns</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zorder_columns must be a non-empty list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_mb_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_mb_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">if</span> <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_rows_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="c1"># Collect dataset stats using shared core</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="s2">&quot;before_file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="s2">&quot;after_file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="s2">&quot;before_total_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="s2">&quot;after_total_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="s2">&quot;compacted_file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="s2">&quot;rewritten_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="s2">&quot;compression_codec&quot;</span><span class="p">:</span> <span class="n">compression</span><span class="p">,</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="s2">&quot;zorder_columns&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">),</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="p">}</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span> <span class="ow">or</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="c1"># Get schema for validation (sample first file)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>    <span class="n">sample_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">sample_table</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="c1"># Use shared core planning with z-order validation</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">plan_optimize_groups</span><span class="p">(</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">sample_schema</span><span class="o">=</span><span class="n">sample_table</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="c1"># Handle dry run</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">after_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">after_file_count</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">after_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="n">compression_codec</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">zorder_columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">),</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="n">planned_groups</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">planned_groups</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">codec</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="n">written_files</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="c1"># Process each optimization group in streaming fashion</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="k">for</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="k">continue</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="c1"># Read tables for this group only (streaming per-group)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="k">continue</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="c1"># Sort the combined group data by z-order columns</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">promote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">sort_keys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;ascending&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">zorder_columns</span><span class="p">]</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">combined_sorted</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">sort_keys</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="c1"># Write sorted group to output file</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="n">out_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;optimized-</span><span class="si">{</span><span class="n">group_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span><span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">combined_sorted</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">codec</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">written_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="c1"># Delete original files in this group</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: failed to delete &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; during optimize&quot;</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>    <span class="c1"># Recompute stats after optimization</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">codec</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">),</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.datasets.unify_schemas_pa" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.unify_schemas_pa</span>


<a href="#fsspeckit.datasets.unify_schemas_pa" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">unify_schemas_pa</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">timezone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">standardize_timezones</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">remove_conflicting_columns</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unify a list of PyArrow schemas into a single schema using intelligent conflict resolution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schemas</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="pyarrow.Schema">Schema</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of PyArrow schemas to unify.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_large_dtypes</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, keep large types like large_string.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timezone</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified, standardize all timestamp columns to this timezone.
If "auto", use the most frequent timezone across schemas.
If None, remove timezone from all timestamp columns.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>standardize_timezones</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, standardize all timestamp columns to the most frequent timezone.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print conflict resolution details for debugging.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>remove_conflicting_columns</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, allows removal of columns with type conflicts as a fallback
strategy instead of converting them. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Schema: A unified PyArrow schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no schemas are provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1391" name="__codelineno-0-1391"></a><span class="k">def</span><span class="w"> </span><span class="nf">unify_schemas</span><span class="p">(</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">],</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>    <span class="n">timezone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>    <span class="n">standardize_timezones</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>    <span class="n">remove_conflicting_columns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">:</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a><span class="sd">    Unify a list of PyArrow schemas into a single schema using intelligent conflict resolution.</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a><span class="sd">        schemas (list[pa.Schema]): List of PyArrow schemas to unify.</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a><span class="sd">        use_large_dtypes (bool): If True, keep large types like large_string.</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a><span class="sd">        timezone (str | None): If specified, standardize all timestamp columns to this timezone.</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a><span class="sd">            If &quot;auto&quot;, use the most frequent timezone across schemas.</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a><span class="sd">            If None, remove timezone from all timestamp columns.</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a><span class="sd">        standardize_timezones (bool): If True, standardize all timestamp columns to the most frequent timezone.</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a><span class="sd">        verbose (bool): If True, print conflict resolution details for debugging.</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a><span class="sd">        remove_conflicting_columns (bool): If True, allows removal of columns with type conflicts as a fallback</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a><span class="sd">            strategy instead of converting them. Defaults to False.</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a><span class="sd">        pa.Schema: A unified PyArrow schema.</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a><span class="sd">        ValueError: If no schemas are provided.</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">schemas</span><span class="p">:</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one schema must be provided for unification&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>    <span class="c1"># Early exit for single schema</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>    <span class="n">unique_schemas</span> <span class="o">=</span> <span class="n">_unique_schemas</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>        <span class="n">result_schema</span> <span class="o">=</span> <span class="n">unique_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>        <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>            <span class="n">result_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">([</span><span class="n">result_schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>            <span class="n">result_schema</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>            <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>            <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">result_schema</span><span class="p">)</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>        <span class="p">)</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>    <span class="c1"># Step 1: Find and resolve conflicts first</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>    <span class="n">conflicts</span> <span class="o">=</span> <span class="n">_find_conflicting_fields</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>    <span class="k">if</span> <span class="n">conflicts</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="n">_log_conflict_summary</span><span class="p">(</span><span class="n">conflicts</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>    <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="c1"># Normalize schemas using intelligent promotion rules</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>        <span class="n">unique_schemas</span> <span class="o">=</span> <span class="n">_normalize_schema_types</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>    <span class="c1"># Step 2: Attempt unification with conflict-resolved schemas</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>        <span class="n">unified_schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">unify_schemas</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">,</span> <span class="n">promote_options</span><span class="o">=</span><span class="s2">&quot;permissive&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>        <span class="c1"># Step 3: Apply timezone standardization to the unified result</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>        <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>            <span class="n">unified_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">([</span><span class="n">unified_schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>            <span class="n">unified_schema</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>            <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>            <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">unified_schema</span><span class="p">)</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>        <span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>    <span class="k">except</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">ArrowInvalid</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ArrowTypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>        <span class="c1"># Step 4: Intelligent fallback strategies</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary unification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting fallback strategies...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>        <span class="c1"># Fallback 1: Try aggressive string conversion for remaining conflicts</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>            <span class="n">fallback_schema</span> <span class="o">=</span> <span class="n">_aggressive_fallback_unification</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>            <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>                <span class="n">fallback_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>                    <span class="p">[</span><span class="n">fallback_schema</span><span class="p">],</span> <span class="n">timezone</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Aggressive fallback succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>            <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>                <span class="n">fallback_schema</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>                <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>                <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">fallback_schema</span><span class="p">)</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>            <span class="p">)</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Aggressive fallback failed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>        <span class="c1"># Fallback 2: Remove conflicting fields (if enabled)</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>        <span class="k">if</span> <span class="n">remove_conflicting_columns</span><span class="p">:</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>                <span class="n">non_conflicting_schema</span> <span class="o">=</span> <span class="n">_remove_conflicting_fields</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>                <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>                    <span class="n">non_conflicting_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>                        <span class="p">[</span><span class="n">non_conflicting_schema</span><span class="p">],</span> <span class="n">timezone</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Remove conflicting fields fallback succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>                <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>                    <span class="n">non_conflicting_schema</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>                    <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>                    <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">non_conflicting_schema</span><span class="p">)</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>                <span class="p">)</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Remove conflicting fields fallback failed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>        <span class="c1"># Fallback 3: Remove problematic fields that can&#39;t be unified</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>            <span class="n">minimal_schema</span> <span class="o">=</span> <span class="n">_remove_problematic_fields</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>            <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>                <span class="n">minimal_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>                    <span class="p">[</span><span class="n">minimal_schema</span><span class="p">],</span> <span class="n">timezone</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Minimal schema (removed problematic fields) succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>            <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>                <span class="n">minimal_schema</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>                <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>                <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">minimal_schema</span><span class="p">)</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>            <span class="p">)</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Minimal schema fallback failed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>        <span class="c1"># Fallback 4: Return first schema as last resort</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; All fallback strategies failed, returning first schema&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>        <span class="n">first_schema</span> <span class="o">=</span> <span class="n">unique_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>        <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>            <span class="n">first_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">([</span><span class="n">first_schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>            <span class="n">first_schema</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>            <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>            <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">first_schema</span><span class="p">)</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>
<h3 id="fsspeckit.datasets-modules">Modules<a href="#fsspeckit.datasets-modules" class="headerlink" title="Permanent link">&para;</a></h3>

<div class="doc doc-object doc-module">



<h4 id="fsspeckit.datasets.duckdb" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">fsspeckit.datasets.duckdb</span>


<a href="#fsspeckit.datasets.duckdb" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

        <p>DuckDB-based parquet dataset handler with fsspec integration.</p>
<p>This module provides a high-performance interface for reading and writing parquet
datasets using DuckDB with support for various filesystems through fsspec.
DuckDB provides excellent parquet support with SQL analytics capabilities.</p>










  <div class="doc doc-children">







<h5 id="fsspeckit.datasets.duckdb-classes">Classes<a href="#fsspeckit.datasets.duckdb-classes" class="headerlink" title="Permanent link">&para;</a></h5>

<div class="doc doc-object doc-class">



<h6 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">DuckDBParquetHandler</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="n"><span title="fsspeckit.storage_options.base.BaseStorageOptions">BaseStorageOptions</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Handler for parquet operations using DuckDB with fsspec integration.</p>
<p>This class provides methods for reading and writing parquet files and datasets
using DuckDB's high-performance parquet engine. It integrates with fsspec
filesystems to support local and remote storage (S3, GCS, Azure, etc.).</p>
<p>The handler can be initialized with either storage options or an existing
filesystem instance. For remote filesystems, the fsspec filesystem is
registered in DuckDB using <code>.register_filesystem(fs)</code> to enable direct
access to remote paths.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>storage_options</code>
            </td>
            <td>
                  <code><span title="fsspeckit.storage_options.base.BaseStorageOptions">BaseStorageOptions</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Storage configuration options (e.g., AwsStorageOptions).
If provided, a filesystem is created from these options.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An existing fsspec filesystem instance. Takes precedence over
storage_options if both are provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic usage with local filesystem:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuckDBParquetHandler</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create sample data</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Write and read parquet file</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Using with AWS S3:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuckDBParquetHandler</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">options</span> <span class="o">=</span> <span class="n">AwsStorageOptions</span><span class="p">(</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">access_key_id</span><span class="o">=</span><span class="s2">&quot;YOUR_KEY&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>    <span class="n">secret_access_key</span><span class="o">=</span><span class="s2">&quot;YOUR_SECRET&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span>    <span class="n">region</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="gp">... </span>    <span class="c1"># Read from S3</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="gp">... </span>    <span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;s3://bucket/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="gp">...</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="gp">... </span>    <span class="c1"># Execute SQL query on S3 data</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="gp">... </span>        <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;s3://bucket/data.parquet&#39;) WHERE col &gt; 10&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="gp">... </span>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Using with existing filesystem:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit</span><span class="w"> </span><span class="kn">import</span> <span class="n">filesystem</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DuckDBParquetHandler</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">filesystem</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>SQL query execution:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">...</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="c1"># Simple query</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>        <span class="s2">&quot;SELECT a, b FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE a &gt; 1&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span>    <span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">...</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">... </span>    <span class="c1"># Parameterized query</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="gp">... </span>        <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE a BETWEEN ? AND ?&quot;</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="gp">... </span>        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="gp">... </span>    <span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="gp">...</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="gp">... </span>    <span class="c1"># Aggregation query</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="gp">... </span><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="gp">... </span><span class="sd">        SELECT b, COUNT(*) as count, AVG(a) as avg_a</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="gp">... </span><span class="sd">        FROM parquet_scan(&#39;/tmp/data.parquet&#39;)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="gp">... </span><span class="sd">        GROUP BY b</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="gp">... </span><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="gp">... </span>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Reading specific columns:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="c1"># Only read columns &#39;a&#39; and &#39;b&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
    <p>Writing with compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/data2.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;zstd&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

        <p>Initialize the DuckDB parquet handler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>storage_options</code>
            </td>
            <td>
                  <code><span title="fsspeckit.storage_options.base.BaseStorageOptions">BaseStorageOptions</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Storage configuration options. If provided, a filesystem
is created from these options.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An existing fsspec filesystem instance. Takes precedence over
storage_options if both are provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">storage_options</span><span class="p">:</span> <span class="s2">&quot;BaseStorageOptions | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the DuckDB parquet handler.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        storage_options: Storage configuration options. If provided, a filesystem</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            is created from these options.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        filesystem: An existing fsspec filesystem instance. Takes precedence over</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">            storage_options if both are provided.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_storage_options</span> <span class="o">=</span> <span class="n">storage_options</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="c1"># Determine which filesystem to use</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">if</span> <span class="n">filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="o">=</span> <span class="n">filesystem</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">elif</span> <span class="n">storage_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="o">=</span> <span class="n">storage_options</span><span class="o">.</span><span class="n">to_filesystem</span><span class="p">()</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># Default to local filesystem</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="o">=</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">








<h7 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler-functions">Functions<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler-functions" class="headerlink" title="Permanent link">&para;</a></h7>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.__del__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.__del__</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.__del__" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">__del__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cleanup on deletion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1356" name="__codelineno-0-1356"></a><span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleanup on deletion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.__enter__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.__enter__</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.__enter__" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">__enter__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="            fsspeckit.datasets.duckdb.DuckDBParquetHandler" href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler">DuckDBParquetHandler</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Enter context manager.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            fsspeckit.datasets.duckdb.DuckDBParquetHandler" href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler">DuckDBParquetHandler</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self for use in with statement.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1026" name="__codelineno-0-1026"></a><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DuckDBParquetHandler&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enter context manager.</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a><span class="sd">        Self for use in with statement.</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.__exit__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.__exit__</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.__exit__" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="n">exc_val</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Exit context manager and close connection.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>exc_type</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception type if an exception occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exc_val</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception value if an exception occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exc_tb</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exception traceback if an exception occurred.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1035" name="__codelineno-0-1035"></a><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exit context manager and close connection.</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a><span class="sd">        exc_type: Exception type if an exception occurred.</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a><span class="sd">        exc_val: Exception value if an exception occurred.</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a><span class="sd">        exc_tb: Exception traceback if an exception occurred.</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.close" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.close</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.close" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">close</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Close the DuckDB connection.</p>
<p>This method is called automatically when using the context manager.
Manual calls are only needed when not using the context manager pattern.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1016" name="__codelineno-0-1016"></a><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the DuckDB connection.</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="sd">    This method is called automatically when using the context manager.</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a><span class="sd">    Manual calls are only needed when not using the context manager pattern.</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.compact_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.compact_parquet_dataset</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.compact_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">compact_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compact a parquet dataset directory into fewer larger files using shared planning.</p>
<p>This function delegates compaction planning to the shared core module,
ensuring consistent behavior across DuckDB and PyArrow backends.</p>
<p>Groups small files based on size (MB) and/or row thresholds, rewrites grouped
files into new parquet files, optionally changing compression. Supports
dry-run mode returning planned groups without writing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset directory path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Desired approximate size per output file (MB).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Desired maximum rows per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes to restrict scope.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional compression codec; defaults to existing or 'snappy'.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, plan only without modifying files.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Statistics dict following canonical MaintenanceStats format, including</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>before/after counts and optional plan when dry_run=True.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates dataset discovery and compaction planning to the
shared <code>fsspeckit.core.maintenance</code> module for consistent behavior
with the PyArrow backend.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1083" name="__codelineno-0-1083"></a><span class="k">def</span><span class="w"> </span><span class="nf">compact_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compact a parquet dataset directory into fewer larger files using shared planning.</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a><span class="sd">    This function delegates compaction planning to the shared core module,</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a><span class="sd">    ensuring consistent behavior across DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a><span class="sd">    Groups small files based on size (MB) and/or row thresholds, rewrites grouped</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a><span class="sd">    files into new parquet files, optionally changing compression. Supports</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a><span class="sd">    dry-run mode returning planned groups without writing.</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a><span class="sd">        path: Dataset directory path.</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a><span class="sd">        target_mb_per_file: Desired approximate size per output file (MB).</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a><span class="sd">        target_rows_per_file: Desired maximum rows per output file.</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a><span class="sd">        partition_filter: Optional list of partition prefixes to restrict scope.</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a><span class="sd">        compression: Optional compression codec; defaults to existing or &#39;snappy&#39;.</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a><span class="sd">        dry_run: If True, plan only without modifying files.</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a><span class="sd">        Statistics dict following canonical MaintenanceStats format, including</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a><span class="sd">        before/after counts and optional plan when dry_run=True.</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a><span class="sd">        This function delegates dataset discovery and compaction planning to the</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a><span class="sd">        shared ``fsspeckit.core.maintenance`` module for consistent behavior</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a><span class="sd">        with the PyArrow backend.</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">plan_compaction_groups</span><span class="p">,</span> <span class="n">MaintenanceStats</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Filesystem not initialized for compaction&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>    <span class="n">filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>    <span class="c1"># Get dataset stats using shared logic</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>    <span class="n">stats_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="p">)</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats_before</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>    <span class="c1"># Use shared compaction planning</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>    <span class="n">plan_result</span> <span class="o">=</span> <span class="n">plan_compaction_groups</span><span class="p">(</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>        <span class="n">file_infos</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>    <span class="p">)</span>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>    <span class="c1"># Update planned stats with compression info</span>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a>        <span class="k">return</span> <span class="n">planned_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>    <span class="c1"># Execute compaction using DuckDB</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>    <span class="n">rewritten_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>        <span class="c1"># Read group into Arrow table using DuckDB for efficiency</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>            <span class="n">scan_list</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>                <span class="sa">f</span><span class="s2">&quot;SELECT * FROM parquet_scan([</span><span class="si">{</span><span class="n">scan_list</span><span class="si">}</span><span class="s2">])&quot;</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>            <span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>                <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>            <span class="c1"># Fallback to pyarrow</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>            <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>                <span class="k">with</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a>                    <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a>        <span class="c1"># Write compacted file</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>        <span class="n">out_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_filename</span><span class="p">(</span><span class="s2">&quot;compact-</span><span class="si">{}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>        <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span><span class="p">)</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>        <span class="n">rewritten_bytes</span> <span class="o">+=</span> <span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>        <span class="c1"># Remove original files</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>                <span class="n">filesystem</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: failed to delete &#39;</span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>    <span class="c1"># Recompute stats after compaction</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a>    <span class="p">)</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.execute_sql" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.execute_sql</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.execute_sql" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">query</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Execute SQL query on parquet data and return results.</p>
<p>Executes a SQL query using DuckDB and returns the results as a PyArrow table.
The query can reference parquet files using the <code>parquet_scan()</code> function.
Supports parameterized queries for safe value substitution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQL query string. Use <code>parquet_scan('path')</code> to reference parquet files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parameters</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of parameter values for parameterized queries.
Use <code>?</code> placeholders in the query string.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table containing the query results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DuckDB encounters a SQL syntax error or query execution error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Simple query:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age &gt; 30&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Parameterized query:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="s2">&quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age BETWEEN ? AND ?&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Aggregation query:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span><span class="sd">    SELECT category, COUNT(*) as count, AVG(price) as avg_price</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="sd">    FROM parquet_scan(&#39;/tmp/data.parquet&#39;)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="sd">    GROUP BY category</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="sd">    ORDER BY count DESC</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Join multiple parquet files:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span><span class="sd">    SELECT a.*, b.name</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="sd">    FROM parquet_scan(&#39;/tmp/data1.parquet&#39;) a</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="sd">    JOIN parquet_scan(&#39;/tmp/data2.parquet&#39;) b</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="sd">    ON a.id = b.id</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Window functions:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span><span class="sd">    SELECT</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span><span class="sd">        date,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="sd">        revenue,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="sd">        AVG(revenue) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as moving_avg</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="sd">    FROM parquet_scan(&#39;/tmp/sales.parquet&#39;)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-934" name="__codelineno-0-934"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_sql</span><span class="p">(</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>    <span class="n">parameters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute SQL query on parquet data and return results.</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a><span class="sd">    Executes a SQL query using DuckDB and returns the results as a PyArrow table.</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a><span class="sd">    The query can reference parquet files using the `parquet_scan()` function.</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a><span class="sd">    Supports parameterized queries for safe value substitution.</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a><span class="sd">        query: SQL query string. Use `parquet_scan(&#39;path&#39;)` to reference parquet files.</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a><span class="sd">        parameters: Optional list of parameter values for parameterized queries.</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a><span class="sd">            Use `?` placeholders in the query string.</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a><span class="sd">        PyArrow table containing the query results.</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a><span class="sd">        Exception: If DuckDB encounters a SQL syntax error or query execution error.</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="sd">        Simple query:</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler()</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a><span class="sd">        ...     &quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age &gt; 30&quot;</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a><span class="sd">        Parameterized query:</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a><span class="sd">        ...     &quot;SELECT * FROM parquet_scan(&#39;/tmp/data.parquet&#39;) WHERE age BETWEEN ? AND ?&quot;,</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a><span class="sd">        ...     parameters=[25, 40]</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a><span class="sd">        Aggregation query:</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a><span class="sd">        ...     SELECT category, COUNT(*) as count, AVG(price) as avg_price</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="sd">        ...     FROM parquet_scan(&#39;/tmp/data.parquet&#39;)</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a><span class="sd">        ...     GROUP BY category</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="sd">        ...     ORDER BY count DESC</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a><span class="sd">        Join multiple parquet files:</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a><span class="sd">        ...     SELECT a.*, b.name</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a><span class="sd">        ...     FROM parquet_scan(&#39;/tmp/data1.parquet&#39;) a</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a><span class="sd">        ...     JOIN parquet_scan(&#39;/tmp/data2.parquet&#39;) b</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a><span class="sd">        ...     ON a.id = b.id</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a><span class="sd">        Window functions:</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a><span class="sd">        &gt;&gt;&gt; result = handler.execute_sql(</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a><span class="sd">        ...     SELECT</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a><span class="sd">        ...         date,</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a><span class="sd">        ...         revenue,</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a><span class="sd">        ...         AVG(revenue) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as moving_avg</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a><span class="sd">        ...     FROM parquet_scan(&#39;/tmp/sales.parquet&#39;)</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a><span class="sd">        ...     &#39;&#39;&#39;</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="c1"># Execute parameterized query</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>            <span class="c1"># Execute regular query</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>        <span class="c1"># Convert RecordBatchReader to Table</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to execute SQL query: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.merge_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.merge_parquet_dataset</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.merge_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">source</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span> <span class="o">|</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">key_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n"><span title="fsspeckit.datasets.duckdb.MergeStrategy">MergeStrategy</span></span> <span class="o">=</span> <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">dedup_order_by</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">progress_callback</span><span class="p">:</span> <span class="n"><span title="typing.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Merge source data into target parquet dataset using specified strategy.</p>
<p>Performs intelligent merge operations on parquet datasets with support for
UPSERT, INSERT-only, UPDATE-only, FULL_MERGE (sync), and DEDUPLICATE strategies.
Uses DuckDB's SQL engine for efficient merging with QUALIFY for deduplication.</p>
<p>This implementation uses shared merge validation and semantics from fsspeckit.core.merge
to ensure consistent behavior across all backends. All merge strategies share the same
semantics, validation rules, and statistical calculations as the PyArrow implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span> | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source data as PyArrow table or path to parquet dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to target parquet dataset directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to use for matching records. Can be single column
name (string) or list of column names for composite keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy</code>
            </td>
            <td>
                  <code><span title="fsspeckit.datasets.duckdb.MergeStrategy">MergeStrategy</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Merge strategy to use:
- "upsert": Insert new records, update existing (default)
- "insert": Insert only new records, ignore existing
- "update": Update only existing records, ignore new
- "full_merge": Insert, update, and delete (full sync with source)
- "deduplicate": Remove duplicates from source, then upsert</p>
              </div>
            </td>
            <td>
                  <code>&#39;upsert&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dedup_order_by</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to use for ordering when deduplicating (for
"deduplicate" strategy). Keeps record with highest value. If None,
uses first occurrence.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec for output. Default is "snappy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;snappy&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>, <span title="int">int</span>, <span title="int">int</span>], None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callback function for progress tracking.
Called with (stage, current, total) where stage is a string description.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with merge statistics:
- "inserted": Number of records inserted
- "updated": Number of records updated
- "deleted": Number of records deleted
- "total": Total records in merged dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If strategy invalid, key columns missing, or NULL keys present.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If source/target schemas incompatible.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If merge operation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>UPSERT - insert new and update existing:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>        <span class="n">source</span><span class="o">=</span><span class="n">new_data_table</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>        <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/customers/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>        <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>        <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;upsert&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span>    <span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inserted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Updated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>INSERT - add only new records:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;/staging/new_orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;order_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inserted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> new orders&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>UPDATE - update existing only:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">product_updates</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/products/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;update&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>FULL_MERGE - complete synchronization:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">authoritative_data</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/inventory/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;item_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;full_merge&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synced: +</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;inserted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>DEDUPLICATE - remove duplicates first:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">raw_data_with_dups</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/transactions/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;deduplicate&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span>    <span class="n">dedup_order_by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>  <span class="c1"># Keep latest</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Composite key:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">source</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">target_path</span><span class="o">=</span><span class="s2">&quot;/data/sales/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span> <span class="s2">&quot;order_date&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;upsert&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


<details class="note" open>
  <summary>Note</summary>
  <p>This implementation uses shared merge validation and semantics from fsspeckit.core.merge
to ensure consistent behavior across all backends. Atomic operations are performed using
temporary directories with backup-and-restore for error recovery.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="n">key_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n">MergeStrategy</span> <span class="o">=</span> <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="n">dedup_order_by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge source data into target parquet dataset using specified strategy.</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">    Performs intelligent merge operations on parquet datasets with support for</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">    UPSERT, INSERT-only, UPDATE-only, FULL_MERGE (sync), and DEDUPLICATE strategies.</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">    Uses DuckDB&#39;s SQL engine for efficient merging with QUALIFY for deduplication.</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">    This implementation uses shared merge validation and semantics from fsspeckit.core.merge</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">    to ensure consistent behavior across all backends. All merge strategies share the same</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">    semantics, validation rules, and statistical calculations as the PyArrow implementation.</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">        source: Source data as PyArrow table or path to parquet dataset.</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">        target_path: Path to target parquet dataset directory.</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">        key_columns: Column(s) to use for matching records. Can be single column</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">            name (string) or list of column names for composite keys.</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        strategy: Merge strategy to use:</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">            - &quot;upsert&quot;: Insert new records, update existing (default)</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">            - &quot;insert&quot;: Insert only new records, ignore existing</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">            - &quot;update&quot;: Update only existing records, ignore new</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">            - &quot;full_merge&quot;: Insert, update, and delete (full sync with source)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a><span class="sd">            - &quot;deduplicate&quot;: Remove duplicates from source, then upsert</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">        dedup_order_by: Columns to use for ordering when deduplicating (for</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">            &quot;deduplicate&quot; strategy). Keeps record with highest value. If None,</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="sd">            uses first occurrence.</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">        compression: Compression codec for output. Default is &quot;snappy&quot;.</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">        progress_callback: Optional callback function for progress tracking.</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">            Called with (stage, current, total) where stage is a string description.</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="sd">        Dictionary with merge statistics:</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="sd">            - &quot;inserted&quot;: Number of records inserted</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a><span class="sd">            - &quot;updated&quot;: Number of records updated</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="sd">            - &quot;deleted&quot;: Number of records deleted</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">            - &quot;total&quot;: Total records in merged dataset</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">        ValueError: If strategy invalid, key columns missing, or NULL keys present.</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a><span class="sd">        TypeError: If source/target schemas incompatible.</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a><span class="sd">        Exception: If merge operation fails.</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a><span class="sd">        UPSERT - insert new and update existing:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a><span class="sd">        &gt;&gt;&gt; with DuckDBParquetHandler() as handler:</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a><span class="sd">        ...     stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a><span class="sd">        ...         source=new_data_table,</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a><span class="sd">        ...         target_path=&quot;/data/customers/&quot;,</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a><span class="sd">        ...         key_columns=[&quot;customer_id&quot;],</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="sd">        ...         strategy=&quot;upsert&quot;</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">        ...     )</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a><span class="sd">        ...     print(f&quot;Inserted: {stats[&#39;inserted&#39;]}, Updated: {stats[&#39;updated&#39;]}&quot;)</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="sd">        INSERT - add only new records:</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a><span class="sd">        ...     source=&quot;/staging/new_orders/&quot;,</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a><span class="sd">        ...     target_path=&quot;/data/orders/&quot;,</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="sd">        ...     key_columns=[&quot;order_id&quot;],</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">        ...     strategy=&quot;insert&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">        ... print(f&quot;Added {stats[&#39;inserted&#39;]} new orders&quot;)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">        UPDATE - update existing only:</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">        ...     source=product_updates,</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="sd">        ...     target_path=&quot;/data/products/&quot;,</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">        ...     key_columns=[&quot;product_id&quot;],</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        ...     strategy=&quot;update&quot;</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><span class="sd">        FULL_MERGE - complete synchronization:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">        ...     source=authoritative_data,</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="sd">        ...     target_path=&quot;/data/inventory/&quot;,</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">        ...     key_columns=[&quot;item_id&quot;],</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">        ...     strategy=&quot;full_merge&quot;</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        ... print(f&quot;Synced: +{stats[&#39;inserted&#39;]} -{stats[&#39;deleted&#39;]}&quot;)</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">        DEDUPLICATE - remove duplicates first:</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">        ...     source=raw_data_with_dups,</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">        ...     target_path=&quot;/data/transactions/&quot;,</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        ...     key_columns=[&quot;transaction_id&quot;],</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">        ...     strategy=&quot;deduplicate&quot;,</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        ...     dedup_order_by=[&quot;timestamp&quot;]  # Keep latest</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">        Composite key:</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">        &gt;&gt;&gt; stats = handler.merge_parquet_dataset(</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">        ...     source=updates,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">        ...     target_path=&quot;/data/sales/&quot;,</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="sd">        ...     key_columns=[&quot;customer_id&quot;, &quot;order_date&quot;],</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a><span class="sd">        ...     strategy=&quot;upsert&quot;</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">        This implementation uses shared merge validation and semantics from fsspeckit.core.merge</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">        to ensure consistent behavior across all backends. Atomic operations are performed using</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">        temporary directories with backup-and-restore for error recovery.</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>    <span class="c1"># Convert string strategy to core enum and validate</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="n">core_strategy</span> <span class="o">=</span> <span class="n">CoreMergeStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="n">valid_strategies</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">CoreMergeStrategy</span><span class="p">}</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid strategy: &#39;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&#39;. Must be one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">valid_strategies</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="c1"># Normalize key_columns using shared helper</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="n">normalized_keys</span> <span class="o">=</span> <span class="n">normalize_key_columns</span><span class="p">(</span><span class="n">key_columns</span><span class="p">)</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="c1"># Report progress start</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Loading source data&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="c1"># Load source data</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>        <span class="c1"># Source is path to parquet dataset</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>        <span class="n">source_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="c1"># Source is PyArrow table</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="n">source_table</span> <span class="o">=</span> <span class="n">source</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>    <span class="c1"># Report progress for source loading</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Loading target data&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>    <span class="c1"># Load target data (create empty if doesn&#39;t exist)</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>    <span class="n">target_schema</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>    <span class="n">target_table</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="n">target_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>        <span class="n">target_schema</span> <span class="o">=</span> <span class="n">target_table</span><span class="o">.</span><span class="n">schema</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>    <span class="c1"># Report progress for validation</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Validating inputs&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>    <span class="c1"># Validate inputs using shared helpers</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>    <span class="n">merge_plan</span> <span class="o">=</span> <span class="n">validate_merge_inputs</span><span class="p">(</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>        <span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">target_schema</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">,</span> <span class="n">core_strategy</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>    <span class="p">)</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>    <span class="n">merge_plan</span><span class="o">.</span><span class="n">source_count</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>    <span class="c1"># Validate strategy compatibility</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>    <span class="n">validate_strategy_compatibility</span><span class="p">(</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>        <span class="n">core_strategy</span><span class="p">,</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>    <span class="p">)</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>    <span class="c1"># Check for NULL keys using shared helper</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>    <span class="n">check_null_keys</span><span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">target_table</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>    <span class="c1"># Calculate pre-merge counts for statistics</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>    <span class="n">target_count_before</span> <span class="o">=</span> <span class="n">target_table</span><span class="o">.</span><span class="n">num_rows</span> <span class="k">if</span> <span class="n">target_table</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="c1"># Create empty target table if needed</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>    <span class="k">if</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>        <span class="n">target_table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>            <span class="p">{</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>                <span class="n">col</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="nb">type</span><span class="o">=</span><span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>            <span class="p">}</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>    <span class="c1"># Register tables in DuckDB</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;source_data&quot;</span><span class="p">,</span> <span class="n">source_table</span><span class="p">)</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;target_dataset&quot;</span><span class="p">,</span> <span class="n">target_table</span><span class="p">)</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>    <span class="c1"># Report progress for merge execution</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Executing merge strategy&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>    <span class="c1"># Configure DuckDB for optimal merge performance</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET memory_limit=&#39;1GB&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET threads=4&quot;</span><span class="p">)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>    <span class="c1"># Enable DuckDB&#39;s parallel processing for large datasets</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>    <span class="k">if</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET enable_progress_bar=true&quot;</span><span class="p">)</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET preserve_insertion_order=false&quot;</span><span class="p">)</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="c1"># Execute merge based on strategy</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>    <span class="n">merged_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_merge_strategy</span><span class="p">(</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>        <span class="n">conn</span><span class="p">,</span> <span class="n">core_strategy</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">,</span> <span class="n">dedup_order_by</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>    <span class="p">)</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>    <span class="c1"># Calculate statistics using shared helper</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>    <span class="n">merge_stats</span> <span class="o">=</span> <span class="n">calculate_merge_stats</span><span class="p">(</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="n">core_strategy</span><span class="p">,</span> <span class="n">source_count</span><span class="p">,</span> <span class="n">target_count_before</span><span class="p">,</span> <span class="n">merged_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>    <span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">merge_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>    <span class="c1"># Report progress for writing results</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Writing merged results&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>    <span class="c1"># Write merged result to temporary directory first, then move for atomicity</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;merge_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="n">temp_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;merged_dataset&quot;</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="n">temp_path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>        <span class="c1"># Write merged result to temporary location</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="n">merged_table</span><span class="p">,</span> <span class="n">temp_path_str</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>        <span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="c1"># Atomic move: if target exists, remove it first, then move temp data</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>            <span class="c1"># Make a backup in case something goes wrong</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>            <span class="n">backup_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">.backup.</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>                <span class="c1"># Rename existing target to backup</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>                <span class="c1"># Move temp data to final location</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">temp_path_str</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>                <span class="c1"># Remove backup after successful move</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>                <span class="c1"># Try to restore backup if move failed</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atomic merge failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>            <span class="c1"># No existing target, just move temp data</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">temp_path_str</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>    <span class="c1"># Cleanup</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;source_data&quot;</span><span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;target_dataset&quot;</span><span class="p">)</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;merged_result&quot;</span><span class="p">)</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>        <span class="k">pass</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.optimize_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.optimize_parquet_dataset</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.optimize_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">optimize_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Optimize a parquet dataset by clustering (approximate z-order) using shared planning.</p>
<p>This function delegates optimization planning to the shared core module,
ensuring consistent behavior across DuckDB and PyArrow backends.</p>
<p>Reads dataset, orders rows by given columns, optionally groups into sized chunks
similar to compaction, rewrites dataset (overwrite semantics). Supports dry-run.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset directory path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zorder_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to cluster by (must exist).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional desired size per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional desired row cap per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional compression codec for output files.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, plan only.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Statistics dict following canonical MaintenanceStats format; may include</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>planned grouping if dry-run=True.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates optimization planning and validation to the
shared <code>fsspeckit.core.maintenance.plan_optimize_groups</code> function,
ensuring consistent behavior with the PyArrow backend.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1200" name="__codelineno-0-1200"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize a parquet dataset by clustering (approximate z-order) using shared planning.</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a><span class="sd">    This function delegates optimization planning to the shared core module,</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a><span class="sd">    ensuring consistent behavior across DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a><span class="sd">    Reads dataset, orders rows by given columns, optionally groups into sized chunks</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a><span class="sd">    similar to compaction, rewrites dataset (overwrite semantics). Supports dry-run.</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a><span class="sd">        path: Dataset directory path.</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a><span class="sd">        zorder_columns: Columns to cluster by (must exist).</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a><span class="sd">        target_mb_per_file: Optional desired size per output file.</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a><span class="sd">        target_rows_per_file: Optional desired row cap per output file.</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a><span class="sd">        partition_filter: Optional list of partition prefixes.</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a><span class="sd">        compression: Optional compression codec for output files.</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a><span class="sd">        dry_run: If True, plan only.</span>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a><span class="sd">        Statistics dict following canonical MaintenanceStats format; may include</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a><span class="sd">        planned grouping if dry-run=True.</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a><span class="sd">        This function delegates optimization planning and validation to the</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a><span class="sd">        shared ``fsspeckit.core.maintenance.plan_optimize_groups`` function,</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a><span class="sd">        ensuring consistent behavior with the PyArrow backend.</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">plan_optimize_groups</span><span class="p">,</span> <span class="n">MaintenanceStats</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">zorder_columns</span><span class="p">:</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zorder_columns must be a non-empty list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Filesystem not initialized for optimization&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>    <span class="n">filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>    <span class="c1"># Get dataset stats using shared logic</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>    <span class="n">stats_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="p">)</span>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats_before</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>    <span class="c1"># Load a sample table to inspect schema for z-order validation</span>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>    <span class="n">sample_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>  <span class="c1"># first file</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>    <span class="c1"># Use shared optimization planning with schema validation</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>    <span class="n">plan_result</span> <span class="o">=</span> <span class="n">plan_optimize_groups</span><span class="p">(</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>        <span class="n">file_infos</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>        <span class="n">sample_schema</span><span class="o">=</span><span class="n">sample_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>    <span class="p">)</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>    <span class="c1"># Update planned stats with compression info</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>        <span class="k">return</span> <span class="n">planned_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>    <span class="c1"># Execute optimization using DuckDB</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>    <span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>    <span class="n">rewritten_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_quote_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>        <span class="n">escaped</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">escaped</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>    <span class="c1"># Helper function to build ORDER BY clause with NULL handling</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_order_clause</span><span class="p">(</span><span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>        <span class="n">order_parts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>            <span class="n">quoted</span> <span class="o">=</span> <span class="n">_quote_identifier</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>            <span class="c1"># Put NULLs last</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>            <span class="n">order_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">quoted</span><span class="si">}</span><span class="s2"> IS NULL) ASC&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>            <span class="n">order_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quoted</span><span class="si">}</span><span class="s2"> ASC&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_parts</span><span class="p">)</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>    <span class="n">order_clause</span> <span class="o">=</span> <span class="n">_build_order_clause</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">)</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a>    <span class="c1"># Process each group separately for more memory-efficient operation</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>    <span class="n">written_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>    <span class="k">for</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a>        <span class="c1"># Read group files and sort by z-order columns</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a>        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>        <span class="n">all_paths_sql</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM parquet_scan([</span><span class="si">{</span><span class="n">all_paths_sql</span><span class="si">}</span><span class="s2">]) ORDER BY </span><span class="si">{</span><span class="n">order_clause</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>        <span class="n">ordered_table</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ordered_table</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>            <span class="n">ordered_table</span> <span class="o">=</span> <span class="n">ordered_table</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>        <span class="c1"># Apply chunking within the group if needed</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>        <span class="k">if</span> <span class="n">target_rows_per_file</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>            <span class="c1"># Row-based splitting</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>            <span class="n">num_rows</span> <span class="o">=</span> <span class="n">ordered_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a>            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">target_rows_per_file</span><span class="p">):</span>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a>                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">target_rows_per_file</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">)</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>                <span class="n">chunk</span> <span class="o">=</span> <span class="n">ordered_table</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a>                <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a>                    <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a>            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ordered_table</span><span class="p">]</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>        <span class="c1"># Write optimized chunks</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>        <span class="k">for</span> <span class="n">chunk_idx</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>                <span class="c1"># Single group case - use simple naming</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;optimized-</span><span class="si">{</span><span class="n">chunk_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>                <span class="c1"># Multiple groups - include group index</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;optimized-</span><span class="si">{</span><span class="n">group_idx</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">chunk_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>            <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression_codec</span><span class="p">)</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>            <span class="n">written_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>        <span class="n">rewritten_bytes</span> <span class="o">+=</span> <span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>        <span class="c1"># Remove original files in this group</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>                <span class="n">filesystem</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>    <span class="c1"># Recompute stats after optimization</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_dataset_stats</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span><span class="p">)</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">compression_codec</span><span class="p">,</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>    <span class="p">)</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.read_parquet" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.read_parquet</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.read_parquet" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">read_parquet</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Read parquet file or dataset directory.</p>
<p>Reads a single parquet file or all parquet files in a directory and
returns the data as a PyArrow table. Supports column projection for
efficient reading of large datasets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to parquet file or directory containing parquet files.
Can be local path or remote URI (s3://, gs://, etc.).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of column names to read. If None, reads all columns.
Specifying columns improves performance for large datasets.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table containing the parquet data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified path does not exist.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DuckDB encounters an error reading the parquet file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Read entire parquet file:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Read with column selection:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/data.parquet&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
    <p>Read parquet dataset directory:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/path/to/dataset/&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Read from S3:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">AwsStorageOptions</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;s3://bucket/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_parquet</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read parquet file or dataset directory.</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">    Reads a single parquet file or all parquet files in a directory and</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    returns the data as a PyArrow table. Supports column projection for</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">    efficient reading of large datasets.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">        path: Path to parquet file or directory containing parquet files.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">            Can be local path or remote URI (s3://, gs://, etc.).</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">        columns: Optional list of column names to read. If None, reads all columns.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">            Specifying columns improves performance for large datasets.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        PyArrow table containing the parquet data.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        FileNotFoundError: If the specified path does not exist.</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        Exception: If DuckDB encounters an error reading the parquet file.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        Read entire parquet file:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;/path/to/data.parquet&quot;)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        Read with column selection:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;/path/to/data.parquet&quot;, columns=[&quot;col1&quot;, &quot;col2&quot;])</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        Read parquet dataset directory:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;/path/to/dataset/&quot;)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        Read from S3:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        &gt;&gt;&gt; from fsspeckit.storage_options import AwsStorageOptions</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler(storage_options=AwsStorageOptions(...))</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        &gt;&gt;&gt; table = handler.read_parquet(&quot;s3://bucket/data.parquet&quot;)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="c1"># Check if path exists before executing DuckDB query</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parquet path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="c1"># Build column selection clause</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">columns_clause</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="c1"># Build query to read parquet</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">columns_clause</span><span class="si">}</span><span class="s2"> FROM parquet_scan(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="c1"># Execute query and return as PyArrow table</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">arrow</span><span class="p">()</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="c1"># Convert RecordBatchReader to Table</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;read_all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="c1"># Preserve original error type and message when possible</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="s2">&quot;does not exist&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="ow">or</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="p">):</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="sa">f</span><span class="s2">&quot;Parquet path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="c1"># Re-raise with original exception type preserved</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to read parquet from &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.write_parquet" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.write_parquet</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.write_parquet" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_parquet</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write PyArrow table to parquet file.</p>
<p>Writes a PyArrow table to a parquet file with configurable compression.
Automatically creates parent directories if they don't exist.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table to write.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output path for parquet file. Can be local path or remote URI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec to use. Supported values: "snappy", "gzip",
"lz4", "zstd", "brotli", "uncompressed". Default is "snappy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;snappy&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If DuckDB encounters an error writing the parquet file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Write with default compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/output.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Write with gzip compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/output.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Write to nested directory:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/2024/01/15/data.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Write to S3:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">AwsStorageOptions</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;s3://bucket/output.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_parquet</span><span class="p">(</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write PyArrow table to parquet file.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    Writes a PyArrow table to a parquet file with configurable compression.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    Automatically creates parent directories if they don&#39;t exist.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        table: PyArrow table to write.</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        path: Output path for parquet file. Can be local path or remote URI.</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        compression: Compression codec to use. Supported values: &quot;snappy&quot;, &quot;gzip&quot;,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">            &quot;lz4&quot;, &quot;zstd&quot;, &quot;brotli&quot;, &quot;uncompressed&quot;. Default is &quot;snappy&quot;.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        Exception: If DuckDB encounters an error writing the parquet file.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        Write with default compression:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        &gt;&gt;&gt; import pyarrow as pa</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        &gt;&gt;&gt; table = pa.table({&#39;a&#39;: [1, 2, 3], &#39;b&#39;: [&#39;x&#39;, &#39;y&#39;, &#39;z&#39;]})</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler()</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;/tmp/output.parquet&quot;)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        Write with gzip compression:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;/tmp/output.parquet&quot;, compression=&quot;gzip&quot;)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        Write to nested directory:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;/tmp/2024/01/15/data.parquet&quot;)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        Write to S3:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        &gt;&gt;&gt; from fsspeckit.storage_options import AwsStorageOptions</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler(storage_options=AwsStorageOptions(...))</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet(table, &quot;s3://bucket/output.parquet&quot;)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="c1"># Ensure parent directory exists and is not a file</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="n">parent_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="c1"># Check if parent path exists and is a file (not directory)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">parent_path</span><span class="p">):</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">parent_path</span><span class="p">):</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                    <span class="sa">f</span><span class="s2">&quot;Parent directory &#39;</span><span class="si">{</span><span class="n">parent_path</span><span class="si">}</span><span class="s2">&#39; exists but is a file. Cannot create file &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">parent_path</span><span class="p">):</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">parent_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="c1"># Some filesystems may not support exists/makedirs on remote paths</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="c1"># DuckDB will handle the path directly</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="k">pass</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="c1"># Register the table in DuckDB</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="c1"># Use COPY command to write parquet</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COPY temp_table TO &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; (FORMAT PARQUET, COMPRESSION &#39;</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="c1"># Unregister the temporary table</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="c1"># Clean up on error</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="k">pass</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write parquet to &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="fsspeckit.datasets.duckdb.DuckDBParquetHandler.write_parquet_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.duckdb.DuckDBParquetHandler.write_parquet_dataset</span>


<a href="#fsspeckit.datasets.duckdb.DuckDBParquetHandler.write_parquet_dataset" class="headerlink" title="Permanent link">&para;</a></h8>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">mode</span><span class="p">:</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">max_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">basename_template</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">=</span> <span class="s2">&quot;part-</span><span class="si">{}</span><span class="s2">.parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Write PyArrow table to parquet dataset directory with unique filenames.</p>
<p>Writes a PyArrow table to a directory as one or more parquet files with
automatically generated unique filenames. Supports overwrite and append modes
for managing existing datasets, and can split large tables across multiple files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow table to write.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output directory path for the dataset. Can be local or remote URI.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;overwrite&#39;, &#39;append&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Write mode. "append" (default) adds files without deleting existing ones.
"overwrite" deletes existing parquet files before writing.</p>
              </div>
            </td>
            <td>
                  <code>&#39;append&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional maximum rows per file. If specified and table
has more rows, splits into multiple files. If None, writes single file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec. Supported: "snappy", "gzip", "lz4", "zstd",
"brotli", "uncompressed". Default is "snappy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;snappy&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>basename_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template for filenames with {} placeholder for unique ID.
Default is "part-{}.parquet". The {} will be replaced with a short UUID.</p>
              </div>
            </td>
            <td>
                  <code>&#39;part-{}.parquet&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If mode is invalid or max_rows_per_file &lt;= 0.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If filesystem operations or writing fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic dataset write with unique filename:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">DuckDBParquetHandler</span><span class="p">()</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;/tmp/dataset/&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="c1"># Creates: /tmp/dataset/part-a1b2c3d4.parquet</span>
</code></pre></div></td></tr></table></div>
    <p>Append mode (incremental updates):</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># First write</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table1</span><span class="p">,</span> <span class="s2">&quot;/data/sales/&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Second write (adds new file)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table2</span><span class="p">,</span> <span class="s2">&quot;/data/sales/&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Read combined dataset</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;/data/sales/&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Overwrite mode (replace dataset):</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">new_table</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span>  <span class="c1"># Deletes existing parquet files</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Split large table across multiple files:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">large_table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">table</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)})</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="n">large_table</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span>    <span class="n">max_rows_per_file</span><span class="o">=</span><span class="mi">2500</span>  <span class="c1"># Creates 4 files</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Custom filename template:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">table</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">basename_template</span><span class="o">=</span><span class="s2">&quot;data_</span><span class="si">{}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="gp">... </span><span class="c1"># Creates: data_a1b2c3d4.parquet</span>
</code></pre></div></td></tr></table></div>
    <p>With compression:</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">... </span>    <span class="n">table</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">... </span>    <span class="s2">&quot;/data/output/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="gp">... </span>    <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="gp">... </span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
    <p>Remote storage (S3):</p>
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.storage_options</span><span class="w"> </span><span class="kn">import</span> <span class="n">AwsStorageOptions</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span> <span class="o">=</span> <span class="n">DuckDBParquetHandler</span><span class="p">(</span><span class="n">storage_options</span><span class="o">=</span><span class="n">AwsStorageOptions</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">handler</span><span class="o">.</span><span class="n">write_parquet_dataset</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;s3://bucket/dataset/&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/duckdb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="k">def</span><span class="w"> </span><span class="nf">write_parquet_dataset</span><span class="p">(</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">max_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">basename_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;part-</span><span class="si">{}</span><span class="s2">.parquet&quot;</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Write PyArrow table to parquet dataset directory with unique filenames.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    Writes a PyArrow table to a directory as one or more parquet files with</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">    automatically generated unique filenames. Supports overwrite and append modes</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">    for managing existing datasets, and can split large tables across multiple files.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">        table: PyArrow table to write.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">        path: Output directory path for the dataset. Can be local or remote URI.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">        mode: Write mode. &quot;append&quot; (default) adds files without deleting existing ones.</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">            &quot;overwrite&quot; deletes existing parquet files before writing.</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">        max_rows_per_file: Optional maximum rows per file. If specified and table</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">            has more rows, splits into multiple files. If None, writes single file.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        compression: Compression codec. Supported: &quot;snappy&quot;, &quot;gzip&quot;, &quot;lz4&quot;, &quot;zstd&quot;,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">            &quot;brotli&quot;, &quot;uncompressed&quot;. Default is &quot;snappy&quot;.</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        basename_template: Template for filenames with {} placeholder for unique ID.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">            Default is &quot;part-{}.parquet&quot;. The {} will be replaced with a short UUID.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        ValueError: If mode is invalid or max_rows_per_file &lt;= 0.</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        Exception: If filesystem operations or writing fails.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    Examples:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        Basic dataset write with unique filename:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        &gt;&gt;&gt; import pyarrow as pa</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        &gt;&gt;&gt; table = pa.table({&#39;a&#39;: [1, 2, 3], &#39;b&#39;: [&#39;x&#39;, &#39;y&#39;, &#39;z&#39;]})</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">        &gt;&gt;&gt; with DuckDBParquetHandler() as handler:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        ...     handler.write_parquet_dataset(table, &quot;/tmp/dataset/&quot;)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        ...     # Creates: /tmp/dataset/part-a1b2c3d4.parquet</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">        Append mode (incremental updates):</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">        &gt;&gt;&gt; # First write</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(table1, &quot;/data/sales/&quot;, mode=&quot;append&quot;)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        &gt;&gt;&gt; # Second write (adds new file)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(table2, &quot;/data/sales/&quot;, mode=&quot;append&quot;)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        &gt;&gt;&gt; # Read combined dataset</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">        &gt;&gt;&gt; result = handler.read_parquet(&quot;/data/sales/&quot;)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        Overwrite mode (replace dataset):</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        ...     new_table,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        ...     mode=&quot;overwrite&quot;  # Deletes existing parquet files</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">        Split large table across multiple files:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        &gt;&gt;&gt; large_table = pa.table({&#39;id&#39;: range(10000), &#39;value&#39;: range(10000)})</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        ...     large_table,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        ...     max_rows_per_file=2500  # Creates 4 files</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        Custom filename template:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">        ...     table,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">        ...     basename_template=&quot;data_{}.parquet&quot;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">        ... # Creates: data_a1b2c3d4.parquet</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        With compression:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">        ...     table,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">        ...     &quot;/data/output/&quot;,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        ...     compression=&quot;gzip&quot;</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        Remote storage (S3):</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">        &gt;&gt;&gt; from fsspeckit.storage_options import AwsStorageOptions</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        &gt;&gt;&gt; handler = DuckDBParquetHandler(storage_options=AwsStorageOptions(...))</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        &gt;&gt;&gt; handler.write_parquet_dataset(table, &quot;s3://bucket/dataset/&quot;)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>    <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">):</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid mode: &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;overwrite&#39; or &#39;append&#39;.&quot;</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="k">if</span> <span class="n">max_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_rows_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_rows_per_file must be &gt; 0, got </span><span class="si">{</span><span class="n">max_rows_per_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connection</span><span class="p">()</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="c1"># Ensure directory exists</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="c1"># Check if path exists and is a file (not directory)</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                    <span class="sa">f</span><span class="s2">&quot;Dataset path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; exists but is a file. Dataset paths must be directories.&quot;</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                <span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_filesystem</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to create dataset directory &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="c1"># Handle overwrite mode - clear existing parquet files</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="c1"># Determine how many files to write</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="k">if</span> <span class="n">max_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="n">max_rows_per_file</span><span class="p">:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="c1"># Split table into multiple files</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="n">num_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">+</span> <span class="n">max_rows_per_file</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_rows_per_file</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_files</span><span class="p">):</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">max_rows_per_file</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_rows_per_file</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">slice_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="c1"># Generate unique filename</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_filename</span><span class="p">(</span><span class="n">basename_template</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="c1"># Write slice to file</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">,</span> <span class="n">slice_table</span><span class="p">)</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COPY temp_table TO &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; (FORMAT PARQUET, COMPRESSION &#39;</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                    <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to write parquet file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="c1"># Write single file</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_filename</span><span class="p">(</span><span class="n">basename_template</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;COPY temp_table TO &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; (FORMAT PARQUET, COMPRESSION &#39;</span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="s2">&quot;temp_table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                <span class="k">pass</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to write parquet file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h5 id="fsspeckit.datasets.duckdb-functions">Functions<a href="#fsspeckit.datasets.duckdb-functions" class="headerlink" title="Permanent link">&para;</a></h5>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="fsspeckit.datasets.pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">fsspeckit.datasets.pyarrow</span>


<a href="#fsspeckit.datasets.pyarrow" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">







<h5 id="fsspeckit.datasets.pyarrow-classes">Classes<a href="#fsspeckit.datasets.pyarrow-classes" class="headerlink" title="Permanent link">&para;</a></h5>
<h5 id="fsspeckit.datasets.pyarrow-functions">Functions<a href="#fsspeckit.datasets.pyarrow-functions" class="headerlink" title="Permanent link">&para;</a></h5>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.cast_schema" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.cast_schema</span>


<a href="#fsspeckit.datasets.pyarrow.cast_schema" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">cast_schema</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cast a PyArrow table to a given schema, updating the schema to match the table's columns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow table to cast.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The target schema to cast the table to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Table: A new PyArrow table with the specified schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1550" name="__codelineno-0-1550"></a><span class="k">def</span><span class="w"> </span><span class="nf">cast_schema</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a><span class="sd">    Cast a PyArrow table to a given schema, updating the schema to match the table&#39;s columns.</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a><span class="sd">        table (pa.Table): The PyArrow table to cast.</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a><span class="sd">        schema (pa.Schema): The target schema to cast the table to.</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a><span class="sd">        pa.Table: A new PyArrow table with the specified schema.</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>    <span class="n">table_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">:</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>                <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">nulls</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>            <span class="p">)</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.collect_dataset_stats_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.collect_dataset_stats_pyarrow</span>


<a href="#fsspeckit.datasets.pyarrow.collect_dataset_stats_pyarrow" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Collect file-level statistics for a parquet dataset using shared core logic.</p>
<p>This function delegates to the shared <code>fsspeckit.core.maintenance.collect_dataset_stats</code>
function, ensuring consistent dataset discovery and statistics across both DuckDB
and PyArrow backends.</p>
<p>The helper walks the given dataset directory on the provided filesystem,
discovers parquet files (recursively), and returns basic statistics:</p>
<ul>
<li>Per-file path, size in bytes, and number of rows</li>
<li>Aggregated total bytes and total rows</li>
</ul>
<p>The function is intentionally streaming/metadata-driven and never
materializes the full dataset as a single :class:<code>pyarrow.Table</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Root directory of the parquet dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional fsspec filesystem. If omitted, a local "file"
filesystem is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefix filters
(e.g. ["date=2025-11-04"]). Only files whose path relative to
<code>path</code> starts with one of these prefixes are included.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with keys:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>files</code>: list of <code>{"path", "size_bytes", "num_rows"}</code> dicts</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>total_bytes</code>: sum of file sizes</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>total_rows</code>: sum of row counts</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist or no parquet files
match the optional partition filter.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This is a thin wrapper around the shared core function. See
:func:<code>fsspeckit.core.maintenance.collect_dataset_stats</code> for the
authoritative implementation.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect file-level statistics for a parquet dataset using shared core logic.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    This function delegates to the shared ``fsspeckit.core.maintenance.collect_dataset_stats``</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    function, ensuring consistent dataset discovery and statistics across both DuckDB</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    and PyArrow backends.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    The helper walks the given dataset directory on the provided filesystem,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    discovers parquet files (recursively), and returns basic statistics:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    - Per-file path, size in bytes, and number of rows</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    - Aggregated total bytes and total rows</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    The function is intentionally streaming/metadata-driven and never</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    materializes the full dataset as a single :class:`pyarrow.Table`.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        path: Root directory of the parquet dataset.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        filesystem: Optional fsspec filesystem. If omitted, a local &quot;file&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            filesystem is used.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        partition_filter: Optional list of partition prefix filters</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            (e.g. [&quot;date=2025-11-04&quot;]). Only files whose path relative to</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            ``path`` starts with one of these prefixes are included.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        Dict with keys:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        - ``files``: list of ``{&quot;path&quot;, &quot;size_bytes&quot;, &quot;num_rows&quot;}`` dicts</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        - ``total_bytes``: sum of file sizes</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        - ``total_rows``: sum of row counts</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        FileNotFoundError: If the path does not exist or no parquet files</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            match the optional partition filter.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        This is a thin wrapper around the shared core function. See</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        :func:`fsspeckit.core.maintenance.collect_dataset_stats` for the</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        authoritative implementation.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">collect_dataset_stats</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="k">return</span> <span class="n">collect_dataset_stats</span><span class="p">(</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.compact_parquet_dataset_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.compact_parquet_dataset_pyarrow</span>


<a href="#fsspeckit.datasets.pyarrow.compact_parquet_dataset_pyarrow" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">compact_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compact a parquet dataset directory into fewer larger files using PyArrow and shared planning.</p>
<p>Groups small files based on size (MB) and/or row thresholds, rewrites grouped
files into new parquet files, and optionally changes compression. Supports a
dry-run mode that returns the compaction plan without modifying files.</p>
<p>The implementation uses the shared core planning algorithm for consistent
behavior across backends. It processes data in a group-based, streaming fashion:
it reads only the files in a given group into memory when processing that group
and never materializes the entire dataset as a single table.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset root directory (local path or fsspec URL).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max output size per file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max rows per output file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes (e.g. <code>["date=2025-11-15"]</code>)
used to limit both stats collection and rewrites to matching paths.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parquet compression codec; defaults to <code>"snappy"</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When <code>True</code> the function returns a plan + before/after stats
without reading or writing any parquet data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional <code>fsspec.AbstractFileSystem</code> to reuse existing FS clients.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A stats dictionary describing before/after file counts, total bytes,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>rewritten bytes, and optional <code>planned_groups</code> when <code>dry_run</code> is enabled.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The structure follows the canonical <code>MaintenanceStats</code> format from the shared core.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If thresholds are invalid or no files match partition filter.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>result = compact_parquet_dataset_pyarrow(
...     "/path/to/dataset",
...     target_mb_per_file=64,
...     dry_run=True
... )
print(f"Files before: {result['before_file_count']}")
print(f"Files after: {result['after_file_count']}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates dataset discovery and compaction planning to the
shared <code>fsspeckit.core.maintenance</code> module, ensuring consistent behavior
across DuckDB and PyArrow backends.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="k">def</span><span class="w"> </span><span class="nf">compact_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compact a parquet dataset directory into fewer larger files using PyArrow and shared planning.</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    Groups small files based on size (MB) and/or row thresholds, rewrites grouped</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    files into new parquet files, and optionally changes compression. Supports a</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    dry-run mode that returns the compaction plan without modifying files.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    The implementation uses the shared core planning algorithm for consistent</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    behavior across backends. It processes data in a group-based, streaming fashion:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    it reads only the files in a given group into memory when processing that group</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    and never materializes the entire dataset as a single table.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        path: Dataset root directory (local path or fsspec URL).</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        target_mb_per_file: Optional max output size per file; must be &gt; 0.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        target_rows_per_file: Optional max rows per output file; must be &gt; 0.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        partition_filter: Optional list of partition prefixes (e.g. ``[&quot;date=2025-11-15&quot;]``)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">            used to limit both stats collection and rewrites to matching paths.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        compression: Optional parquet compression codec; defaults to ``&quot;snappy&quot;``.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        dry_run: When ``True`` the function returns a plan + before/after stats</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">            without reading or writing any parquet data.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        filesystem: Optional ``fsspec.AbstractFileSystem`` to reuse existing FS clients.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        A stats dictionary describing before/after file counts, total bytes,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        rewritten bytes, and optional ``planned_groups`` when ``dry_run`` is enabled.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">        The structure follows the canonical ``MaintenanceStats`` format from the shared core.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        ValueError: If thresholds are invalid or no files match partition filter.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        FileNotFoundError: If the path does not exist.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        &gt;&gt;&gt; result = compact_parquet_dataset_pyarrow(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        ...     &quot;/path/to/dataset&quot;,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        ...     target_mb_per_file=64,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        ...     dry_run=True</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        ... )</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        &gt;&gt;&gt; print(f&quot;Files before: {result[&#39;before_file_count&#39;]}&quot;)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        &gt;&gt;&gt; print(f&quot;Files after: {result[&#39;after_file_count&#39;]}&quot;)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        This function delegates dataset discovery and compaction planning to the</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        shared ``fsspeckit.core.maintenance`` module, ensuring consistent behavior</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        across DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">plan_compaction_groups</span><span class="p">,</span> <span class="n">MaintenanceStats</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="c1"># Get dataset stats using shared logic</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="c1"># Use shared compaction planning</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">plan_result</span> <span class="o">=</span> <span class="n">plan_compaction_groups</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">file_infos</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">plan_result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="c1"># Update planned stats with compression info</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">compression_codec</span> <span class="o">=</span> <span class="n">compression</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">planned_stats</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">return</span> <span class="n">planned_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="c1"># Execute compaction using PyArrow</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span> <span class="ow">or</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">codec</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">rewritten_bytes_live</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="c1"># Process each group: read, concatenate, write a new file, then delete</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1"># originals for that group. This ensures peak memory is bounded by the</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="c1"># group size.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">for</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">promote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">out_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;compact-</span><span class="si">{</span><span class="n">group_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">codec</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">rewritten_bytes_live</span> <span class="o">+=</span> <span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="c1"># Remove original files in this group</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="c1"># Best-effort cleanup; leave a warning to the caller.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: failed to delete &#39;</span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; after compaction&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="c1"># Recompute stats after compaction for the affected subset.</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes_live</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">codec</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.convert_large_types_to_normal" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.convert_large_types_to_normal</span>


<a href="#fsspeckit.datasets.pyarrow.convert_large_types_to_normal" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">convert_large_types_to_normal</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert large types in a PyArrow schema to their standard types.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow schema to convert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Schema: A new PyArrow schema with large types converted to standard types.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="k">def</span><span class="w"> </span><span class="nf">convert_large_types_to_normal</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">:</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="sd">    Convert large types in a PyArrow schema to their standard types.</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a><span class="sd">        schema (pa.Schema): The PyArrow schema to convert.</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a><span class="sd">        pa.Schema: A new PyArrow schema with large types converted to standard types.</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>    <span class="c1"># Define mapping of large types to standard types</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>    <span class="n">type_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_string</span><span class="p">():</span> <span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">(),</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_binary</span><span class="p">():</span> <span class="n">pa</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_utf8</span><span class="p">():</span> <span class="n">pa</span><span class="o">.</span><span class="n">utf8</span><span class="p">(),</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_list</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()):</span> <span class="n">pa</span><span class="o">.</span><span class="n">list_</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()),</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>        <span class="n">pa</span><span class="o">.</span><span class="n">large_list_view</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()):</span> <span class="n">pa</span><span class="o">.</span><span class="n">list_view</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">null</span><span class="p">()),</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="p">}</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="c1"># Convert fields</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>    <span class="n">new_fields</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>        <span class="n">field_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>        <span class="c1"># Check if type exists in mapping</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="k">if</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="n">type_mapping</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>            <span class="n">new_field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                <span class="nb">type</span><span class="o">=</span><span class="n">type_mapping</span><span class="p">[</span><span class="n">field_type</span><span class="p">],</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>                <span class="n">nullable</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>            <span class="p">)</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>        <span class="c1"># Handle large lists with nested types</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">LargeListType</span><span class="p">):</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>            <span class="n">new_field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>                <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">list_</span><span class="p">(</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                    <span class="n">type_mapping</span><span class="p">[</span><span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">]</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                    <span class="k">if</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span> <span class="ow">in</span> <span class="n">type_mapping</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                    <span class="k">else</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                <span class="p">),</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                <span class="n">nullable</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>            <span class="p">)</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>        <span class="c1"># Handle dictionary with large_string, large_utf8, or large_binary values</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">DictionaryType</span><span class="p">):</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>            <span class="n">new_field</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">dictionary</span><span class="p">(</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                    <span class="n">field_type</span><span class="o">.</span><span class="n">index_type</span><span class="p">,</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>                    <span class="n">type_mapping</span><span class="p">[</span><span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">]</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>                    <span class="k">if</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span> <span class="ow">in</span> <span class="n">type_mapping</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>                    <span class="k">else</span> <span class="n">field_type</span><span class="o">.</span><span class="n">value_type</span><span class="p">,</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>                    <span class="n">field_type</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>                <span class="p">),</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>                <span class="c1"># nullable=field.nullable,</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>                <span class="n">metadata</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>            <span class="p">)</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>            <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>    <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.dominant_timezone_per_column" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.dominant_timezone_per_column</span>


<a href="#fsspeckit.datasets.pyarrow.dominant_timezone_per_column" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">dominant_timezone_per_column</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="tuple">tuple</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>For each timestamp column (by name) across all schemas, detect the most frequent timezone (including None).
If None and a timezone are tied, prefer the timezone.
Returns a dict: {column_name: dominant_timezone}</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-842" name="__codelineno-0-842"></a><span class="k">def</span><span class="w"> </span><span class="nf">dominant_timezone_per_column</span><span class="p">(</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">],</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]]:</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a><span class="sd">    For each timestamp column (by name) across all schemas, detect the most frequent timezone (including None).</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a><span class="sd">    If None and a timezone are tied, prefer the timezone.</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a><span class="sd">    Returns a dict: {column_name: dominant_timezone}</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>    <span class="n">tz_counts</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Counter</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>    <span class="n">units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>    <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>            <span class="k">if</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_timestamp</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>                <span class="n">tz</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tz</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>                <span class="n">tz_counts</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">tz</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>                <span class="c1"># Track unit for each column (assume consistent)</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>                    <span class="n">units</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">unit</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>    <span class="n">dominant</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">counter</span> <span class="ow">in</span> <span class="n">tz_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>        <span class="n">most_common</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">most_common</span><span class="p">:</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>            <span class="k">continue</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>        <span class="n">top_count</span> <span class="o">=</span> <span class="n">most_common</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>        <span class="c1"># Find all with top_count</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>        <span class="n">top_tzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tz</span> <span class="k">for</span> <span class="n">tz</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">most_common</span> <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="n">top_count</span><span class="p">]</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>        <span class="c1"># If tie and one is not None, prefer not-None</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_tzs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">tz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tz</span> <span class="ow">in</span> <span class="n">top_tzs</span><span class="p">):</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>            <span class="n">tz</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tz</span> <span class="k">for</span> <span class="n">tz</span> <span class="ow">in</span> <span class="n">top_tzs</span> <span class="k">if</span> <span class="n">tz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="n">tz</span> <span class="o">=</span> <span class="n">most_common</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>        <span class="n">dominant</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">tz</span><span class="p">)</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>    <span class="k">return</span> <span class="n">dominant</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.merge_parquet_dataset_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.merge_parquet_dataset_pyarrow</span>


<a href="#fsspeckit.datasets.pyarrow.merge_parquet_dataset_pyarrow" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">merge_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">source</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span> <span class="o">|</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">key_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n"><span title="typing.Literal">Literal</span></span><span class="p">[</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="s2">&quot;insert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="s2">&quot;update&quot;</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="s2">&quot;full_merge&quot;</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="s2">&quot;deduplicate&quot;</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">dedup_order_by</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">batch_rows</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">progress_callback</span><span class="p">:</span> <span class="n"><span title="typing.Callable">Callable</span></span><span class="p">[[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="int">int</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Merge a source table/dataset into a parquet dataset using PyArrow only.</p>
<p>This function provides the same merge semantics as DuckDBParquetHandler.merge_parquet_dataset
but executes entirely with PyArrow datasets, scanners, and compute filters. It uses
shared merge semantics and validation for consistent behavior across backends.</p>
<p>The function streams both the source and target datasets in manageable batches and never
calls <code>dataset.to_table()</code> on the entire target without a filter, ensuring memory efficiency
for large datasets.</p>
<p>All merge strategies (UPSERT, INSERT, UPDATE, FULL_MERGE, DEDUPLICATE) share the same
semantics and validation rules across both DuckDB and PyArrow backends.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span> | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source data as PyArrow table or path to parquet dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to target parquet dataset directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to use for matching records. Can be single column
name (string) or list of column names for composite keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;upsert&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;full_merge&#39;, &#39;deduplicate&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Merge strategy to use:
- "upsert": Insert new records, update existing (default)
- "insert": Insert only new records, ignore existing
- "update": Update only existing records, ignore new
- "full_merge": Insert, update, and delete (full sync with source)
- "deduplicate": Remove duplicates from source, then upsert</p>
              </div>
            </td>
            <td>
                  <code>&#39;upsert&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dedup_order_by</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Columns to use for ordering when deduplicating (for
"deduplicate" strategy). Keeps record with highest value. If None,
uses key columns.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec for output files.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Filesystem to use for operations. If None, uses local filesystem.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_rows</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rows to process in each batch for streaming operations.</p>
              </div>
            </td>
            <td>
                  <code>10000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>progress_callback</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>, <span title="int">int</span>, <span title="int">int</span>], None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callback function for progress tracking.
Called with (stage, current, total) where stage is a string description.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with merge statistics:
- "inserted": Number of records inserted
- "updated": Number of records updated
- "deleted": Number of records deleted
- "total": Total records in merged dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If strategy invalid, key columns missing, or NULL keys present.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If source/target schemas incompatible.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If merge operation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This implementation uses shared merge validation and semantics from fsspeckit.core.merge
to ensure consistent behavior across all backends.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="n">source</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="n">key_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;upsert&quot;</span><span class="p">,</span> <span class="s2">&quot;insert&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;full_merge&quot;</span><span class="p">,</span> <span class="s2">&quot;deduplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upsert&quot;</span><span class="p">,</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>    <span class="n">dedup_order_by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>    <span class="n">batch_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge a source table/dataset into a parquet dataset using PyArrow only.</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="sd">    This function provides the same merge semantics as DuckDBParquetHandler.merge_parquet_dataset</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">    but executes entirely with PyArrow datasets, scanners, and compute filters. It uses</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">    shared merge semantics and validation for consistent behavior across backends.</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">    The function streams both the source and target datasets in manageable batches and never</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">    calls ``dataset.to_table()`` on the entire target without a filter, ensuring memory efficiency</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="sd">    for large datasets.</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a><span class="sd">    All merge strategies (UPSERT, INSERT, UPDATE, FULL_MERGE, DEDUPLICATE) share the same</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">    semantics and validation rules across both DuckDB and PyArrow backends.</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="sd">        source: Source data as PyArrow table or path to parquet dataset.</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="sd">        target_path: Path to target parquet dataset directory.</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a><span class="sd">        key_columns: Column(s) to use for matching records. Can be single column</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="sd">            name (string) or list of column names for composite keys.</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="sd">        strategy: Merge strategy to use:</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">            - &quot;upsert&quot;: Insert new records, update existing (default)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><span class="sd">            - &quot;insert&quot;: Insert only new records, ignore existing</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">            - &quot;update&quot;: Update only existing records, ignore new</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">            - &quot;full_merge&quot;: Insert, update, and delete (full sync with source)</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="sd">            - &quot;deduplicate&quot;: Remove duplicates from source, then upsert</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="sd">        dedup_order_by: Columns to use for ordering when deduplicating (for</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a><span class="sd">            &quot;deduplicate&quot; strategy). Keeps record with highest value. If None,</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">            uses key columns.</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">        compression: Compression codec for output files.</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">        filesystem: Filesystem to use for operations. If None, uses local filesystem.</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a><span class="sd">        batch_rows: Number of rows to process in each batch for streaming operations.</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">        progress_callback: Optional callback function for progress tracking.</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">            Called with (stage, current, total) where stage is a string description.</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        Dictionary with merge statistics:</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">            - &quot;inserted&quot;: Number of records inserted</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">            - &quot;updated&quot;: Number of records updated</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">            - &quot;deleted&quot;: Number of records deleted</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">            - &quot;total&quot;: Total records in merged dataset</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">        ValueError: If strategy invalid, key columns missing, or NULL keys present.</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="sd">        TypeError: If source/target schemas incompatible.</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">        Exception: If merge operation fails.</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a><span class="sd">        This implementation uses shared merge validation and semantics from fsspeckit.core.merge</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">        to ensure consistent behavior across all backends.</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>    <span class="c1"># Convert strategy and validate using shared helpers</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>        <span class="n">core_strategy</span> <span class="o">=</span> <span class="n">CoreMergeStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="n">valid_strategies</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">CoreMergeStrategy</span><span class="p">}</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid strategy &#39;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&#39;. Supported: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">valid_strategies</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>    <span class="c1"># Normalize key columns using shared helper</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>    <span class="n">normalized_keys</span> <span class="o">=</span> <span class="n">normalize_key_columns</span><span class="p">(</span><span class="n">key_columns</span><span class="p">)</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span> <span class="ow">or</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>    <span class="n">arrow_fs</span> <span class="o">=</span> <span class="n">_ensure_pyarrow_filesystem</span><span class="p">(</span><span class="n">filesystem</span><span class="p">)</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>    <span class="c1"># Report progress start</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Loading source data&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>    <span class="n">source_table</span> <span class="o">=</span> <span class="n">_load_source_table_pyarrow</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">arrow_fs</span><span class="p">)</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="c1"># Report progress for target loading</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Loading target data&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>    <span class="n">target_dataset</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="n">target_dataset</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">arrow_fs</span><span class="p">)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ArrowInvalid</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>        <span class="n">target_dataset</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>    <span class="k">if</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>        <span class="n">total_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="k">if</span> <span class="n">target_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>                <span class="n">total_rows</span> <span class="o">=</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">count_rows</span><span class="p">()</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>                <span class="n">total_rows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">num_rows</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">scanner</span><span class="p">()</span><span class="o">.</span><span class="n">to_batches</span><span class="p">())</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;full_merge&quot;</span> <span class="ow">and</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>            <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>            <span class="n">fs</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;inserted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_rows</span><span class="p">}</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="c1"># Report progress for validation</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Validating inputs&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="c1"># Validate using shared helpers</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>    <span class="n">target_schema</span> <span class="o">=</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">schema</span> <span class="k">if</span> <span class="n">target_dataset</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>    <span class="n">merge_plan</span> <span class="o">=</span> <span class="n">validate_merge_inputs</span><span class="p">(</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>        <span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">target_schema</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">,</span> <span class="n">core_strategy</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>    <span class="p">)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>    <span class="n">merge_plan</span><span class="o">.</span><span class="n">source_count</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>    <span class="c1"># Validate strategy compatibility</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>    <span class="n">validate_strategy_compatibility</span><span class="p">(</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>        <span class="n">core_strategy</span><span class="p">,</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">target_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>    <span class="p">)</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>    <span class="c1"># Check for NULL keys using shared helper</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="n">check_null_keys</span><span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">)</span>  <span class="c1"># We&#39;ll check target dataset during streaming</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>    <span class="c1"># Unify schemas for compatibility</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>    <span class="n">schemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_table</span><span class="o">.</span><span class="n">schema</span><span class="p">]</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>    <span class="k">if</span> <span class="n">target_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="n">schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_dataset</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>    <span class="n">unified_schema</span> <span class="o">=</span> <span class="n">unify_schemas</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>    <span class="n">source_table</span> <span class="o">=</span> <span class="n">cast_schema</span><span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">unified_schema</span><span class="p">)</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="k">if</span> <span class="n">core_strategy</span> <span class="o">==</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">DEDUPLICATE</span><span class="p">:</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="k">if</span> <span class="n">dedup_order_by</span><span class="p">:</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>            <span class="n">sort_keys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">column</span><span class="p">,</span> <span class="s2">&quot;descending&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">dedup_order_by</span><span class="p">]</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>            <span class="n">source_table</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">sort_keys</span><span class="p">)</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="n">seen_keys</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>        <span class="n">key_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_table</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">to_pylist</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">normalized_keys</span><span class="p">]</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="n">dedup_keep_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>        <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">):</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">key_arrays</span><span class="p">)</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">seen_keys</span><span class="p">:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>                <span class="k">continue</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>            <span class="n">seen_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>            <span class="n">dedup_keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_idx</span><span class="p">)</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="k">if</span> <span class="n">dedup_keep_indices</span><span class="p">:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>            <span class="n">source_table</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dedup_keep_indices</span><span class="p">))</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>    <span class="c1"># Report progress for merge execution</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Executing merge strategy&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="c1"># Touch the target via filtered scanners to comply with the streaming spec.</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="k">if</span> <span class="n">target_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">_iter_table_slices</span><span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">batch_rows</span><span class="p">):</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>            <span class="n">filter_expression</span> <span class="o">=</span> <span class="n">_build_filter_expression</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">normalized_keys</span><span class="p">)</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>            <span class="k">if</span> <span class="n">filter_expression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>                <span class="k">continue</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>            <span class="n">scanner</span> <span class="o">=</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">scanner</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">filter_expression</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">normalized_keys</span><span class="p">)</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">scanner</span><span class="o">.</span><span class="n">to_batches</span><span class="p">():</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>                <span class="c1"># Consume batches to ensure the filtered scan executes.</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>                <span class="k">pass</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>    <span class="n">source_key_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_table</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">to_pylist</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">normalized_keys</span><span class="p">]</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>    <span class="n">source_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>    <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">):</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">source_key_arrays</span><span class="p">)</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="n">source_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_idx</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>    <span class="n">processed_source_indices</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>    <span class="n">output_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inserted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>    <span class="k">if</span> <span class="n">target_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>        <span class="k">if</span> <span class="n">core_strategy</span> <span class="o">==</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Target dataset is empty; nothing to update&quot;</span><span class="p">)</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>        <span class="k">if</span> <span class="n">core_strategy</span> <span class="o">==</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">INSERT</span><span class="p">:</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;inserted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>        <span class="k">elif</span> <span class="n">core_strategy</span> <span class="ow">in</span> <span class="p">{</span><span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">UPSERT</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">DEDUPLICATE</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">FULL_MERGE</span><span class="p">}:</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;inserted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>        <span class="n">output_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_table</span><span class="p">)</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>        <span class="n">processed_source_indices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">))</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>        <span class="n">scanner</span> <span class="o">=</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">scanner</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">unified_schema</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">scanner</span><span class="o">.</span><span class="n">to_batches</span><span class="p">():</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_batches</span><span class="p">([</span><span class="n">batch</span><span class="p">])</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>            <span class="n">keep_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>            <span class="n">replacement_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>            <span class="n">key_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">to_pylist</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">normalized_keys</span><span class="p">]</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">):</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>                <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">key_lists</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>                <span class="n">source_row_idx</span> <span class="o">=</span> <span class="n">source_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>                <span class="k">if</span> <span class="n">source_row_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>                    <span class="n">processed_source_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source_row_idx</span><span class="p">)</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>                    <span class="k">if</span> <span class="n">core_strategy</span> <span class="o">==</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">INSERT</span><span class="p">:</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>                        <span class="n">keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>                        <span class="n">replacement_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_row_idx</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>                        <span class="k">if</span> <span class="n">core_strategy</span> <span class="ow">in</span> <span class="p">{</span><span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">UPSERT</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">DEDUPLICATE</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">FULL_MERGE</span><span class="p">}:</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>                            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>                    <span class="k">if</span> <span class="n">core_strategy</span> <span class="o">==</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">FULL_MERGE</span><span class="p">:</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>                        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;deleted&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>                    <span class="n">keep_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>            <span class="k">if</span> <span class="n">keep_indices</span><span class="p">:</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>                <span class="n">kept</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep_indices</span><span class="p">))</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>                <span class="n">output_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast_schema</span><span class="p">(</span><span class="n">kept</span><span class="p">,</span> <span class="n">unified_schema</span><span class="p">))</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>            <span class="k">if</span> <span class="n">replacement_indices</span> <span class="ow">and</span> <span class="n">core_strategy</span> <span class="o">!=</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">INSERT</span><span class="p">:</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>                <span class="n">replacements</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">replacement_indices</span><span class="p">))</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>                <span class="n">output_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast_schema</span><span class="p">(</span><span class="n">replacements</span><span class="p">,</span> <span class="n">unified_schema</span><span class="p">))</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="n">idx</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_table</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>        <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_source_indices</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>    <span class="p">]</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>    <span class="k">if</span> <span class="n">remaining</span><span class="p">:</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="k">if</span> <span class="n">core_strategy</span> <span class="ow">in</span> <span class="p">{</span><span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">INSERT</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">UPSERT</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">DEDUPLICATE</span><span class="p">,</span> <span class="n">CoreMergeStrategy</span><span class="o">.</span><span class="n">FULL_MERGE</span><span class="p">}:</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>            <span class="n">inserted_rows</span> <span class="o">=</span> <span class="n">source_table</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">remaining</span><span class="p">))</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>            <span class="n">output_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast_schema</span><span class="p">(</span><span class="n">inserted_rows</span><span class="p">,</span> <span class="n">unified_schema</span><span class="p">))</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;inserted&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="c1"># update strategy ignores non-matching rows</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="c1"># Report progress for writing results</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;Writing merged results&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>    <span class="n">_write_tables_to_dataset</span><span class="p">(</span><span class="n">output_tables</span><span class="p">,</span> <span class="n">unified_schema</span><span class="p">,</span> <span class="n">target_path</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">num_rows</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">output_tables</span><span class="p">)</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.opt_dtype" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.opt_dtype</span>


<a href="#fsspeckit.datasets.pyarrow.opt_dtype" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">opt_dtype</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">include</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">exclude</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">time_zone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">shrink_numerics</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">allow_unsigned</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">strict</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">allow_null</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">sample_size</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">sample_method</span><span class="p">:</span> <span class="n"><span title="fsspeckit.datasets.pyarrow.SampleMethod">SampleMethod</span></span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">force_timezone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Optimize data types of a PyArrow Table for performance and memory efficiency.
Returns a new table casted to the optimal schema.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow table to optimize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to include in optimization (default: all columns).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exclude</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column(s) to exclude from optimization.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_zone</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional time zone hint during datetime parsing.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shrink_numerics</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to downcast numeric types when possible.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_unsigned</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to allow unsigned integer types.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_large_dtypes</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, keep large types like large_string.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strict</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, will raise an error if any column cannot be optimized.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_null</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, columns that only hold null-like values will not be converted to pyarrow.null().</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of cleaned values to inspect during regex inference (None to inspect all).</p>
              </div>
            </td>
            <td>
                  <code>1024</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_method</code>
            </td>
            <td>
                  <code><span title="fsspeckit.datasets.pyarrow.SampleMethod">SampleMethod</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sampling strategy (<code>"first"</code> or <code>"random"</code>) for the inference subset.</p>
              </div>
            </td>
            <td>
                  <code>&#39;first&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_timezone</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, ensure all parsed datetime columns end up with this timezone.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-2037">2037</a></span>
<span class="normal"><a href="#__codelineno-0-2038">2038</a></span>
<span class="normal"><a href="#__codelineno-0-2039">2039</a></span>
<span class="normal"><a href="#__codelineno-0-2040">2040</a></span>
<span class="normal"><a href="#__codelineno-0-2041">2041</a></span>
<span class="normal"><a href="#__codelineno-0-2042">2042</a></span>
<span class="normal"><a href="#__codelineno-0-2043">2043</a></span>
<span class="normal"><a href="#__codelineno-0-2044">2044</a></span>
<span class="normal"><a href="#__codelineno-0-2045">2045</a></span>
<span class="normal"><a href="#__codelineno-0-2046">2046</a></span>
<span class="normal"><a href="#__codelineno-0-2047">2047</a></span>
<span class="normal"><a href="#__codelineno-0-2048">2048</a></span>
<span class="normal"><a href="#__codelineno-0-2049">2049</a></span>
<span class="normal"><a href="#__codelineno-0-2050">2050</a></span>
<span class="normal"><a href="#__codelineno-0-2051">2051</a></span>
<span class="normal"><a href="#__codelineno-0-2052">2052</a></span>
<span class="normal"><a href="#__codelineno-0-2053">2053</a></span>
<span class="normal"><a href="#__codelineno-0-2054">2054</a></span>
<span class="normal"><a href="#__codelineno-0-2055">2055</a></span>
<span class="normal"><a href="#__codelineno-0-2056">2056</a></span>
<span class="normal"><a href="#__codelineno-0-2057">2057</a></span>
<span class="normal"><a href="#__codelineno-0-2058">2058</a></span>
<span class="normal"><a href="#__codelineno-0-2059">2059</a></span>
<span class="normal"><a href="#__codelineno-0-2060">2060</a></span>
<span class="normal"><a href="#__codelineno-0-2061">2061</a></span>
<span class="normal"><a href="#__codelineno-0-2062">2062</a></span>
<span class="normal"><a href="#__codelineno-0-2063">2063</a></span>
<span class="normal"><a href="#__codelineno-0-2064">2064</a></span>
<span class="normal"><a href="#__codelineno-0-2065">2065</a></span>
<span class="normal"><a href="#__codelineno-0-2066">2066</a></span>
<span class="normal"><a href="#__codelineno-0-2067">2067</a></span>
<span class="normal"><a href="#__codelineno-0-2068">2068</a></span>
<span class="normal"><a href="#__codelineno-0-2069">2069</a></span>
<span class="normal"><a href="#__codelineno-0-2070">2070</a></span>
<span class="normal"><a href="#__codelineno-0-2071">2071</a></span>
<span class="normal"><a href="#__codelineno-0-2072">2072</a></span>
<span class="normal"><a href="#__codelineno-0-2073">2073</a></span>
<span class="normal"><a href="#__codelineno-0-2074">2074</a></span>
<span class="normal"><a href="#__codelineno-0-2075">2075</a></span>
<span class="normal"><a href="#__codelineno-0-2076">2076</a></span>
<span class="normal"><a href="#__codelineno-0-2077">2077</a></span>
<span class="normal"><a href="#__codelineno-0-2078">2078</a></span>
<span class="normal"><a href="#__codelineno-0-2079">2079</a></span>
<span class="normal"><a href="#__codelineno-0-2080">2080</a></span>
<span class="normal"><a href="#__codelineno-0-2081">2081</a></span>
<span class="normal"><a href="#__codelineno-0-2082">2082</a></span>
<span class="normal"><a href="#__codelineno-0-2083">2083</a></span>
<span class="normal"><a href="#__codelineno-0-2084">2084</a></span>
<span class="normal"><a href="#__codelineno-0-2085">2085</a></span>
<span class="normal"><a href="#__codelineno-0-2086">2086</a></span>
<span class="normal"><a href="#__codelineno-0-2087">2087</a></span>
<span class="normal"><a href="#__codelineno-0-2088">2088</a></span>
<span class="normal"><a href="#__codelineno-0-2089">2089</a></span>
<span class="normal"><a href="#__codelineno-0-2090">2090</a></span>
<span class="normal"><a href="#__codelineno-0-2091">2091</a></span>
<span class="normal"><a href="#__codelineno-0-2092">2092</a></span>
<span class="normal"><a href="#__codelineno-0-2093">2093</a></span>
<span class="normal"><a href="#__codelineno-0-2094">2094</a></span>
<span class="normal"><a href="#__codelineno-0-2095">2095</a></span>
<span class="normal"><a href="#__codelineno-0-2096">2096</a></span>
<span class="normal"><a href="#__codelineno-0-2097">2097</a></span>
<span class="normal"><a href="#__codelineno-0-2098">2098</a></span>
<span class="normal"><a href="#__codelineno-0-2099">2099</a></span>
<span class="normal"><a href="#__codelineno-0-2100">2100</a></span>
<span class="normal"><a href="#__codelineno-0-2101">2101</a></span>
<span class="normal"><a href="#__codelineno-0-2102">2102</a></span>
<span class="normal"><a href="#__codelineno-0-2103">2103</a></span>
<span class="normal"><a href="#__codelineno-0-2104">2104</a></span>
<span class="normal"><a href="#__codelineno-0-2105">2105</a></span>
<span class="normal"><a href="#__codelineno-0-2106">2106</a></span>
<span class="normal"><a href="#__codelineno-0-2107">2107</a></span>
<span class="normal"><a href="#__codelineno-0-2108">2108</a></span>
<span class="normal"><a href="#__codelineno-0-2109">2109</a></span>
<span class="normal"><a href="#__codelineno-0-2110">2110</a></span>
<span class="normal"><a href="#__codelineno-0-2111">2111</a></span>
<span class="normal"><a href="#__codelineno-0-2112">2112</a></span>
<span class="normal"><a href="#__codelineno-0-2113">2113</a></span>
<span class="normal"><a href="#__codelineno-0-2114">2114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-2037" name="__codelineno-0-2037"></a><span class="k">def</span><span class="w"> </span><span class="nf">opt_dtype</span><span class="p">(</span>
<a id="__codelineno-0-2038" name="__codelineno-0-2038"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
<a id="__codelineno-0-2039" name="__codelineno-0-2039"></a>    <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2040" name="__codelineno-0-2040"></a>    <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2041" name="__codelineno-0-2041"></a>    <span class="n">time_zone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2042" name="__codelineno-0-2042"></a>    <span class="n">shrink_numerics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2043" name="__codelineno-0-2043"></a>    <span class="n">allow_unsigned</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-2044" name="__codelineno-0-2044"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2045" name="__codelineno-0-2045"></a>    <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2046" name="__codelineno-0-2046"></a>    <span class="n">allow_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-2047" name="__codelineno-0-2047"></a>    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<a id="__codelineno-0-2048" name="__codelineno-0-2048"></a>    <span class="n">sample_method</span><span class="p">:</span> <span class="n">SampleMethod</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
<a id="__codelineno-0-2049" name="__codelineno-0-2049"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-2050" name="__codelineno-0-2050"></a>    <span class="n">force_timezone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2051" name="__codelineno-0-2051"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-2052" name="__codelineno-0-2052"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-2053" name="__codelineno-0-2053"></a><span class="sd">    Optimize data types of a PyArrow Table for performance and memory efficiency.</span>
<a id="__codelineno-0-2054" name="__codelineno-0-2054"></a><span class="sd">    Returns a new table casted to the optimal schema.</span>
<a id="__codelineno-0-2055" name="__codelineno-0-2055"></a>
<a id="__codelineno-0-2056" name="__codelineno-0-2056"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-2057" name="__codelineno-0-2057"></a><span class="sd">        table: The PyArrow table to optimize.</span>
<a id="__codelineno-0-2058" name="__codelineno-0-2058"></a><span class="sd">        include: Column(s) to include in optimization (default: all columns).</span>
<a id="__codelineno-0-2059" name="__codelineno-0-2059"></a><span class="sd">        exclude: Column(s) to exclude from optimization.</span>
<a id="__codelineno-0-2060" name="__codelineno-0-2060"></a><span class="sd">        time_zone: Optional time zone hint during datetime parsing.</span>
<a id="__codelineno-0-2061" name="__codelineno-0-2061"></a><span class="sd">        shrink_numerics: Whether to downcast numeric types when possible.</span>
<a id="__codelineno-0-2062" name="__codelineno-0-2062"></a><span class="sd">        allow_unsigned: Whether to allow unsigned integer types.</span>
<a id="__codelineno-0-2063" name="__codelineno-0-2063"></a><span class="sd">        use_large_dtypes: If True, keep large types like large_string.</span>
<a id="__codelineno-0-2064" name="__codelineno-0-2064"></a><span class="sd">        strict: If True, will raise an error if any column cannot be optimized.</span>
<a id="__codelineno-0-2065" name="__codelineno-0-2065"></a><span class="sd">        allow_null: If False, columns that only hold null-like values will not be converted to pyarrow.null().</span>
<a id="__codelineno-0-2066" name="__codelineno-0-2066"></a><span class="sd">        sample_size: Maximum number of cleaned values to inspect during regex inference (None to inspect all).</span>
<a id="__codelineno-0-2067" name="__codelineno-0-2067"></a><span class="sd">        sample_method: Sampling strategy (`&quot;first&quot;` or `&quot;random&quot;`) for the inference subset.</span>
<a id="__codelineno-0-2068" name="__codelineno-0-2068"></a><span class="sd">        force_timezone: If set, ensure all parsed datetime columns end up with this timezone.</span>
<a id="__codelineno-0-2069" name="__codelineno-0-2069"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-2070" name="__codelineno-0-2070"></a>    <span class="k">if</span> <span class="n">sample_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2071" name="__codelineno-0-2071"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sample_method must be &#39;first&#39; or &#39;random&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2072" name="__codelineno-0-2072"></a>
<a id="__codelineno-0-2073" name="__codelineno-0-2073"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2074" name="__codelineno-0-2074"></a>        <span class="n">include</span> <span class="o">=</span> <span class="p">[</span><span class="n">include</span><span class="p">]</span>
<a id="__codelineno-0-2075" name="__codelineno-0-2075"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2076" name="__codelineno-0-2076"></a>        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude</span><span class="p">]</span>
<a id="__codelineno-0-2077" name="__codelineno-0-2077"></a>
<a id="__codelineno-0-2078" name="__codelineno-0-2078"></a>    <span class="n">cols_to_process</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span>
<a id="__codelineno-0-2079" name="__codelineno-0-2079"></a>    <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
<a id="__codelineno-0-2080" name="__codelineno-0-2080"></a>        <span class="n">cols_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">include</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span><span class="p">]</span>
<a id="__codelineno-0-2081" name="__codelineno-0-2081"></a>    <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
<a id="__codelineno-0-2082" name="__codelineno-0-2082"></a>        <span class="n">cols_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_process</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
<a id="__codelineno-0-2083" name="__codelineno-0-2083"></a>
<a id="__codelineno-0-2084" name="__codelineno-0-2084"></a>    <span class="c1"># Prepare arguments for parallel processing</span>
<a id="__codelineno-0-2085" name="__codelineno-0-2085"></a>    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-2086" name="__codelineno-0-2086"></a>        <span class="p">(</span>
<a id="__codelineno-0-2087" name="__codelineno-0-2087"></a>            <span class="n">table</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span>
<a id="__codelineno-0-2088" name="__codelineno-0-2088"></a>            <span class="n">col_name</span><span class="p">,</span>
<a id="__codelineno-0-2089" name="__codelineno-0-2089"></a>            <span class="n">cols_to_process</span><span class="p">,</span>
<a id="__codelineno-0-2090" name="__codelineno-0-2090"></a>            <span class="n">shrink_numerics</span><span class="p">,</span>
<a id="__codelineno-0-2091" name="__codelineno-0-2091"></a>            <span class="n">allow_unsigned</span><span class="p">,</span>
<a id="__codelineno-0-2092" name="__codelineno-0-2092"></a>            <span class="n">time_zone</span><span class="p">,</span>
<a id="__codelineno-0-2093" name="__codelineno-0-2093"></a>            <span class="n">strict</span><span class="p">,</span>
<a id="__codelineno-0-2094" name="__codelineno-0-2094"></a>            <span class="n">allow_null</span><span class="p">,</span>
<a id="__codelineno-0-2095" name="__codelineno-0-2095"></a>            <span class="n">force_timezone</span><span class="p">,</span>
<a id="__codelineno-0-2096" name="__codelineno-0-2096"></a>            <span class="n">sample_size</span><span class="p">,</span>
<a id="__codelineno-0-2097" name="__codelineno-0-2097"></a>            <span class="n">sample_method</span><span class="p">,</span>
<a id="__codelineno-0-2098" name="__codelineno-0-2098"></a>        <span class="p">)</span>
<a id="__codelineno-0-2099" name="__codelineno-0-2099"></a>        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span>
<a id="__codelineno-0-2100" name="__codelineno-0-2100"></a>    <span class="p">]</span>
<a id="__codelineno-0-2101" name="__codelineno-0-2101"></a>
<a id="__codelineno-0-2102" name="__codelineno-0-2102"></a>    <span class="c1"># Parallelize column processing</span>
<a id="__codelineno-0-2103" name="__codelineno-0-2103"></a>    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-0-2104" name="__codelineno-0-2104"></a>        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_process_column_for_opt_dtype</span><span class="p">,</span> <span class="n">args_list</span><span class="p">))</span>
<a id="__codelineno-0-2105" name="__codelineno-0-2105"></a>
<a id="__codelineno-0-2106" name="__codelineno-0-2106"></a>    <span class="c1"># Sort results to preserve column order</span>
<a id="__codelineno-0-2107" name="__codelineno-0-2107"></a>    <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-2108" name="__codelineno-0-2108"></a>    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<a id="__codelineno-0-2109" name="__codelineno-0-2109"></a>    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<a id="__codelineno-0-2110" name="__codelineno-0-2110"></a>
<a id="__codelineno-0-2111" name="__codelineno-0-2111"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
<a id="__codelineno-0-2112" name="__codelineno-0-2112"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_large_dtypes</span><span class="p">:</span>
<a id="__codelineno-0-2113" name="__codelineno-0-2113"></a>        <span class="n">schema</span> <span class="o">=</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-0-2114" name="__codelineno-0-2114"></a>    <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.optimize_parquet_dataset_pyarrow" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.optimize_parquet_dataset_pyarrow</span>


<a href="#fsspeckit.datasets.pyarrow.optimize_parquet_dataset_pyarrow" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">optimize_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">compression</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Cluster parquet files by <code>zorder_columns</code> while rewriting groups on disk.</p>
<p>This function uses the shared core planning algorithm for consistent optimization
behavior across backends. It processes data in a streaming, per-group fashion
that avoids materializing the entire dataset.</p>
<p>The helper enumerates individual parquet files under <code>path</code>, optionally
filtering them by <code>partition_filter</code> prefixes so we never materialize the
entire dataset with <code>dataset.to_table()</code>. Each optimization group is streamed
file-by-file, sorted by <code>zorder_columns</code> in memory, and then rewritten to an
<code>optimized-*.parquet</code> file while the original inputs are deleted only after
a successful write. Use dry-run mode to inspect the planned groups/metrics
before any data is touched.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataset root directory (local path or fsspec URL).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zorder_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ordered columns that determine clustering/ordering.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max output size per file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional max rows per output file; must be &gt; 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefixes (e.g. <code>["date=2025-11-15"]</code>)
used to limit both stats collection and rewrites to matching paths.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional parquet compression codec; defaults to <code>"snappy"</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When <code>True</code> the function returns a plan + before/after stats
without reading or writing any parquet data.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional <code>fsspec.AbstractFileSystem</code> to reuse existing FS clients.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A stats dictionary describing before/after file counts, total bytes,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>rewritten bytes, <code>zorder_columns</code>, and optional <code>planned_groups</code> when</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>dry_run</code> is enabled. The structure follows the canonical <code>MaintenanceStats</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>format from the shared core.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If thresholds are invalid or if any <code>zorder_columns</code> are missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist or no parquet files are found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function delegates optimization planning and validation to the shared
<code>fsspeckit.core.maintenance.plan_optimize_groups</code> function, ensuring
consistent behavior with DuckDB backend.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_parquet_dataset_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cluster parquet files by ``zorder_columns`` while rewriting groups on disk.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    This function uses the shared core planning algorithm for consistent optimization</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    behavior across backends. It processes data in a streaming, per-group fashion</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    that avoids materializing the entire dataset.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    The helper enumerates individual parquet files under ``path``, optionally</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    filtering them by ``partition_filter`` prefixes so we never materialize the</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    entire dataset with ``dataset.to_table()``. Each optimization group is streamed</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    file-by-file, sorted by ``zorder_columns`` in memory, and then rewritten to an</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    ``optimized-*.parquet`` file while the original inputs are deleted only after</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">    a successful write. Use dry-run mode to inspect the planned groups/metrics</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    before any data is touched.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        path: Dataset root directory (local path or fsspec URL).</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        zorder_columns: Ordered columns that determine clustering/ordering.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        target_mb_per_file: Optional max output size per file; must be &gt; 0.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        target_rows_per_file: Optional max rows per output file; must be &gt; 0.</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        partition_filter: Optional list of partition prefixes (e.g. ``[&quot;date=2025-11-15&quot;]``)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">            used to limit both stats collection and rewrites to matching paths.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">        compression: Optional parquet compression codec; defaults to ``&quot;snappy&quot;``.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        dry_run: When ``True`` the function returns a plan + before/after stats</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">            without reading or writing any parquet data.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">        filesystem: Optional ``fsspec.AbstractFileSystem`` to reuse existing FS clients.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        A stats dictionary describing before/after file counts, total bytes,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        rewritten bytes, ``zorder_columns``, and optional ``planned_groups`` when</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        ``dry_run`` is enabled. The structure follows the canonical ``MaintenanceStats``</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        format from the shared core.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        ValueError: If thresholds are invalid or if any ``zorder_columns`` are missing.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        FileNotFoundError: If the path does not exist or no parquet files are found.</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        This function delegates optimization planning and validation to the shared</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        ``fsspeckit.core.maintenance.plan_optimize_groups`` function, ensuring</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        consistent behavior with DuckDB backend.</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fsspeckit.core.maintenance</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">MaintenanceStats</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">plan_optimize_groups</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># Use shared core validation</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">zorder_columns</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zorder_columns must be a non-empty list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_mb_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_mb_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">if</span> <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_rows_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="c1"># Collect dataset stats using shared core</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="s2">&quot;before_file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="s2">&quot;after_file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="s2">&quot;before_total_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="s2">&quot;after_total_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="s2">&quot;compacted_file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="s2">&quot;rewritten_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="s2">&quot;compression_codec&quot;</span><span class="p">:</span> <span class="n">compression</span><span class="p">,</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="s2">&quot;zorder_columns&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">),</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="p">}</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span> <span class="ow">or</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="c1"># Get schema for validation (sample first file)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>    <span class="n">sample_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">sample_table</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="c1"># Use shared core planning with z-order validation</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">plan_optimize_groups</span><span class="p">(</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">target_mb_per_file</span><span class="o">=</span><span class="n">target_mb_per_file</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">target_rows_per_file</span><span class="o">=</span><span class="n">target_rows_per_file</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">sample_schema</span><span class="o">=</span><span class="n">sample_table</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;planned_stats&quot;</span><span class="p">]</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="c1"># Handle dry run</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">after_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">after_file_count</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">after_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="n">compression_codec</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">zorder_columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">),</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="n">planned_groups</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">planned_groups</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">codec</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="s2">&quot;snappy&quot;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="n">written_files</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="c1"># Process each optimization group in streaming fashion</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="k">for</span> <span class="n">group_idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="k">continue</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="c1"># Read tables for this group only (streaming per-group)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="k">continue</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="c1"># Sort the combined group data by z-order columns</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">concat_tables</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">promote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">sort_keys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;ascending&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">zorder_columns</span><span class="p">]</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">combined_sorted</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">sort_keys</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="c1"># Write sorted group to output file</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="n">out_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;optimized-</span><span class="si">{</span><span class="n">group_idx</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">out_name</span><span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">combined_sorted</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">codec</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">written_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="c1"># Delete original files in this group</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: failed to delete &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; during optimize&quot;</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>    <span class="c1"># Recompute stats after optimization</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="n">stats_after</span> <span class="o">=</span> <span class="n">collect_dataset_stats_pyarrow</span><span class="p">(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filesystem</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">partition_filter</span><span class="o">=</span><span class="n">partition_filter</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="c1"># Create final stats</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="n">final_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">planned_stats</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">stats_after</span><span class="p">[</span><span class="s2">&quot;total_bytes&quot;</span><span class="p">],</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="n">codec</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">zorder_columns</span><span class="p">),</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="k">return</span> <span class="n">final_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.remove_empty_columns" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.remove_empty_columns</span>


<a href="#fsspeckit.datasets.pyarrow.remove_empty_columns" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">remove_empty_columns</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n"><span title="pyarrow.Table">Table</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Table">Table</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Remove columns that are entirely empty from a PyArrow table.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PyArrow table to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Table: A new PyArrow table with empty columns removed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1535" name="__codelineno-0-1535"></a><span class="k">def</span><span class="w"> </span><span class="nf">remove_empty_columns</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove columns that are entirely empty from a PyArrow table.</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a><span class="sd">        table (pa.Table): The PyArrow table to process.</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a><span class="sd">        pa.Table: A new PyArrow table with empty columns removed.</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>    <span class="n">empty_cols</span> <span class="o">=</span> <span class="n">_identify_empty_columns</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_cols</span><span class="p">:</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>        <span class="k">return</span> <span class="n">table</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a>    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">empty_cols</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.standardize_schema_timezones" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.standardize_schema_timezones</span>


<a href="#fsspeckit.datasets.pyarrow.standardize_schema_timezones" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">timezone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Standardize timezone info for all timestamp columns in a list of PyArrow schemas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schemas</code>
            </td>
            <td>
                  <code>list of pa.Schema</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of PyArrow schemas.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timezone</code>
            </td>
            <td>
                  <code><span title="str">str</span> or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If None, remove timezone from all timestamp columns.
                    If str, set this timezone for all timestamp columns.
                    If "auto", use the most frequent timezone across schemas.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Schema">Schema</span> | <span title="list">list</span>[<span title="pyarrow.Schema">Schema</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of pa.Schema: New schemas with standardized timezone info.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span>
<span class="normal"><a href="#__codelineno-0-956">956</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="k">def</span><span class="w"> </span><span class="nf">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">]:</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">    Standardize timezone info for all timestamp columns in a list of PyArrow schemas.</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a><span class="sd">        schemas (list of pa.Schema): List of PyArrow schemas.</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a><span class="sd">        timezone (str or None): If None, remove timezone from all timestamp columns.</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a><span class="sd">                                If str, set this timezone for all timestamp columns.</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a><span class="sd">                                If &quot;auto&quot;, use the most frequent timezone across schemas.</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a><span class="sd">        list of pa.Schema: New schemas with standardized timezone info.</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schemas</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>        <span class="n">single_input</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>        <span class="n">schema_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">schemas</span><span class="p">]</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>        <span class="n">single_input</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>        <span class="n">schema_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>    <span class="k">if</span> <span class="n">timezone</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>        <span class="n">majority_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones_by_majority</span><span class="p">(</span><span class="n">schema_list</span><span class="p">)</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">majority_schema</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">schema_list</span><span class="p">]</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>        <span class="k">return</span> <span class="n">majority_schema</span> <span class="k">if</span> <span class="n">single_input</span> <span class="k">else</span> <span class="n">result_list</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>    <span class="n">new_schemas</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>    <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schema_list</span><span class="p">:</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>            <span class="k">if</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_timestamp</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>                    <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>                        <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>                        <span class="n">pa</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">timezone</span><span class="p">),</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>                        <span class="n">field</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>                        <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>                    <span class="p">)</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>                <span class="p">)</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>        <span class="n">new_schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">metadata</span><span class="p">))</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>    <span class="k">return</span> <span class="n">new_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single_input</span> <span class="k">else</span> <span class="n">new_schemas</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.standardize_schema_timezones_by_majority" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.standardize_schema_timezones_by_majority</span>


<a href="#fsspeckit.datasets.pyarrow.standardize_schema_timezones_by_majority" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">standardize_schema_timezones_by_majority</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>For each timestamp column (by name) across all schemas, set the timezone to the most frequent (with tie-breaking).
Returns a new list of schemas with updated timestamp timezones.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-882" name="__codelineno-0-882"></a><span class="k">def</span><span class="w"> </span><span class="nf">standardize_schema_timezones_by_majority</span><span class="p">(</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">],</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">:</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a><span class="sd">    For each timestamp column (by name) across all schemas, set the timezone to the most frequent (with tie-breaking).</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="sd">    Returns a new list of schemas with updated timestamp timezones.</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>    <span class="n">dom</span> <span class="o">=</span> <span class="n">dominant_timezone_per_column</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">schemas</span><span class="p">:</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>        <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">([])</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>    <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>    <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>    <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>                <span class="k">continue</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>            <span class="k">if</span> <span class="n">pa</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_timestamp</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">dom</span><span class="p">:</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>                <span class="n">unit</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">dom</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>                    <span class="n">pa</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>                        <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>                        <span class="n">pa</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">tz</span><span class="p">),</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>                        <span class="n">field</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>                        <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>                    <span class="p">)</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>                <span class="p">)</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>    <span class="k">return</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.datasets.pyarrow.unify_schemas" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.datasets.pyarrow.unify_schemas</span>


<a href="#fsspeckit.datasets.pyarrow.unify_schemas" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">unify_schemas</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="pyarrow.Schema">Schema</span></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">timezone</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">standardize_timezones</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">remove_conflicting_columns</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pyarrow.Schema">Schema</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unify a list of PyArrow schemas into a single schema using intelligent conflict resolution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schemas</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="pyarrow.Schema">Schema</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of PyArrow schemas to unify.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_large_dtypes</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, keep large types like large_string.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timezone</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified, standardize all timestamp columns to this timezone.
If "auto", use the most frequent timezone across schemas.
If None, remove timezone from all timestamp columns.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>standardize_timezones</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, standardize all timestamp columns to the most frequent timezone.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print conflict resolution details for debugging.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>remove_conflicting_columns</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, allows removal of columns with type conflicts as a fallback
strategy instead of converting them. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyarrow.Schema">Schema</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pa.Schema: A unified PyArrow schema.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no schemas are provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/datasets/pyarrow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1391" name="__codelineno-0-1391"></a><span class="k">def</span><span class="w"> </span><span class="nf">unify_schemas</span><span class="p">(</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>    <span class="n">schemas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">],</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>    <span class="n">use_large_dtypes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>    <span class="n">timezone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>    <span class="n">standardize_timezones</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>    <span class="n">remove_conflicting_columns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pa</span><span class="o">.</span><span class="n">Schema</span><span class="p">:</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a><span class="sd">    Unify a list of PyArrow schemas into a single schema using intelligent conflict resolution.</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a><span class="sd">        schemas (list[pa.Schema]): List of PyArrow schemas to unify.</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a><span class="sd">        use_large_dtypes (bool): If True, keep large types like large_string.</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a><span class="sd">        timezone (str | None): If specified, standardize all timestamp columns to this timezone.</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a><span class="sd">            If &quot;auto&quot;, use the most frequent timezone across schemas.</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a><span class="sd">            If None, remove timezone from all timestamp columns.</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a><span class="sd">        standardize_timezones (bool): If True, standardize all timestamp columns to the most frequent timezone.</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a><span class="sd">        verbose (bool): If True, print conflict resolution details for debugging.</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a><span class="sd">        remove_conflicting_columns (bool): If True, allows removal of columns with type conflicts as a fallback</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a><span class="sd">            strategy instead of converting them. Defaults to False.</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a><span class="sd">        pa.Schema: A unified PyArrow schema.</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a><span class="sd">        ValueError: If no schemas are provided.</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">schemas</span><span class="p">:</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one schema must be provided for unification&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>    <span class="c1"># Early exit for single schema</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>    <span class="n">unique_schemas</span> <span class="o">=</span> <span class="n">_unique_schemas</span><span class="p">(</span><span class="n">schemas</span><span class="p">)</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>        <span class="n">result_schema</span> <span class="o">=</span> <span class="n">unique_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>        <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>            <span class="n">result_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">([</span><span class="n">result_schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>            <span class="n">result_schema</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>            <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>            <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">result_schema</span><span class="p">)</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>        <span class="p">)</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>    <span class="c1"># Step 1: Find and resolve conflicts first</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>    <span class="n">conflicts</span> <span class="o">=</span> <span class="n">_find_conflicting_fields</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>    <span class="k">if</span> <span class="n">conflicts</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="n">_log_conflict_summary</span><span class="p">(</span><span class="n">conflicts</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>    <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="c1"># Normalize schemas using intelligent promotion rules</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>        <span class="n">unique_schemas</span> <span class="o">=</span> <span class="n">_normalize_schema_types</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>    <span class="c1"># Step 2: Attempt unification with conflict-resolved schemas</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>        <span class="n">unified_schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">unify_schemas</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">,</span> <span class="n">promote_options</span><span class="o">=</span><span class="s2">&quot;permissive&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>        <span class="c1"># Step 3: Apply timezone standardization to the unified result</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>        <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>            <span class="n">unified_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">([</span><span class="n">unified_schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>            <span class="n">unified_schema</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>            <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>            <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">unified_schema</span><span class="p">)</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>        <span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>    <span class="k">except</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">ArrowInvalid</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">ArrowTypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>        <span class="c1"># Step 4: Intelligent fallback strategies</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary unification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting fallback strategies...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>        <span class="c1"># Fallback 1: Try aggressive string conversion for remaining conflicts</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>            <span class="n">fallback_schema</span> <span class="o">=</span> <span class="n">_aggressive_fallback_unification</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>            <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>                <span class="n">fallback_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>                    <span class="p">[</span><span class="n">fallback_schema</span><span class="p">],</span> <span class="n">timezone</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Aggressive fallback succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>            <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>                <span class="n">fallback_schema</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>                <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>                <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">fallback_schema</span><span class="p">)</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>            <span class="p">)</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Aggressive fallback failed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>        <span class="c1"># Fallback 2: Remove conflicting fields (if enabled)</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>        <span class="k">if</span> <span class="n">remove_conflicting_columns</span><span class="p">:</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>                <span class="n">non_conflicting_schema</span> <span class="o">=</span> <span class="n">_remove_conflicting_fields</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>                <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>                    <span class="n">non_conflicting_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>                        <span class="p">[</span><span class="n">non_conflicting_schema</span><span class="p">],</span> <span class="n">timezone</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Remove conflicting fields fallback succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>                <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>                    <span class="n">non_conflicting_schema</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>                    <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>                    <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">non_conflicting_schema</span><span class="p">)</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>                <span class="p">)</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Remove conflicting fields fallback failed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>        <span class="c1"># Fallback 3: Remove problematic fields that can&#39;t be unified</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>            <span class="n">minimal_schema</span> <span class="o">=</span> <span class="n">_remove_problematic_fields</span><span class="p">(</span><span class="n">unique_schemas</span><span class="p">)</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>            <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>                <span class="n">minimal_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">(</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>                    <span class="p">[</span><span class="n">minimal_schema</span><span class="p">],</span> <span class="n">timezone</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Minimal schema (removed problematic fields) succeeded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>            <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>                <span class="n">minimal_schema</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>                <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>                <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">minimal_schema</span><span class="p">)</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>            <span class="p">)</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Minimal schema fallback failed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>        <span class="c1"># Fallback 4: Return first schema as last resort</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; All fallback strategies failed, returning first schema&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>        <span class="n">first_schema</span> <span class="o">=</span> <span class="n">unique_schemas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>        <span class="k">if</span> <span class="n">standardize_timezones</span><span class="p">:</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>            <span class="n">first_schema</span> <span class="o">=</span> <span class="n">standardize_schema_timezones</span><span class="p">([</span><span class="n">first_schema</span><span class="p">],</span> <span class="n">timezone</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>            <span class="n">first_schema</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>            <span class="k">if</span> <span class="n">use_large_dtypes</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>            <span class="k">else</span> <span class="n">convert_large_types_to_normal</span><span class="p">(</span><span class="n">first_schema</span><span class="p">)</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "search.suggest", "search.highlight", "toc.integrate"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.4.0/dist/mermaid.min.js"></script>
      
        <script src="../../javascripts/mermaid.js"></script>
      
    
  </body>
</html>