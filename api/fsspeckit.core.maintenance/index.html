
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Enhanced utilities and extensions for fsspec, storage_options and obstore with multi-format I/O support.">
      
      
      
        <link rel="canonical" href="https://legout.github.io/fsspeckit/api/fsspeckit.core.maintenance/">
      
      
        <link rel="prev" href="../fsspeckit.core.filesystem/">
      
      
        <link rel="next" href="../fsspeckit.core.merge/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>fsspeckit.core.maintenance - fsspeckit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fsspeckitcoremaintenance" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="fsspeckit" class="md-header__button md-logo" aria-label="fsspeckit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            fsspeckit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              fsspeckit.core.maintenance
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/legout/fsspeckit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    legout/fsspeckit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quickstart/" class="md-tabs__link">
        
  
  
    
  
  Quickstart

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../architecture/" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../advanced/" class="md-tabs__link">
        
  
  
    
  
  Advanced Usage

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../utils/" class="md-tabs__link">
        
  
  
    
  
  Utils Reference

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../examples/" class="md-tabs__link">
        
  
  
    
  
  Examples

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../api-guide/" class="md-tabs__link">
        
  
  
    
  
  API Guide

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="fsspeckit" class="md-nav__button md-logo" aria-label="fsspeckit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    fsspeckit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/legout/fsspeckit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    legout/fsspeckit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Usage
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Utils Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2" >
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Domain Packages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Domain Packages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.sql.filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.sql.filters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.common
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_3" checked>
        
          
          <label class="md-nav__link" for="__nav_10_3" id="__nav_10_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.ext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.ext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.filesystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.filesystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.maintenance
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.maintenance
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      
        maintenance
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="maintenance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.CompactionGroup" class="md-nav__link">
    <span class="md-ellipsis">
      
        CompactionGroup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.FileInfo" class="md-nav__link">
    <span class="md-ellipsis">
      
        FileInfo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.MaintenanceStats" class="md-nav__link">
    <span class="md-ellipsis">
      
        MaintenanceStats
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MaintenanceStats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.MaintenanceStats-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.MaintenanceStats.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_dict
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.collect_dataset_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        collect_dataset_stats
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.plan_compaction_groups" class="md-nav__link">
    <span class="md-ellipsis">
      
        plan_compaction_groups
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fsspeckit.core.maintenance.plan_optimize_groups" class="md-nav__link">
    <span class="md-ellipsis">
      
        plan_optimize_groups
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.core.merge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.core.merge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4" >
        
          
          <label class="md-nav__link" for="__nav_10_4" id="__nav_10_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Storage Options
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Storage Options
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.cloud/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.cloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.storage_options.git/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.storage_options.git
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_5" >
        
          
          <label class="md-nav__link" for="__nav_10_5" id="__nav_10_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Utils (Backwards Compatibility)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utils (Backwards Compatibility)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.datetime/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.datetime
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.polars/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.polars
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.pyarrow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.pyarrow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.sql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.sql
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fsspeckit.utils.types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fsspeckit.utils.types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="fsspeckitcoremaintenance">fsspeckit.core.maintenance<a class="headerlink" href="#fsspeckitcoremaintenance" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<h2 id="fsspeckit.core.maintenance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">maintenance</span>


<a href="#fsspeckit.core.maintenance" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>Backend-neutral maintenance layer for parquet dataset operations.</p>
<p>This module provides shared functionality for dataset discovery, statistics,
and grouping algorithms used by both DuckDB and PyArrow maintenance operations.
It serves as the authoritative implementation for maintenance planning,
ensuring consistent behavior across different backends.</p>
<p>Key responsibilities:
1. Dataset discovery and file-level statistics
2. Compaction grouping algorithms with streaming execution
3. Optimization planning with z-order validation
4. Canonical statistics structures
5. Partition filtering and edge case handling</p>
<p>Architecture:
- Functions accept both dict format (legacy) and FileInfo objects for backward compatibility
- All planning functions return structured results with canonical MaintenanceStats
- Backend implementations delegate to this core for consistent behavior
- Streaming design avoids materializing entire datasets in memory</p>
<p>Core components:
- FileInfo: Canonical file information with validation
- MaintenanceStats: Canonical statistics structure across backends
- CompactionGroup: Logical grouping of files for processing
- collect_dataset_stats: Dataset discovery with partition filtering
- plan_compaction_groups: Shared compaction planning algorithm
- plan_optimize_groups: Shared optimization planning with z-order validation</p>
<p>Usage:
Backend functions should delegate to this module rather than implementing
their own discovery and planning logic. This ensures that DuckDB and PyArrow
produce identical grouping decisions and statistics structures.</p>










  <div class="doc doc-children">







<h3 id="fsspeckit.core.maintenance-classes">Classes<a href="#fsspeckit.core.maintenance-classes" class="headerlink" title="Permanent link">&para;</a></h3>

<div class="doc doc-object doc-class">



<h4 id="fsspeckit.core.maintenance.CompactionGroup" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">fsspeckit.core.maintenance.CompactionGroup</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#fsspeckit.core.maintenance.CompactionGroup" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">CompactionGroup</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="            fsspeckit.core.maintenance.FileInfo


  
      dataclass
  " href="#fsspeckit.core.maintenance.FileInfo">FileInfo</a></span><span class="p">])</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>A group of files to be compacted or optimized together.</p>
<p>This dataclass represents a logical grouping of files that will be processed
together during maintenance operations. It enables streaming execution by
bounding the amount of data processed at once.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.CompactionGroup.files">files</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="            fsspeckit.core.maintenance.FileInfo


  
      dataclass
  " href="#fsspeckit.core.maintenance.FileInfo">FileInfo</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of FileInfo objects in this group.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.CompactionGroup.total_size_bytes">total_size_bytes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total size of all files in this group (computed).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.CompactionGroup.total_rows">total_rows</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total rows across all files in this group (computed).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Must contain at least one file. The total_size_bytes and total_rows
are computed during initialization and used for planning decisions.
This structure enables per-group streaming processing without
materializing entire datasets.</p>
</details>










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="fsspeckit.core.maintenance.FileInfo" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">fsspeckit.core.maintenance.FileInfo</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#fsspeckit.core.maintenance.FileInfo" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">FileInfo</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n">size_bytes</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span> <span class="n">num_rows</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Information about a single parquet file with validation.</p>
<p>This canonical data structure represents file metadata across all backends.
It enables consistent file information handling and size-based planning.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.FileInfo.path">path</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File path relative to the dataset root.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.FileInfo.size_bytes">size_bytes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File size in bytes; must be &gt;= 0.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.FileInfo.num_rows">num_rows</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rows in the file; must be &gt;= 0.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The size_bytes and num_rows values are validated to be non-negative.
This class is used throughout the maintenance planning pipeline
for consistent file metadata representation.</p>
</details>










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="fsspeckit.core.maintenance.MaintenanceStats" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">fsspeckit.core.maintenance.MaintenanceStats</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#fsspeckit.core.maintenance.MaintenanceStats" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">before_file_count</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">after_file_count</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">before_total_bytes</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">after_total_bytes</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">compacted_file_count</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">rewritten_bytes</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">compression_codec</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">dry_run</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">planned_groups</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">



        <p>Canonical statistics structure for maintenance operations.</p>
<p>This dataclass provides the authoritative statistics format for all maintenance
operations across DuckDB and PyArrow backends. It ensures consistent reporting
and enables unified testing and validation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.before_file_count">before_file_count</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of files before the operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.after_file_count">after_file_count</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of files after the operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.before_total_bytes">before_total_bytes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total bytes before the operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.after_total_bytes">after_total_bytes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total bytes after the operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.compacted_file_count">compacted_file_count</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of files that were compacted/rewritten.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.rewritten_bytes">rewritten_bytes</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total bytes rewritten during the operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.compression_codec">compression_codec</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression codec used (None if unchanged).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.dry_run">dry_run</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether this was a dry run operation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.zorder_columns">zorder_columns</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Z-order columns used (for optimization operations).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fsspeckit.core.maintenance.MaintenanceStats.planned_groups">planned_groups</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="str">str</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File groupings planned during dry run.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>All numeric fields are validated to be non-negative. The to_dict() method
provides backward compatibility with existing code expecting dictionary format.</p>
</details>










  <div class="doc doc-children">








<h5 id="fsspeckit.core.maintenance.MaintenanceStats-functions">Functions<a href="#fsspeckit.core.maintenance.MaintenanceStats-functions" class="headerlink" title="Permanent link">&para;</a></h5>

<div class="doc doc-object doc-function">


<h6 id="fsspeckit.core.maintenance.MaintenanceStats.to_dict" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.core.maintenance.MaintenanceStats.to_dict</span>


<a href="#fsspeckit.core.maintenance.MaintenanceStats.to_dict" class="headerlink" title="Permanent link">&para;</a></h6>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">to_dict</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert to dictionary format for backward compatibility.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/core/maintenance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to dictionary format for backward compatibility.&quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="s2">&quot;before_file_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="s2">&quot;after_file_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_file_count</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="s2">&quot;before_total_bytes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="s2">&quot;after_total_bytes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="s2">&quot;compacted_file_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="s2">&quot;rewritten_bytes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="s2">&quot;compression_codec&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression_codec</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="p">}</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zorder_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;zorder_columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zorder_columns</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planned_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;planned_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planned_groups</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
<h3 id="fsspeckit.core.maintenance-functions">Functions<a href="#fsspeckit.core.maintenance-functions" class="headerlink" title="Permanent link">&para;</a></h3>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.core.maintenance.collect_dataset_stats" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.core.maintenance.collect_dataset_stats</span>


<a href="#fsspeckit.core.maintenance.collect_dataset_stats" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">collect_dataset_stats</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">path</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n"><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Collect file-level statistics for a parquet dataset.</p>
<p>This function walks the given dataset directory on the provided filesystem,
discovers parquet files (recursively), and returns basic statistics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Root directory of the parquet dataset.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filesystem</code>
            </td>
            <td>
                  <code><span title="fsspec.AbstractFileSystem">AbstractFileSystem</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional fsspec filesystem. If omitted, a local "file"
filesystem is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partition_filter</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of partition prefix filters
(e.g. ["date=2025-11-04"]). Only files whose path relative to
<code>path</code> starts with one of these prefixes are included.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with keys:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>files</code>: list of <code>{"path", "size_bytes", "num_rows"}</code> dicts</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>total_bytes</code>: sum of file sizes</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li><code>total_rows</code>: sum of row counts</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path does not exist or no parquet files
match the optional partition filter.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/core/maintenance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="k">def</span><span class="w"> </span><span class="nf">collect_dataset_stats</span><span class="p">(</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">filesystem</span><span class="p">:</span> <span class="n">AbstractFileSystem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">partition_filter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">    Collect file-level statistics for a parquet dataset.</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">    This function walks the given dataset directory on the provided filesystem,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    discovers parquet files (recursively), and returns basic statistics.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        path: Root directory of the parquet dataset.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">        filesystem: Optional fsspec filesystem. If omitted, a local &quot;file&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">            filesystem is used.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">        partition_filter: Optional list of partition prefix filters</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">            (e.g. [&quot;date=2025-11-04&quot;]). Only files whose path relative to</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">            ``path`` starts with one of these prefixes are included.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        Dict with keys:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        - ``files``: list of ``{&quot;path&quot;, &quot;size_bytes&quot;, &quot;num_rows&quot;}`` dicts</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        - ``total_bytes``: sum of file sizes</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        - ``total_rows``: sum of row counts</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        FileNotFoundError: If the path does not exist or no parquet files</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">            match the optional partition filter.</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span> <span class="ow">or</span> <span class="n">fsspec_filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="c1"># Discover parquet files recursively via a manual stack walk so we can</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="c1"># respect partition_filter prefixes on the logical relative path.</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="n">entries</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="k">continue</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                    <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="k">if</span> <span class="n">partition_filter</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">normalized_filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">partition_filter</span><span class="p">]</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="n">filtered_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="n">rel</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">normalized_filters</span><span class="p">):</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="n">filtered_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">files</span> <span class="o">=</span> <span class="n">filtered_files</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="sa">f</span><span class="s2">&quot;No parquet files found under &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; matching filter&quot;</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">file_infos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="n">total_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">size_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                <span class="n">size_bytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">size_bytes</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">pf</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">ParquetFile</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="n">num_rows</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="c1"># As a fallback, attempt a minimal table read to estimate rows.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="n">table</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="n">num_rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">size_bytes</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">total_rows</span> <span class="o">+=</span> <span class="n">num_rows</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">file_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size_bytes</span><span class="p">,</span> <span class="s2">&quot;num_rows&quot;</span><span class="p">:</span> <span class="n">num_rows</span><span class="p">}</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">file_infos</span><span class="p">,</span> <span class="s2">&quot;total_bytes&quot;</span><span class="p">:</span> <span class="n">total_bytes</span><span class="p">,</span> <span class="s2">&quot;total_rows&quot;</span><span class="p">:</span> <span class="n">total_rows</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.core.maintenance.plan_compaction_groups" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.core.maintenance.plan_compaction_groups</span>


<a href="#fsspeckit.core.maintenance.plan_compaction_groups" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">plan_compaction_groups</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">file_infos</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]]</span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="            fsspeckit.core.maintenance.FileInfo


  
      dataclass
  " href="#fsspeckit.core.maintenance.FileInfo">FileInfo</a></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Plan compaction groups based on size and row thresholds.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_infos</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            fsspeckit.core.maintenance.FileInfo


  
      dataclass
  " href="#fsspeckit.core.maintenance.FileInfo">FileInfo</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of file information dictionaries or FileInfo objects.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target size in megabytes per output file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target number of rows per output file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>groups: List of CompactionGroup objects to be compacted</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>untouched_files: List of FileInfo objects not requiring compaction</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>planned_stats: MaintenanceStats object for the planned operation</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>planned_groups: List of file paths per group (for backward compatibility)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If both target_mb_per_file and target_rows_per_file are None or &lt;= 0.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/core/maintenance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="k">def</span><span class="w"> </span><span class="nf">plan_compaction_groups</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">file_infos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">],</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="sd">    Plan compaction groups based on size and row thresholds.</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        file_infos: List of file information dictionaries or FileInfo objects.</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        target_mb_per_file: Target size in megabytes per output file.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        target_rows_per_file: Target number of rows per output file.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        Dictionary with:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        - groups: List of CompactionGroup objects to be compacted</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">        - untouched_files: List of FileInfo objects not requiring compaction</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        - planned_stats: MaintenanceStats object for the planned operation</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">        - planned_groups: List of file paths per group (for backward compatibility)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        ValueError: If both target_mb_per_file and target_rows_per_file are None or &lt;= 0.</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="s2">&quot;Must provide at least one of target_mb_per_file or target_rows_per_file&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_mb_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_mb_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">if</span> <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_rows_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="c1"># Convert to FileInfo objects if needed</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">if</span> <span class="n">file_infos</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_infos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">FileInfo</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">fi</span><span class="p">[</span><span class="s2">&quot;size_bytes&quot;</span><span class="p">],</span> <span class="n">fi</span><span class="p">[</span><span class="s2">&quot;num_rows&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">file_infos</span><span class="p">]</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">files</span> <span class="o">=</span> <span class="n">file_infos</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="n">size_threshold_bytes</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="n">target_mb_per_file</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="c1"># Separate candidate files (eligible for compaction) from large files.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">large_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">size_bytes</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="k">if</span> <span class="n">size_threshold_bytes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="n">size_threshold_bytes</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">large_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="c1"># Build groups based on thresholds.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="n">groups</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="n">current_group</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="n">current_size</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">current_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flush_group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="k">nonlocal</span> <span class="n">current_group</span><span class="p">,</span> <span class="n">current_size</span><span class="p">,</span> <span class="n">current_rows</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="k">if</span> <span class="n">current_group</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">current_group</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="n">current_size</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">current_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">size_bytes</span><span class="p">):</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">size_bytes</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">would_exceed_size</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>            <span class="n">size_threshold_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="ow">and</span> <span class="n">current_size</span> <span class="o">+</span> <span class="n">size_bytes</span> <span class="o">&gt;</span> <span class="n">size_threshold_bytes</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="ow">and</span> <span class="n">current_group</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">would_exceed_rows</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="ow">and</span> <span class="n">current_rows</span> <span class="o">+</span> <span class="n">num_rows</span> <span class="o">&gt;</span> <span class="n">target_rows_per_file</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="ow">and</span> <span class="n">current_group</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="k">if</span> <span class="n">would_exceed_size</span> <span class="ow">or</span> <span class="n">would_exceed_rows</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="n">flush_group</span><span class="p">()</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">current_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="n">current_size</span> <span class="o">+=</span> <span class="n">size_bytes</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">current_rows</span> <span class="o">+=</span> <span class="n">num_rows</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="n">flush_group</span><span class="p">()</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="c1"># Only compact groups that contain more than one file; singleton groups</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="c1"># would just rewrite an existing file.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>    <span class="n">finalized_groups</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompactionGroup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">CompactionGroup</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>    <span class="p">]</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="c1"># Calculate statistics</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>    <span class="n">before_file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="n">before_total_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size_bytes</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="n">compacted_file_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="n">untouched_files</span> <span class="o">=</span> <span class="n">large_files</span> <span class="o">+</span> <span class="p">[</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">file_info</span> <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">candidates</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">file_info</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">files</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="p">]</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="n">after_file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">untouched_files</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="c1"># Estimate after_total_bytes (assume minimal compression change for planning)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="n">compacted_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="n">untouched_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size_bytes</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">untouched_files</span><span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="n">after_total_bytes</span> <span class="o">=</span> <span class="n">untouched_bytes</span> <span class="o">+</span> <span class="n">compacted_bytes</span>  <span class="c1"># Rough estimate</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="n">rewritten_bytes</span> <span class="o">=</span> <span class="n">compacted_bytes</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="c1"># Create compatibility structures</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="n">planned_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">file_paths</span><span class="p">()</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">]</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="n">after_file_count</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">after_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">compacted_file_count</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Will be set by backend</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="n">planned_groups</span><span class="o">=</span><span class="n">planned_groups</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">finalized_groups</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="s2">&quot;untouched_files&quot;</span><span class="p">:</span> <span class="n">untouched_files</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="s2">&quot;planned_stats&quot;</span><span class="p">:</span> <span class="n">planned_stats</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="s2">&quot;planned_groups&quot;</span><span class="p">:</span> <span class="n">planned_groups</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="fsspeckit.core.maintenance.plan_optimize_groups" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">fsspeckit.core.maintenance.plan_optimize_groups</span>


<a href="#fsspeckit.core.maintenance.plan_optimize_groups" class="headerlink" title="Permanent link">&para;</a></h4>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">plan_optimize_groups</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">file_infos</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]]</span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="            fsspeckit.core.maintenance.FileInfo


  
      dataclass
  " href="#fsspeckit.core.maintenance.FileInfo">FileInfo</a></span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">sample_schema</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="dict">dict</span></span><span class="p">[</span><span class="n"><span title="str">str</span></span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Plan optimization groups with z-order validation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_infos</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]] | <span title="list">list</span>[<a class="autorefs autorefs-internal" title="            fsspeckit.core.maintenance.FileInfo


  
      dataclass
  " href="#fsspeckit.core.maintenance.FileInfo">FileInfo</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of file information dictionaries or FileInfo objects.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>zorder_columns</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of columns to use for z-order clustering.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_mb_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target size in megabytes per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_rows_per_file</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target number of rows per output file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_schema</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyArrow schema or object with column_names method for validation.
          If None, schema validation will be skipped.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>groups: List of CompactionGroup objects to be optimized</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>untouched_files: List of FileInfo objects not requiring optimization</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>planned_stats: MaintenanceStats object for the planned operation</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>planned_groups: List of file paths per group (for backward compatibility)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If thresholds are invalid or zorder_columns is empty.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/fsspeckit/core/maintenance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="k">def</span><span class="w"> </span><span class="nf">plan_optimize_groups</span><span class="p">(</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">file_infos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">],</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="n">zorder_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">target_mb_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">target_rows_per_file</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="n">sample_schema</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">    Plan optimization groups with z-order validation.</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">        file_infos: List of file information dictionaries or FileInfo objects.</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">        zorder_columns: List of columns to use for z-order clustering.</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">        target_mb_per_file: Target size in megabytes per output file.</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">        target_rows_per_file: Target number of rows per output file.</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        sample_schema: PyArrow schema or object with column_names method for validation.</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">                      If None, schema validation will be skipped.</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        Dictionary with:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">        - groups: List of CompactionGroup objects to be optimized</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        - untouched_files: List of FileInfo objects not requiring optimization</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">        - planned_stats: MaintenanceStats object for the planned operation</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">        - planned_groups: List of file paths per group (for backward compatibility)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">        ValueError: If thresholds are invalid or zorder_columns is empty.</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">zorder_columns</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zorder_columns must be a non-empty list&quot;</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>    <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_mb_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_mb_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>    <span class="k">if</span> <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_rows_per_file</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_rows_per_file must be &gt; 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="c1"># Validate zorder columns against schema if provided</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="k">if</span> <span class="n">sample_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="n">available_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sample_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">zorder_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_cols</span><span class="p">]</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                    <span class="sa">f</span><span class="s2">&quot;Missing z-order columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                    <span class="sa">f</span><span class="s2">&quot;Available columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">available_cols</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                <span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="c1"># sample_schema doesn&#39;t have column_names, skip validation</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="k">pass</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="c1"># Convert to FileInfo objects if needed</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="k">if</span> <span class="n">file_infos</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_infos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">FileInfo</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="n">fi</span><span class="p">[</span><span class="s2">&quot;size_bytes&quot;</span><span class="p">],</span> <span class="n">fi</span><span class="p">[</span><span class="s2">&quot;num_rows&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">file_infos</span><span class="p">]</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">files</span> <span class="o">=</span> <span class="n">file_infos</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>    <span class="c1"># For optimization, we typically want to process all files unless they&#39;re</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="c1"># already large enough to be left alone</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="n">size_threshold_bytes</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="n">target_mb_per_file</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="k">if</span> <span class="n">target_mb_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>    <span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="c1"># Separate candidate files from large files</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="n">large_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">size_bytes</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="k">if</span> <span class="n">size_threshold_bytes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">size_bytes</span> <span class="o">&lt;</span> <span class="n">size_threshold_bytes</span><span class="p">:</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="n">large_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="c1"># Group files for optimization - similar to compaction but more aggressive</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="c1"># since optimization typically rewrites all eligible files</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="n">groups</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="n">current_group</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">FileInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>    <span class="n">current_size</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>    <span class="n">current_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">flush_group</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="k">nonlocal</span> <span class="n">current_group</span><span class="p">,</span> <span class="n">current_size</span><span class="p">,</span> <span class="n">current_rows</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="k">if</span> <span class="n">current_group</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="n">current_group</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="n">current_size</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="n">current_rows</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>    <span class="c1"># Sort files for more consistent optimization</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">size_bytes</span><span class="p">):</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="n">size_bytes</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">size_bytes</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">num_rows</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">num_rows</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">would_exceed_size</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="n">size_threshold_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="ow">and</span> <span class="n">current_size</span> <span class="o">+</span> <span class="n">size_bytes</span> <span class="o">&gt;</span> <span class="n">size_threshold_bytes</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>            <span class="ow">and</span> <span class="n">current_group</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>        <span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="n">would_exceed_rows</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>            <span class="n">target_rows_per_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="ow">and</span> <span class="n">current_rows</span> <span class="o">+</span> <span class="n">num_rows</span> <span class="o">&gt;</span> <span class="n">target_rows_per_file</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="ow">and</span> <span class="n">current_group</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="k">if</span> <span class="n">would_exceed_size</span> <span class="ow">or</span> <span class="n">would_exceed_rows</span><span class="p">:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="n">flush_group</span><span class="p">()</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="n">current_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="n">current_size</span> <span class="o">+=</span> <span class="n">size_bytes</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="n">current_rows</span> <span class="o">+=</span> <span class="n">num_rows</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="n">flush_group</span><span class="p">()</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="c1"># Include single-file groups for optimization (unlike compaction)</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="c1"># because optimization needs to reorder all eligible files</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="n">finalized_groups</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompactionGroup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Include single files too</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>            <span class="n">finalized_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CompactionGroup</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">group</span><span class="p">))</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>    <span class="c1"># Calculate statistics</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="n">before_file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>    <span class="n">before_total_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size_bytes</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="n">optimized_file_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="n">untouched_files</span> <span class="o">=</span> <span class="n">large_files</span>  <span class="c1"># Only large files are left untouched in optimization</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="n">after_file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">untouched_files</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>    <span class="c1"># Estimate after_total_bytes (optimization may improve compression)</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>    <span class="n">optimized_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">total_size_bytes</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">)</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>    <span class="n">untouched_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size_bytes</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">untouched_files</span><span class="p">)</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>    <span class="n">after_total_bytes</span> <span class="o">=</span> <span class="n">untouched_bytes</span> <span class="o">+</span> <span class="n">optimized_bytes</span>  <span class="c1"># Rough estimate</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>    <span class="n">rewritten_bytes</span> <span class="o">=</span> <span class="n">optimized_bytes</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>    <span class="c1"># Create compatibility structures</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>    <span class="n">planned_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">file_paths</span><span class="p">()</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">finalized_groups</span><span class="p">]</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>    <span class="n">planned_stats</span> <span class="o">=</span> <span class="n">MaintenanceStats</span><span class="p">(</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">before_file_count</span><span class="o">=</span><span class="n">before_file_count</span><span class="p">,</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>        <span class="n">after_file_count</span><span class="o">=</span><span class="n">after_file_count</span><span class="p">,</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="n">before_total_bytes</span><span class="o">=</span><span class="n">before_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="n">after_total_bytes</span><span class="o">=</span><span class="n">after_total_bytes</span><span class="p">,</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="n">compacted_file_count</span><span class="o">=</span><span class="n">optimized_file_count</span><span class="p">,</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="n">rewritten_bytes</span><span class="o">=</span><span class="n">rewritten_bytes</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>        <span class="n">compression_codec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Will be set by backend</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="n">zorder_columns</span><span class="o">=</span><span class="n">zorder_columns</span><span class="p">,</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">planned_groups</span><span class="o">=</span><span class="n">planned_groups</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="p">)</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">finalized_groups</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="s2">&quot;untouched_files&quot;</span><span class="p">:</span> <span class="n">untouched_files</span><span class="p">,</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>        <span class="s2">&quot;planned_stats&quot;</span><span class="p">:</span> <span class="n">planned_stats</span><span class="p">,</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>        <span class="s2">&quot;planned_groups&quot;</span><span class="p">:</span> <span class="n">planned_groups</span><span class="p">,</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "search.suggest", "search.highlight", "toc.integrate"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.4.0/dist/mermaid.min.js"></script>
      
        <script src="../../javascripts/mermaid.js"></script>
      
    
  </body>
</html>